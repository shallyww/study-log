<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>学习计划与打卡统计助手</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Heiti TC', 'Microsoft YaHei', sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 10px;
            max-width: 1000px;
            margin: 0 auto;
        }

        /* 顶部第一板块 */
        .header-top {
            background: linear-gradient(135deg, #2c5aa0, #4b6bbe);
            color: white;
            border-radius: 12px;
            padding: 20px 15px;
            text-align: center;
            margin-bottom: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .header-top h1 {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .header-top p {
            font-size: 12px;
        }

        /* 顶部第二板块 */
.header-stats {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    column-gap: 15px;
    margin-bottom: 20px;
white-space: nowrap;
}

.stat-card {
       display: flex;
    flex-direction: column;
 align-items: center;
    background: white;
    border-radius: 12px;
    padding: 8px 4px 1px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    min-width: 0; /* 防止内容溢出 */
    flex-shrink: 0; /* 防止卡片缩小 */
}

.stat-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.stat-label {
    font-size: 14px;
    font-weight: bold;
    color: #333;
    margin-bottom: 1px;
    order: 1;
}

.stat-value {
    font-size: 20px;
    font-weight: bold;
    color: #4b6bbe;
    order: 2;
    display: inline-block;
    margin-bottom: 0;
}

.stat-icon {
    font-size: 25px;
    color: #4b6bbe;
    order: 2; 
    display: inline-block;
    margin-left: 5px; 
    margin-top: 0;
}

        /* 中间部分 */
        .middle-section {
            display: flex;
            margin-bottom: 20px;
        }

        /* 计划模板竖排文字 */
        .template-label {
            writing-mode: vertical-lr;
            text-orientation: mixed;
            background: white;
            border-radius: 12px;
            padding: 15px 5px;
            font-size: 16px;
            font-weight: bold;
            color: #4b6bbe;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            height: fit-content;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* 右侧内容区域 */
        .content-area {
            flex: 1;
            background: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            width: 100%;
        }

        /* 学习计划头部 */
        .plan-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .plan-title {
            font-size: 20px;
            font-weight: bold;
            color: #333;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .plan-actions {
            display: flex;
            gap: 10px;
        }

        .btn-batch {
            background: #63c5e0;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 15px;
font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .btn-add {
            background: #4b6bbe;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 15px;
 font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* 周视图头部 */
        .week-header {
            background: #eff8ff;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .week-title {
            font-size: 18px;
            font-weight: bold;
            color: #4b6bbe;
        }

        .week-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .week-controls select {
            padding: 5px 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        .week-controls .btn {
            background: #4b6bbe;
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* 自定义时间选择器 */
        .custom-time-selector {
            display: flex;
            align-items: center;
            background: #fd9400;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 15px;
            font-weight: bold;
            gap: 8px;
            cursor: pointer;
        }

        .custom-time-selector i {
            font-size: 13px;
        }

        /* 日历按钮 */
        .calendar-btn {
            background: #4b6bbe;
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* 周视图日历 */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .calendar-day {
            height: 60px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            background: #d4e3f8;
            cursor: pointer;
            font-size: 14px;
            padding: 5px;
            transition: all 0.2s ease;
        }

        .calendar-day:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .calendar-day.today {
            background: #fd9400;
            color: white;
        }

        .calendar-day.selected {
            background: #4b6bbe;
            color: white;
        }

        .calendar-day.checked {
            background: #8bb3f2;
            color: white;
        }

        .weekday {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 0;
        }

        .date {
            font-size: 16px;
            font-weight: bold;
        }

        /* 计划项列表 */
        .plan-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .plan-item {
            display: flex;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
        }

        /* 科目区域 - 宽度调整为30px，字体加粗 */
        .plan-subject {
            width: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            font-weight: bold;
            writing-mode: vertical-lr;
            text-orientation: mixed;
            padding: 15px 0;
        }

        .plan-subject.english {
            background: linear-gradient(to bottom, #c690ce, #a56cb5);
        }

        .plan-subject.chinese {
            background: linear-gradient(to bottom, #99ddae, #7bc593);
        }

        .plan-subject.math {
            background: linear-gradient(to bottom, #f79d82, #e88568);
        }

        .plan-subject.sports {
            background: linear-gradient(to bottom, #6ac9e0, #4bb3d3);
        }

        .plan-subject.relax {
            background: linear-gradient(to bottom, #ff5252, #d32f2f);
        }

        .plan-subject.skill {
            background: linear-gradient(to bottom, #debbb3, #c9a199);
        }

        .plan-subject.daily {
            background: linear-gradient(to bottom, #D5E3B7, #C0D495);
        }

        .plan-subject.other {
            background: linear-gradient(to bottom, #5f7ebe, #4b6bbe);
        }

        /* 计划内容区域 - 调整内边距 */
        .plan-content {
            flex: 1;
            padding: 6px 6px 1px; 
            background: #e0f8e8;
            margin-right: 0;
            border-right: 1px solid #d1d9e6;
            position: relative;
            height: 120px;
        }

        .plan-item.running .plan-content {
            background: white;
        }

        .plan-item.completed .plan-content {
            background: #e0f8e8;
        }

        /* 优化计划头部布局 - 确保在一行显示 */
        .plan-header-row {
            display: flex;
            align-items: center;
            gap: 20px; 
            margin-bottom: 1px;
            flex-wrap: nowrap;
            overflow-x: auto;
            padding-bottom: 3px;
        }

        .plan-name {
            font-size: 18px;
            font-weight: bold;
            color: #28a745;
            font-family: "黑体", sans-serif;
            border: none;
            background: transparent;
            outline: none;
            min-width: 70px;
            display: flex;
            align-items: center;
            gap: 5px;
            white-space: nowrap;
        }

        .plan-repeat {
            font-size: 15px;
            color: #4b6bbe;
            font-family: "黑体", sans-serif;
            font-weight: bold;
            white-space: nowrap;
        }

        .plan-time {
            font-size: 15px;
            color: #c690ce;
            font-family: "黑体", sans-serif;
            font-weight: bold;
            white-space: nowrap;
        }

        .plan-actual-time {
            font-size: 15px;
            color: #ff0000;
            font-family: "黑体", sans-serif;
            font-weight: bold;
            white-space: nowrap;
        }

        /* 计划用时输入框样式 */
        .planned-duration {
            font-size: 15px;
            color: #c690ce;
            font-family: "黑体", sans-serif;
            font-weight: bold;
            white-space: nowrap;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 2px 4px;
            background: white;
            width: 66px;
        }

        /* 计划用时标签样式 */
        .duration-label {
            font-size: 15px;
            color: #c690ce;
            font-family: "黑体", sans-serif;
            font-weight: bold;
            white-space: nowrap;
            width: 60px;
        }

        /* 内容文本框背景色 - 调整内边距 */
     .plan-content .plan-desc {
            font-size: 15px;
            color: #333;
            margin-bottom: 0.5px;
            font-family: "黑体", sans-serif;
            border: 1px solid #ddd;
            padding: 3px 6px; 
            border-radius: 4px;
            height: 30px;
            resize: none;
            width: 100%;
            background: #f9f9f9;
        }

        /* 详情页跳转区域 */
        .detail-jump-area {
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #4b6bbe;
            font-size: 12px;
            transition: all 0.2s ease;
            margin-bottom: 0.5px; 
            font-size: 0;
        }

        .detail-jump-area i {
            font-size: 0;
        }

        .detail-jump-area span {
            font-size: 0;
        }

        .detail-jump-area:hover {
            background: #f0f4f8;
            border-radius: 4px;
        }

        /* 计时/完成状态区域 */
        .plan-status {
            width: 150px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 12px 8px;
            background: #f0f4f8;
        }

        .timer-display {
            width: 100%;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            margin-bottom: 8px;
            font-size: 22px;
            font-weight: bold;
            background: white;
            border: 1px solid #dee2e6;
            font-family: 'Courier New', Courier, monospace;
            letter-spacing: 0.8px;
            padding: 0 5px;
        }

        .timer-display.timing {
            color: #e1443b;
            font-size: 22px;
            font-family: 'Courier New', Courier, monospace;
            letter-spacing: 0.8px;
        }

        .timer-display.completed {
            color: #28a745;
            font-family: 'Courier New', Courier, monospace;
            letter-spacing: 0.8px;
        }

    .timer-display.canceled {
        color: #dc3545;
        font-size: 22px;
        font-family: 'Courier New', Courier, monospace;
        letter-spacing: 0.8px;
    }

        .timer-controls {
            display: flex;
            gap: 10px;
            width: 100%;
            justify-content: center;
        }

        .timer-btn {
            width: 35px;
            height: 35px;
            border-radius: 4px;
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .timer-btn.start {
            background: #26b563;
        }

        .timer-btn.pause {
            background: #f8d287;
        }

        .timer-btn.stop {
            background: #e1443b;
        }

        .timer-btn.cancel {
            background: #764A94;
        }

        .completed-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            background: #28a745;
            color: white;
            border-radius: 4px;
            padding: 5px;
            font-size: 12px;
            font-weight: bold;
            gap: 5px;
            width: 70%;
            min-width: 70px;
        }

        .completed-circle {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: white;
            color: #28a745;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
        }

        .canceled-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            background: #dc3545;
            color: white;
            border-radius: 4px;
            padding: 5px;
            font-size: 12px;
            font-weight: bold;
            gap: 5px;
            width: 70%;
            min-width: 70px;
        }

        .canceled-circle {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: white;
            color: #dc3545;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
        }

        /* 底部区域 */
        .data-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }

        .data-actions .btn {
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .data-actions .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        #backup-btn {
            background: #28a745;
        }

        #import-btn {
            background: #6f42c1;
        }

        #clear-btn {
            background: #dc3545;
        }

        .footer {
            text-align: center;
            margin-top: 25px;
            font-size: 12px;
            color: #999;
        }

        /* 模态框样式 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #666;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            color: #333;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        /* 时间选择器样式 */
        .time-range-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .time-picker {
            display: flex;
            align-items: center;
            background: #fd9400;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 13px;
            gap: 8px;
            cursor: pointer;
            flex: 1;
            justify-content: center;
        }

        .time-picker i {
            font-size: 13px;
        }

        .time-range-display {
            display: flex;
            align-items: center;
            background: #f0f8ff;
            border: 1px solid #cce5ff;
            border-radius: 6px;
            padding: 10px;
            flex: 1;
            justify-content: center;
            font-weight: bold;
            color: #4b6bbe;
        }

        .time-range-display span {
            margin: 0 5px;
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .form-actions .btn {
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-cancel {
            background: #f0f0f0;
            color: #333;
            border: 1px solid #ddd;
        }

        .btn-save {
            background: #4b6bbe;
            color: white;
            border: none;
        }

        /* 批量添加模态框 */
        .batch-input {
            width: 100%;
            height: 200px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            resize: vertical;
        }

        /* 数据管理模态框 */
        .data-import {
            width: 100%;
            height: 100px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            resize: vertical;
        }

        .backup-info {
            background: #f0f8ff;
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
            font-size: 14px;
            color: #4b6bbe;
        }

        /* 详情页面模态框样式 */
        .detail-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: white;
            z-index: 2000;
            overflow-y: auto;
            padding: 15px;
        }
        
        .detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .back-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            color: white;
            background: none;
            border: none;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 6px;
            background-color: #496db9;
            width: 80px;
            justify-content: center;
        }
        
        .detail-actions {
            display: flex;
            gap: 15px;
        }
        
        .detail-action-btn {
            background: none;
            border: none;
            color: #496db9;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 8px 0;
            transition: color 0.2s;
        }
        
        .detail-action-btn:hover {
            color: #2c5aa0;
        }
        
        .plan-title-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 25px;
            text-align: center;
            position: relative;
        }
        
        /* 修改详情页计划名称和重复频率布局 */
        .plan-name-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 15px;
            position: relative;
        }
        
        .plan-name-large {
            font-size: 50px;
            color: #496db9;
            font-weight: bold;
            text-align: center;
            line-height: 1.2;
            display: flex;
            align-items: center;
            gap: 10px;
            font-family: 'Courier New', Courier, monospace;
            font-weight: bold; 
            letter-spacing: 1px; 
            position: relative;
            padding-bottom: 10px;
        }
        
        .repeat-badge {
            background-color: #cfedf3;
            color: #496db9;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            text-align: center;
            position: absolute;
            right: -20px;
            bottom: 0;
            transform: translateX(100%);
            white-space: nowrap;
            font-family: 'Courier New', Courier, monospace; 
            font-weight: bold; 
            letter-spacing: 0.5px; 
        }
        
        .timer-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 25px;
            padding: 20px;
            background-color: #f5f7fa;
            border-radius: 12px;
        }
        
        /* 修改详情页计时器字体为等宽字体，加粗 */
        .detail-timer-display {
            font-size: 120px;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
            background: none;
            border: none;
            box-shadow: none;
            padding: 0;
            width: auto;
            font-family: 'Courier New', monospace;
            font-weight: 900;
            letter-spacing: 1px;
            height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .detail-timer-display.timing {
            color: #e1443b;
        }
        
        .detail-timer-display.completed {
            color: #28a745;
        }

    .detail-timer-display.canceled {
        color: #dc3545;
    }
        
        .detail-timer-controls {
            display: flex;
            gap: 25px;
        }
        
        /* 详情页计时器按钮样式调整 */
        .detail-timer-btn {
            display: flex;
            align-items: center;
            gap: 8px; 
            color: white;
            border: none;
            padding: 8px 16px; 
            border-radius: 6px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            transition: all 0.2s ease;
        }

        .detail-timer-btn i {
            font-size: 18px; 
            color: white; 
            vertical-align: middle; 
        }

        .detail-timer-btn:hover {
            transform: scale(1.05); 
        }

        .detail-timer-btn.start {
            background-color: #26b563;
        }

        .detail-timer-btn.pause {
            background-color: #f8d287;
        }

        .detail-timer-btn.stop {
            background-color: #e1443b;
        }
        
         .detail-timer-btn.cancel {
            background: #764A94;
        }

        .info-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .info-card {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .info-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 18px;
            color: #496db9;
            font-weight: bold;
        }

        .info-title i {
            font-size: 18px;
        }
        
        .info-content {
            font-size: 16px;
            color: #333;
        }
        
        .description-section {
            margin-bottom: 25px;
        }
        
        .description-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }
        
        .description-content {
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            min-height: 100px;
            font-family: "黑体", sans-serif;
            font-size: 16px;
            resize: vertical;
            width: 100%;
        }

        /* 全年日历模态框样式 */
        .year-calendar {
            max-width: 600px;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .calendar-nav {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .calendar-nav-btn {
            background: #4b6bbe;
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .calendar-month-year {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }

        .calendar-grid-year {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }

        .calendar-weekday {
            text-align: center;
            font-weight: bold;
            padding: 10px 0;
            color: #4b6bbe;
        }

        .calendar-day-year {
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .calendar-day-year:hover {
            background: #e6f0ff;
        }

        .calendar-day-year.today {
            background: #fd9400;
            color: white;
        }

        .calendar-day-year.selected {
            background: #4b6bbe;
            color: white;
        }

        .calendar-day-year.other-month {
            color: #ccc;
        }

         /* 新增样式：禁用状态 */
                .timer-btn.disabled {
                    background: #ccc !important;
                    cursor: not-allowed;
                }
        
                .plan-item.disabled .timer-btn {
                    background: #ccc !important;
                    cursor: not-allowed;
                }

         /* 统计图表详情页样式 */
         .stats-detail-modal {
             display: none;
             position: fixed;
             top: 0;
             left: 0;
             width: 100%;
             height: 100%;
             background-color: white;
             z-index: 2000;
             overflow-y: auto;
            padding: 20px;
padding-top: 0;
         }

         .stats-header {
             display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 25px;
              padding-bottom: 15px;
              border-bottom: 2px solid #f0f4f8;
              position: sticky;
              top: 0;
              background-color: white;
              z-index: 100;
              padding: 15px 20px;
              margin-bottom: 15px;
              box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
          }

        .stats-title {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 22px;
            color: #333;
            font-weight: bold;
        }

        .stats-title i {
            font-size: 22px;
            color: #4b6bbe;
        }

        .date-filter-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 35px;
            padding: 12px;
            background-color: #f9f9f9;
            border-radius: 12px;
            flex-wrap: wrap;
 max-width: 75%;
margin-top: 20px; 
    margin-left: auto;
    margin-right: auto;
        }

        .date-filter-label {
            font-size: 16px;
            font-weight: bold;
            color: #333;
        }

        .date-input {
            display: flex;
            align-items: center;
            gap: 8px;
            padding:8px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            background: white;
            min-width: 120px;
            justify-content: center;
            cursor: pointer;
        }

        .date-input i {
            font-size: 14px;
            color: #4b6bbe;
        }

     .filter-btn {
            background-color: #496db9;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
justify-content: center; 
            gap: 8px;
            transition: background-color 0.3s ease;
            min-width: 60px; 
            max-width: 80px; 
            width: auto;
 height: 35px;
        }

        .filter-btn:hover {
            background-color: #3a5a9e;
        }

        /* 图表容器样式 - 增大尺寸 */
.chart-container {
    width: 100%;
    height: 400px; /* 增大高度 */
    margin-bottom: 30px;
    background-color: white;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    padding: 10px 20px;
    position: relative;
display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
}

.chart-container > div {
    width: 100% !important;
    height: 100% !important;
    display: flex !important;
    justify-content: center !important;
    align-items: center !important;
}

.chart-title {
    font-size: 20px;
    font-weight: bold;
    margin-bottom: 15px;
    color: #333;
    text-align: center;
    padding-bottom: 15px;
    border-bottom: 1px solid #eee;
    width: 100%;
}

/* 响应式布局 */
@media (max-width: 1200px) {
    .stats-title {
        font-size: 24px;
    }
    
    .date-filter-container {
        gap: 15px;
    }
    
    .date-input {
        padding: 8px;
        font-size: 14px;
        min-width: 110px;
    }

    .filter-btn {
        padding: 15x;
        font-size: 14px;
    }
 }

@media (max-width: 768px) {
    .stats-detail-modal {
        padding: 15px;
    }
    
    .stats-header {
        flex-direction: column;
        gap: 15px;
        align-items: flex-start;
    }
    
    .stats-title {
        font-size: 22px;
    }
    
    .date-filter-container {
        flex-direction: column;
        align-items: stretch;
        gap: 15px;
    }
    
    .date-filter-label {
        text-align: center;
    }
    
    .date-input {
        justify-content: center;
    }
    
    .chart-container {
        height: 350px;
        padding: 15px;
        margin-bottom: 30px;
    }
    
    .chart-title {
        font-size: 18px;
    }

    .filter-btn {
        padding: 10px; 
        height: 32px;
        min-width: 65px;
        max-width: 80px;
        font-size: 14px;
    }
}

@media (max-width: 480px) {
    .stats-detail-modal {
        padding: 10px;
    }
    
    .stats-title {
        font-size: 20px;
        gap: 10px;
    }
    
    .stats-title i {
        font-size: 20px;
    }
    
    .date-filter-container {
        padding: 15px;
    }
    
    .chart-container {
        height: 300px;
        padding: 12px;
        margin-bottom: 25px;
    }
    
    .chart-title {
        font-size: 16px;
    }
}

        /* 确保ECharts图表自适应容器 */
        .echarts {
            width: 100% !important;
            height: 100% !important;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* 修改图表容器内的canvas样式 */
        .chart-container canvas {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 0 auto;
        }

        /* 关闭按钮样式优化 */
        .stats-close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            padding: 5px;
            border-radius: 4px;
            transition: background-color 0.3s ease;
        }

        .stats-close-btn:hover {
            background-color: #f0f0f0;
        }

 /* 计划用时与实际用时对比图表的日期筛选区域 - 强制减小高度 */
.plan-actual-date-filter {
    display: flex !important;
    justify-content: center !important;
    align-items: center !important;
    gap: 20px !important; 
    margin-bottom: 15px !important; 
    padding: 10px !important; 
    background-color: #f9f9f9 !important;
    border-radius: 12px !important; 
    flex-wrap: wrap !important;
    height: 60px !important; 
    max-width: 50% !important;
    margin-left: auto !important;
    margin-right: auto !important;
    position: relative !important;
    z-index: 10 !important;
}

.plan-actual-date-label {
    font-size: 16px !important; /* 减小字体大小 */
    font-weight: bold !important;
    color: #333 !important;
    line-height: 1 !important;
    margin: 0 !important;
    padding: 0 !important;
}

.plan-actual-date-input {
    display: flex !important;
    align-items: center !important;
    gap: 8px !important; /* 减小间隙 */
    padding: 15px !important; /* 减小内边距 */
    border: 1px solid #ddd !important;
    border-radius: 8px !important; /* 减小圆角 */
    font-size: 14px !important; /* 减小字体大小 */
    font-weight: bold !important;
    background: white !important;
    min-width: 100px !important; /* 可适当减小最小宽度 */
    justify-content: center !important;
    cursor: pointer !important;
    height: 30px !important; /* 减小高度 */
    line-height: 1 !important;
    margin: 0 !important;
}

.plan-actual-date-input i {
    font-size: 14px !important; /* 减小图标大小 */
    color: #4b6bbe !important;
}

.plan-actual-filter-btn {
    background-color: #496db9 !important;
    color: white !important;
    border: none !important;
    padding:15px !important;
    border-radius: 8px !important; /* 从8px减小到4px */
    font-size: 14px !important; 
    font-weight: bold !important;
    cursor: pointer !important;
    display: flex !important;
    align-items: center !important;
    gap: 8px !important; 
    transition: background-color 0.3s ease !important;
    height: 30px !important; 
    line-height: 1 !important;
    margin: 0 !important;
}

.plan-actual-filter-btn:hover {
    background-color: #3a5a9e !important;
}

        /* 全年日历模态框样式 - 用于计划用时筛选 */
        .plan-actual-calendar-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 3000;
            justify-content: center;
            align-items: center;
        }
        
        .plan-actual-calendar-content {
            background-color: white;
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }

/* 统计图表日期筛选日历样式 */
        .stats-date-calendar-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 3000;
            justify-content: center;
            align-items: center;
        }
        
        .stats-date-calendar-content {
            background-color: white;
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        
        .stats-date-calendar-modal .calendar-nav-btn {
            background: #4b6bbe;
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .stats-date-calendar-modal .calendar-month-year {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }
        
        .stats-date-calendar-modal .calendar-grid-year {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }
        
        .stats-date-calendar-modal .calendar-weekday {
            text-align: center;
            font-weight: bold;
            padding: 10px 0;
            color: #4b6bbe;
        }
        
        .stats-date-calendar-modal .calendar-day-year {
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }
        
        .stats-date-calendar-modal .calendar-day-year:hover {
            background: #e6f0ff;
        }
        
        .stats-date-calendar-modal .calendar-day-year.today {
            background: #fd9400;
            color: white;
        }
        
        .stats-date-calendar-modal .calendar-day-year.selected {
            background: #4b6bbe;
            color: white;
        }
        
        .stats-date-calendar-modal .calendar-day-year.other-month {
            color: #ccc;
        }

/* 荣誉勋章墙模态框样式 */
        .honor-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: white;
            z-index: 2000;
            overflow-y: auto;
            padding: 20px;
            padding-top: 0;
        }

        .honor-header {
            display: flex;
             justify-content: space-between;
             align-items: center;
             margin-bottom: 25px;
             padding-bottom: 15px;
             border-bottom: 2px solid #f0f4f8;
              position: sticky;
               top: 0;
               background-color: white;
               z-index: 100;
               padding: 15px 20px;
               margin-bottom: 15px;
               box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .honor-title {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 22px;
            color: #333;
            font-weight: bold;
        }
        
        .honor-title i {
            font-size: 22px;
            color: #4b6bbe;
        }
        
        .honor-actions {
            display: flex;
            gap: 15px;
        }
        
        .honor-action-btn {
            background: none;
            border: none;
            color: #496db9;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 8px 15px;
            border-radius: 6px;
            transition: all 0.2s ease;
           }
        
        .honor-action-btn:hover {
            background-color: #496db9;
            color: white;
        }

/* 新增：主要操作按钮容器 */
.honor-main-actions {
    display: flex;
   justify-content: flex-start;
align-items: center; 
    gap: 15px;
    margin-bottom: 15px;
margin-top: 20px; 
}

/* 新增：主要操作按钮样式 */
.honor-main-btn {
    background: #4b6bbe;
    color: white;
    border: none;
    padding: 8px ;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    font-weight: bold;
    display: flex;
    align-items: center;
    gap: 5px;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
}

.honor-main-btn:hover {
    background: #3a5a9e;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

#clear-honor-btn {
    background: #dc3545;
    color: white;
}

.honor-main-btn i {
    font-size: 14px;
}
      
/* 单独设置添加兑换清单按钮 */
#add-wish-btn {
    background: #4b6bbe; 
    font-size: 14px;  
color: white;
   font-weight: bold;
padding: 8px;
border: none;
}

#add-wish-btn:hover {
    background:  #4b6bbe; 
}

/* 单独设置清空兑换清单按钮 */
#clear-wish-btn {
    background: #dc3545; 
    font-size: 14px;   
 color: white;
font-weight: bold;
padding: 8px;
border: none;
}

#clear-wish-btn:hover {
    background: #dc3545; /* 悬停时深红色 */
}

         .honor-section {
            margin-bottom: 30px;
        }
        
        .honor-section-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .honor-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
        }
        
      .honor-card {
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    border-radius: 16px;
    padding: 25px 20px;
    text-align: center;
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    position: relative;
    overflow: hidden;
    border: 1px solid rgba(255, 255, 255, 0.2);
}

        .honor-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #ff6b6b, #ffd93d, #6bcf7f, #4d96ff);
    background-size: 200% 100%;
    animation: shimmer 3s infinite linear;
}

@keyframes shimmer {
    0% { background-position: -200% 0; }
    100% { background-position: 200% 0; }
}

.honor-card.locked {
    background: linear-gradient(135deg, #f1f3f4 0%, #e8eaed 100%);
    filter: grayscale(0.8);
    opacity: 0.7;
}
        
.honor-card:hover {
    transform: translateY(-8px) scale(1.02);
    box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15);
}
        
.honor-card.locked:hover {
    transform: translateY(-5px) scale(1.01);
    filter: grayscale(0.6);
    opacity: 0.9;
}

.honor-icon {
    font-size: 48px;
    margin-bottom: 20px;
    position: relative;
    display: inline-block;
    transition: all 0.3s ease;
}

.honor-card:hover .honor-icon {
    transform: scale(1.1) rotate(5deg);
}

.honor-card.locked:hover .honor-icon {
    transform: scale(1.05);
}
        
.honor-name {
    font-size: 18px;
    font-weight: bold;
    margin-bottom: 12px;
    color: #2c3e50;
    position: relative;
    padding-bottom: 8px;
}

.honor-name::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 25%;
    width: 50%;
    height: 2px;
    background: linear-gradient(90deg, transparent, #4b6bbe, transparent);
}
        
.honor-description {
    font-size: 14px;
    color: #666;
    margin-bottom: 15px;
    line-height: 1.5;
    min-height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
}
        
     .honor-progress {
    font-size: 12px;
    color: #4b6bbe;
    font-weight: bold;
    padding: 6px 12px;
    background: rgba(75, 107, 190, 0.1);
    border-radius: 20px;
    display: inline-block;
}

.honor-badge {
    position: absolute;
    top: 15px;
    right: 15px;
    background: linear-gradient(135deg, #4b6bbe, #6b8cff);
    color: white;
    border-radius: 50%;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    box-shadow: 0 3px 10px rgba(75, 107, 190, 0.3);
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}

      /* 许愿星兑换板块样式 */
        .wish-section {
            background-color: #f0f8ff;
            border-radius: 12px;
            padding: 20px;
            margin-top: 30px;
        }
        
        .wish-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .wish-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }
        
        .wish-stars {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 18px;
            font-weight: bold;
            color: #fd9400;
        }
        
        .wish-stars i {
            font-size: 20px;
        }
        
        .wish-categories {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .wish-category-btn {
            background: white;
            border: 1px solid #ddd;
            border-radius: 20px;
            padding: 8px 15px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }
        
        .wish-category-btn.active {
            background-color: #4b6bbe;
            color: white;
            border-color: #4b6bbe;
        }
        
/* 新增：兑换清单操作按钮容器 */
.wish-actions {
    display: flex;
    justify-content: flex-start;
    gap: 15px;
    margin-bottom: 15px;
}

        .wish-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }
        
.wish-item {
    background: linear-gradient(135deg, #ffffff 0%, #f8f9ff 100%);
    border-radius: 16px;
    padding: 25px 20px;
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    position: relative;
    overflow: hidden;
    border: 1px solid rgba(255, 255, 255, 0.2);
}
        
.wish-item::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #ff9a9e, #fad0c4, #fad0c4, #ff9a9e);
    background-size: 200% 100%;
    animation: shimmer 3s infinite linear;
}
      
.wish-item.disabled {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    filter: grayscale(0.8);
    opacity: 0.6;
}
        
.wish-item:hover {
    transform: translateY(-8px) scale(1.02);
    box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15);
}

.wish-item.disabled:hover {
    transform: translateY(-5px) scale(1.01);
    filter: grayscale(0.6);
    opacity: 0.8;
}

.wish-item-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.wish-item-header-left {
    display: flex;
    align-items: center;
    gap: 8px;
}
        
.wish-item-category {
    font-size: 12px;
    color: #fff;
    padding: 4px 12px;
    border-radius: 12px;
    font-weight: bold;
    text-transform: uppercase;
    letter-spacing: 0.5px;
white-space: nowrap;
}
        
.wish-item[data-category="entertainment"] .wish-item-category {
    background: linear-gradient(135deg, #ff6b6b, #ff8e8e);
}

.wish-item[data-category="food"] .wish-item-category {
    background: linear-gradient(135deg, #ffa726, #ffb74d);
}

.wish-item[data-category="shopping"] .wish-item-category {
    background: linear-gradient(135deg, #4b6bbe, #6b8cff);
}

.wish-item[data-category="experience"] .wish-item-category {
    background: linear-gradient(135deg, #66bb6a, #81c784);
}

.wish-item-status {
    font-size: 11px;
    color: #28a745;
    background: rgba(40, 167, 69, 0.1);
    padding: 3px 8px;
    border-radius: 10px;
    font-weight: bold;
white-space: nowrap;
}

.wish-item-name {
    font-size: 18px;
    font-weight: bold;
    margin-bottom: 12px;
    color: #2c3e50;
    position: relative;
    padding-bottom: 8px;
}
      
.wish-item-name::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    width: 40px;
    height: 2px;
    background: linear-gradient(90deg, #ffd93d, transparent);
}
  
.wish-item-description {
    font-size: 14px;
    color: #666;
    margin-bottom: 20px;
    line-height: 1.5;
}
        
.wish-item-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

        .wish-item-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
.wish-item-cost {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 18px;
    font-weight: bold;
    color: #fd9400;
    padding: 6px 12px;
    background: rgba(253, 148, 0, 0.1);
    border-radius: 20px;
}
        
.wish-item-cost i {
    font-size: 20px;
    animation: sparkle 2s infinite;
}

        @keyframes sparkle {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.2); }
}

        .wish-item-btn {
    background: linear-gradient(135deg, #4b6bbe, #6b8cff);
    color: white;
    border: none;
    border-radius: 25px;
    padding: 10px 20px;
    cursor: pointer;
    font-size: 14px;
    font-weight: bold;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(75, 107, 190, 0.3);
    position: relative;
    overflow: hidden;
}
        
.wish-item-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
    transition: left 0.5s;
}

.wish-item-btn:hover::before {
    left: 100%;
}

.wish-item-btn:hover:not(:disabled) {
    background: linear-gradient(135deg, #3a5a9e, #5a7ae8);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(75, 107, 190, 0.4);
}
        
.wish-item-btn:disabled {
    background: linear-gradient(135deg, #bdc3c7, #95a5a6);
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}

/* 为兑换清单添加悬停效果 */
.wish-item:hover .wish-item-cost {
    transform: scale(1.05);
    transition: transform 0.3s ease;
}
       
/* 响应式调整 */
@media (max-width: 768px) {
    .honor-card, .wish-item {
        padding: 20px 15px;
    }
    
    .honor-icon {
        font-size: 40px;
    }
    
    .wish-item-name {
        font-size: 16px;
    }
}

        /* 添加勋章模态框样式 */
        .add-honor-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 3000;
            justify-content: center;
            align-items: center;
        }
        
        .add-honor-content {
            background-color: white;
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        
        /* 添加兑换清单模态框样式 */
        .add-wish-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 3000;
            justify-content: center;
            align-items: center;
        }
        
        .add-wish-content {
            background-color: white;
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }

/* 勋章卡片操作按钮 */
        .honor-actions {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 10px;
        }
        
        .honor-action-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
font-weight: bold;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        
        .honor-delete-btn {
            color: #dc3545;
            background: rgba(220, 53, 69, 0.1);
        }
        
        .honor-delete-btn:hover {
            background: rgba(220, 53, 69, 0.2);
        }
        
        /* 兑换卡片操作按钮 */
        .wish-item-actions {
            display: flex;
justify-content: space-between;
            align-items: center;
            margin-top: 10px;
        }
        
        .wish-edit-btn {
            background: #C1C4E5;
            color: white;
            border: none;
            border-radius: 10px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 14px;
font-weight: bold;
            transition: all 0.3s ease;
display: flex;
    align-items: center;
    gap: 4px;
    white-space: nowrap;
    margin-left: auto;
        }
        
        .wish-edit-btn:hover {
            background: #7D82C9;
        }
        
        /* 编辑兑换清单模态框样式 */
        .edit-wish-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 3000;
            justify-content: center;
            align-items: center;
        }
        
        .edit-wish-content {
            background-color: white;
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }

/* 勋章解锁弹窗样式 */
.honor-unlock-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.8);
    z-index: 4000;
    justify-content: center;
    align-items: center;
}

.honor-unlock-content {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 20px;
    padding: 40px 30px;
    text-align: center;
    color: white;
    max-width: 400px;
    width: 90%;
    box-shadow: 0 20px 40px rgba(0,0,0,0.3);
    animation: popIn 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

@keyframes popIn {
    0% { transform: scale(0.5); opacity: 0; }
    100% { transform: scale(1); opacity: 1; }
}

.honor-unlock-icon {
    font-size: 80px;
    margin-bottom: 20px;
    animation: bounce 1s infinite alternate;
}

@keyframes bounce {
    0% { transform: translateY(0) scale(1); }
    100% { transform: translateY(-10px) scale(1.05); }
}

.honor-unlock-title {
    font-size: 28px;
    font-weight: bold;
    margin-bottom: 15px;
    text-shadow: 0 2px 4px rgba(0,0,0,0.3);
}

.honor-unlock-description {
    font-size: 16px;
    margin-bottom: 25px;
    line-height: 1.5;
}

.honor-unlock-stars {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    margin-bottom: 30px;
    font-size: 20px;
    font-weight: bold;
}

.honor-unlock-stars i {
    color: #FFD700;
    animation: sparkle 1.5s infinite;
}

@keyframes sparkle {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.2) rotate(10deg); }
}

.honor-unlock-btn {
    background: linear-gradient(135deg, #FFD700, #FFA500);
    color: #333;
    border: none;
    border-radius: 25px;
    padding: 12px 30px;
    font-size: 18px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
}

.honor-unlock-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(255, 215, 0, 0.6);
}

/* 在现有CSS中添加排序按钮样式 */
.sort-btn {
    background: none;
    border: none;
    color: #333;
    cursor: pointer;
    font-size: 16px;
    padding: 5px 8px;
    border-radius: 4px;
    transition: all 0.2s ease;
    margin-left: 10px; 
}

.sort-btn:hover {
    background: #f0f0f0;
    transform: scale(1.1);
}

.sort-btn:active {
    transform: scale(0.95);
}

.sort-btn.active {
    color: #4b6bbe;
}

/* 重要任务按钮样式 */
.btn-important {
    background: #EE828C !important;
    color: white;
    border: none;
    padding: 8px 15px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 15px;
    font-weight: bold;
    display: flex;
    align-items: center;
    gap: 5px;
}

.btn-important:hover {
    background: #e06c77 !important;
}

/* 重要任务批量添加样式 */
#new-important-task {
    width: 100%;
    height: 60px;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 14px;
    resize: vertical;
    font-family: inherit;
}

#new-important-task:focus {
    border-color: #4b6bbe;
    outline: none;
    box-shadow: 0 0 0 2px rgba(75, 107, 190, 0.2);
}

/* 按钮样式 */
.btn-save {
    background: #4b6bbe;
font-weight: bold;
    color: white;
    border: none;
    padding: 8px 15px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 5px;
}

.btn-save:hover {
    background: #3a5a9e;
}

/* 重要任务列表样式改进 */
.important-tasks-list {
    max-height: 300px;
    overflow-y: auto;
    margin-top: 10px;
    border-top: 1px solid #eee;
    padding-top: 10px;
}

.important-task-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 10px;
    border-bottom: 1px solid #f0f0f0;
    transition: background-color 0.2s;
gap: 10px;
}

.important-task-item:hover {
    background-color: #f9f9f9;
}

.important-task-content {
    flex: 1;
    font-size: 16px;
color: #55ae6c;
font-weight: bold;
    line-height: 1;
    padding: 8px 12px;
    border: 1px solid transparent;
    border-radius: 4px;
    background: transparent;
    transition: all 0.2s ease;
    min-height: 20px;
}

.important-task-content:focus {
    border-color: #4b6bbe;
    background: white;
    outline: none;
    box-shadow: 0 0 0 2px rgba(75, 107, 190, 0.1);
}

.important-task-content.editable {
    cursor: text;
    background: #f8f9fa;
}

.important-task-completed {
    text-decoration: line-through;
    color: #999;
    background: #f8f9fa !important;
}

.important-task-actions {
    display: flex;
    gap: 8px;
}

.important-task-btn {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 14px;
    padding: 6px;
    border-radius: 4px;
    transition: all 0.2s;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.complete-btn {
    color: #dc3545;
    border: 1px solid #dc3545;
    background: white;
}

.complete-btn:hover {
    background: #dc3545;
    color: white;
}

.complete-btn.completed {
    color: #28a745;
    border: 1px solid #28a745;
    background: #28a745;
    color: white;
}

.complete-btn.completed:hover {
    background: #218838;
    border-color: #218838;
}

.complete-btn.completed i::before {
    content: "\f00c"; /* fa-check */
}

.complete-btn:not(.completed) i::before {
    content: "\f00d"; /* fa-times */
}

.delete-btn {
    color: #6c757d;
    border: 1px solid #6c757d;
    background: white;
}

.delete-btn:hover {
    background: #6c757d;
    color: white;
}

/* 导入方式按钮容器 */
.import-method-buttons {
    display: flex;
    gap: 12px;
    margin-bottom: 15px;
justify-content: flex-start;
}

/* 导入方式按钮基础样式 */
.import-method-btn {
    color: white !important;
    border: none !important;
    padding: 10px !important;
    border-radius: 6px !important;
    cursor: pointer;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: all 0.2s ease;
    flex: none !important;
    width: auto !important;
    justify-content: center;
    font-weight: bold !important;
    text-decoration: none;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    min-width: 100px;
}

/* 粘贴数据按钮 - 修复 */
#import-paste-btn {
    background:#786290;
}

#import-paste-btn:hover {
    background: #b0a2c0 ;
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
}

/* 选择文件按钮 - 修复 */
#import-file-btn {
    background: #4C8BAE;
}

#import-file-btn:hover {
    background: #97b6c7;
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
}

/* 按钮激活状态 */
.import-method-btn:active {
    transform: translateY(0);
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
}

/* 闹铃音效设置按钮 */
        .btn-alarm {
            background: #17a2b8 !important;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .btn-alarm:hover {
            background: #138496 !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        /* 闹铃音效设置模态框 */
        .alarm-modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        
        .alarm-file-upload {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            margin: 20px 0;
            padding: 20px;
            border: 2px dashed #ddd;
            border-radius: 8px;
        }
        
        .alarm-file-upload i {
            font-size: 14px;
            color: #ffffff;
        }

.alarm-file-upload i.fa-music {
    font-size: 25px;
    color: #4b6bbe;
  }
        
        .alarm-file-info {
            font-size: 14px;
            color: #666;
            text-align: center;
        }
        
        .alarm-preview {
            margin-top: 15px;
            text-align: center;
        }
        
        .alarm-preview audio {
            width: 100%;
            max-width: 300px;
        }
        
        /* 闹铃状态指示 */
        .alarm-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
            padding: 10px;
            border-radius: 6px;
            background-color: #f8f9fa;
        }
        
        .alarm-status.active {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        
        .alarm-status.inactive {
            background-color: #f8d7da;
            color: #721c24;
        }

/* 添加响应式样式 */
@media (max-width: 768px) {
    .alarm-file-upload {
        padding: 15px !important;
    }
    
    .alarm-file-upload i.fa-music {
        font-size: 32px !important;
    }
    
    #improved-select-file {
        padding: 15px 20px !important;
        font-size: 16px !important;
    }
}

/* iPad特定样式 */
@media (hover: none) and (pointer: coarse) {
    .alarm-file-upload button {
        min-height: 44px; /* 确保触摸目标足够大 */
    }
    
    #audio-url-input {
        font-size: 16px; /* 防止iOS缩放 */
        padding: 12px;
    }
}

/* 上传状态样式 */
#upload-status {
    transition: all 0.3s ease;
}

#upload-status i {
    margin-right: 8px;
}
/* 闹铃音效设置模态框滚动条样式 */
.alarm-modal-content {
    max-height: 85vh;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
}

/* 自定义滚动条样式 */
.alarm-modal-content::-webkit-scrollbar {
    width: 8px;
}

.alarm-modal-content::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
}

.alarm-modal-content::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 4px;
}

.alarm-modal-content::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

/* 确保模态框内容在滚动时保持布局 */
.alarm-modal-content .modal-header {
    position: sticky;
    top: 0;
    background: white;
    z-index: 10;
    margin-bottom: 0;
}

.alarm-modal-content .form-actions {
    position: sticky;
    bottom: 0;
    background: white;
    z-index: 10;
    margin-top: 0;
    padding-top: 15px;
    border-top: 1px solid #eee;
}

/* 中间内容区域自动滚动 */
.alarm-modal-body {
    flex: 1;
    overflow-y: auto;
    padding: 5px 0;
}

/* 响应式调整 */
@media (max-width: 768px) {
    .alarm-modal-content {
        max-height: 90vh;
        margin: 10px;
    }
}

@media (max-height: 600px) {
    .alarm-modal-content {
        max-height: 95vh;
    }
}

/* 确保编辑模态框有足够的 z-index */
#edit-plan-modal {
    z-index: 2001;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    display: none;
    justify-content: center;
    align-items: center;
}

/* 确保详情页面不会覆盖模态框 */
#detail-modal {
    z-index: 100;
}
    </style>
</head>
<body>
    <!-- 顶部第一板块 -->
    <div class="header-top">
        <h1>学习计划与打卡统计助手</h1>
        <p>你已坚持打卡<span id="streak-days">0</span>天，已累计完成<span id="total-plans">0</span>个学习计划！</p>
    </div>

    <!-- 顶部第二板块 -->
    <div class="header-stats">
    <div class="stat-card">
        <div class="stat-label">今日学习时间</div>
        <div class="stat-value" id="today-study-time">0h</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">今日运动时间</div>
        <div class="stat-value" id="today-sports-time">0h</div>
    </div>
    <!-- 新增：今日总计划用时 -->
    <div class="stat-card">
        <div class="stat-label">今日总计划用时</div>
        <div class="stat-value" id="today-total-planned-time">0h</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">今日任务数量</div>
        <div class="stat-value" id="today-tasks">0/0</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">今日完成率</div>
        <div class="stat-value" id="today-completion">0%</div>
    </div>
    <!-- 新增统计卡片 -->
    <div class="stat-card" id="stats-chart-card">
        <div class="stat-label">统计图表汇总</div>
        <div class="stat-value"></div>
        <div class="stat-icon">
            <i class="fas fa-chart-pie"></i>
        </div>
    </div>
    <div class="stat-card" id="honor-wall-card">
        <div class="stat-label">荣誉勋章墙</div>
        <div class="stat-value"></div>
        <div class="stat-icon">
            <i class="fas fa-trophy"></i>
        </div>
    </div>
</div>

    <!-- 中间部分 -->
    <div class="middle-section">
        <!-- 右侧内容区域 -->
        <div class="content-area">
            <!-- 学习计划头部 -->
            <div class="plan-header">
        <div class="plan-title">
            <i class="fas fa-book"></i> 学习计划
            <!-- 添加排序按钮 -->
            <button class="sort-btn" id="sort-plans-btn" title="按时间排序">
                <i class="fas fa-sort"></i>
            </button>
        </div>
        <div class="plan-actions">
    <button class="btn-important" id="important-tasks-btn">
        <i class="fas fa-exclamation-circle"></i> 重要任务提醒
    </button>
            <button class="btn-batch" id="batch-add-btn">
                <i class="fas fa-layer-group"></i> 批量添加
            </button>
            <button class="btn-add" id="add-plan-btn">
                <i class="fas fa-plus"></i> 添加计划
            </button>
        </div>
    </div>

            <!-- 周视图头部 -->
            <div class="week-header">
                <div class="week-title" id="week-title"></div>
                <div class="week-controls">
                    <button class="btn" id="prev-week-btn"><i class="fas fa-chevron-left"></i></button>
                    <div class="custom-time-selector" id="today-btn">
                        <i class="fas fa-calendar"></i>
                        <span>今天</span>
                    </div>
                    <button class="btn" id="next-week-btn"><i class="fas fa-chevron-right"></i></button>
                    <button class="calendar-btn" id="full-calendar-btn">
                        <i class="fas fa-calendar-alt"></i>
                    </button>
                </div>
            </div>

            <!-- 周视图日历 -->
            <div class="calendar-grid" id="calendar-grid">
                <!-- 日历将通过JS动态生成 -->
            </div>

            <!-- 计划项列表 -->
            <div class="plan-list" id="plan-list">
                <!-- 计划项将通过JS动态生成 -->
            </div>
        </div>
    </div>

    <!-- 底部区域 -->
    <div class="data-actions">
        <button class="btn" id="backup-btn">
            <i class="fas fa-save"></i> 备份数据
        </button>
        <button class="btn" id="import-btn">
            <i class="fas fa-file-import"></i> 导入数据
        </button>
        <button class="btn" id="clear-btn">
            <i class="fas fa-trash"></i> 清空学习计划
        </button>
        <button class="btn btn-alarm" id="alarm-settings-btn">
            <i class="fas fa-bell"></i> 闹铃音效设置
        </button>
    </div>

    <div class="footer">
        学习计划与打卡统计助手 | 设计原则：劳逸结合·科学规划·快乐学习
    </div>

    <!-- 添加计划模态框 -->
    <div class="modal" id="add-plan-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">添加学习计划</div>
                <button class="close-btn" id="close-add-plan-modal">&times;</button>
            </div>
            <form id="add-plan-form">
                <div class="form-group">
                    <label for="plan-subject">科目</label>
                    <select id="plan-subject" class="form-control" required>
                        <option value="">选择科目</option>
                        <option value="english">英语</option>
                        <option value="chinese">语文</option>
                        <option value="math">数学</option>
                        <option value="sports">运动</option>
                        <option value="relax">放松</option> 
                        <option value="skill">技能</option>
                         <option value="daily">日常</option>
                        <option value="other">其他</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="plan-name">计划名称</label>
                    <input type="text" id="plan-name" class="form-control" placeholder="例如：星火英语" required>
                </div>
                <div class="form-group">
                    <label for="planned-duration">计划用时</label>
                    <input type="text" id="planned-duration" class="form-control" placeholder="例如：30min" required>
                </div>
                <div class="form-group">
                    <label for="plan-repeat">重复频率</label>
                    <select id="plan-repeat" class="form-control" required>
                        <option value="once">仅当天</option>
                        <option value="daily">每天</option>
                        <option value="weekdays">周一至周五</option>
                        <option value="weekly">每周的这天</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="plan-description">计划内容</label>
                    <textarea id="plan-description" class="form-control" rows="3" placeholder="描述你的学习内容..."></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-cancel" id="cancel-add-plan">取消</button>
                    <button type="submit" class="btn btn-save">保存计划</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 批量添加模态框 -->
    <div class="modal" id="batch-add-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">批量添加计划</div>
                <button class="close-btn" id="close-batch-add-modal">&times;</button>
            </div>
            <form id="batch-add-form">
                <div class="form-group">
                    <label for="batch-input">批量输入计划</label>
                    <textarea id="batch-input" class="batch-input" placeholder="例如:
语文
1.完成《大青树下的小学》阅读单
2.预习《花的学校》
数学
1.完成练习册第10页
2.预习下一节"></textarea>
                </div>
                <div class="form-group">
                    <label for="batch-planned-duration">计划用时</label>
                    <input type="text" id="batch-planned-duration" class="form-control" placeholder="例如：30min" required>
                </div>
                <div class="form-group">
                    <label for="batch-repeat">重复频率</label>
                    <select id="batch-repeat" class="form-control" required>
                        <option value="once">仅当天</option>
                        <option value="daily">每天</option>
                        <option value="weekdays">周一至周五</option>
                        <option value="weekly">每周的这天</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-cancel" id="cancel-batch-add">取消</button>
                    <button type="submit" class="btn btn-save">批量添加</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 备份数据模态框 -->
    <div class="modal" id="backup-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">备份数据</div>
                <button class="close-btn" id="close-backup-modal">&times;</button>
            </div>
            <div class="backup-info">
                <p>您的学习数据已成功备份！</p>
                <p>备份时间：<span id="backup-time"></span></p>
                <p>备份内容：学习计划、打卡记录、统计信息</p>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-cancel" id="close-backup">关闭</button>
                <button type="button" class="btn btn-save" id="download-backup">下载备份文件</button>
            </div>
        </div>
    </div>

    <!-- 导入数据模态框 -->
     <div class="modal" id="import-modal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title">导入数据</div>
            <button class="close-btn" id="close-import-modal">&times;</button>
        </div>
        <div class="form-group">
            <label>选择导入方式</label>
            <div class="import-method-buttons">
                <button type="button" class="import-method-btn" id="import-paste-btn">
                    <i class="fas fa-paste"></i> 粘贴数据
                </button>
                <button type="button" class="import-method-btn" id="import-file-btn">
                    <i class="fas fa-file-upload"></i> 选择文件
                </button>
            </div>
        </div>
        <form id="import-form">
            <div class="form-group" id="paste-import-section">
                <label for="data-import">粘贴备份数据</label>
                <textarea id="data-import" class="data-import" placeholder="请粘贴之前备份的数据"></textarea>
            </div>
            <div class="form-group" id="file-import-section" style="display: none;">
                <label for="data-file-import">选择备份文件</label>
                
                <!-- 改进的文件上传区域 -->
<div style="border: 2px dashed #ddd; border-radius: 8px; padding: 20px; text-align: center; margin-bottom: 10px; background: #fafafa; display: flex; flex-direction: column; align-items: center;">
        <div id="file-upload-area" style="display: flex; flex-direction: column; align-items: center;">
            <p style="margin-bottom: 10px; color: #666;">点击下方按钮选择备份文件</p>
            <button type="button" class="btn btn-save" id="trigger-file-upload" style="margin-bottom: 10px;">
                <i class="fas fa-upload"></i> 选择备份文件
            </button>
            <p id="file-name" style="font-size: 12px; color: #999;">未选择文件</p>
        </div>
    </div>
                
                <input type="file" id="data-file-import" class="form-control" accept=".json" style="display: none;">
                <small style="display: block; text-align: center; color: #666;">请选择之前导出的JSON备份文件</small>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-cancel" id="cancel-import">取消</button>
                <button type="submit" class="btn btn-save">导入数据</button>
            </div>
        </form>
    </div>
</div>

    <!-- 清空数据确认模态框 -->
    <div class="modal" id="clear-confirm-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">确认清空</div>
                <button class="close-btn" id="close-clear-modal">&times;</button>
            </div>
            <p>您确定要清空所有学习计划吗？此操作不可撤销！</p>
            <div class="form-actions">
                <button type="button" class="btn btn-cancel" id="cancel-clear">取消</button>
                <button type="button" class="btn btn-save" id="confirm-clear">确认清空</button>
            </div>
        </div>
    </div>

    <!-- 编辑计划模态框 -->
    <div class="modal" id="edit-plan-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">编辑学习计划</div>
                <button class="close-btn" id="close-edit-plan-modal">&times;</button>
            </div>
            <form id="edit-plan-form">
                <div class="form-group">
                    <label for="edit-plan-subject">科目</label>
                    <select id="edit-plan-subject" class="form-control" required>
                        <option value="">选择科目</option>
                        <option value="english">英语</option>
                        <option value="chinese">语文</option>
                        <option value="math">数学</option>
                        <option value="sports">运动</option>
                        <option value="relax">放松</option>
                        <option value="skill">技能</option>
                        <option value="daily">日常</option>
                        <option value="other">其他</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="edit-plan-name">计划名称</label>
                    <input type="text" id="edit-plan-name" class="form-control" placeholder="例如：星火英语" required>
                </div>
                <div class="form-group">
                    <label for="edit-planned-duration">计划用时</label>
                    <input type="text" id="edit-planned-duration" class="form-control" placeholder="例如：30min" required>
                </div>
                <div class="form-group">
                    <label for="edit-plan-repeat">重复频率</label>
                    <select id="edit-plan-repeat" class="form-control" required>
                        <option value="once">仅当天</option>
                        <option value="daily">每天</option>
                        <option value="weekdays">周一至周五</option>
                        <option value="weekly">每周的这天</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="edit-plan-description">计划内容</label>
                    <textarea id="edit-plan-description" class="form-control" rows="3" placeholder="描述你的学习内容..."></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-cancel" id="cancel-edit-plan">取消</button>
                    <button type="submit" class="btn btn-save">保存修改</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 详情页面模态框 -->
    <div class="detail-modal" id="detail-modal">
        <div class="detail-header">
            <button class="back-btn" id="back-btn">
                <i class="fas fa-arrow-left"></i>
                返回
            </button>
            <div class="detail-actions">
                <button class="detail-action-btn" id="edit-btn">
                    <i class="fas fa-edit"></i>
                    编辑
                </button>
                <button class="detail-action-btn" id="delete-btn">
                    <i class="fas fa-trash"></i>
                    删除
                </button>
            </div>
        </div>
        
        <div class="plan-title-section">
            <div class="plan-name-container">
                <div class="plan-name-large" id="detail-plan-name">
                    <i class="fas fa-book"></i> 目作文
                    <div class="repeat-badge" id="detail-repeat">重复频率：仅当天</div>
                </div>
            </div>
        </div>
        
        <div class="timer-section">
            <div class="detail-timer-display" id="detail-timer">00:00:00</div>
            <div class="detail-timer-controls">
                <button class="detail-timer-btn start" id="detail-start-btn">
        <i class="fas fa-play"></i> 开始
    </button>
    <button class="detail-timer-btn stop" id="detail-stop-btn">
        <i class="fas fa-stop"></i> 结束
    </button>
    <button class="detail-timer-btn cancel" id="detail-cancel-btn">
        <i class="fas fa-times"></i> 取消
    </button>
</div>
        </div>
        
        <div class="info-section">
            <div class="info-card">
                <div class="info-title">
                    <i class="fas fa-book"></i>
                    任务分类
                </div>
                <div class="info-content" id="detail-subject">语文</div>
            </div>
            
            <div class="info-card">
                <div class="info-title">
                    <i class="fas fa-clock"></i>
                    计划用时
                </div>
                 <div class="info-content" id="detail-planned-duration">30min</div>
            </div>
            
            <div class="info-card">
                <div class="info-title">
                    <i class="fas fa-calendar"></i>
                    任务日期
                </div>
                <div class="info-content" id="detail-date">2025-10-08</div>
            </div>
            
            <div class="info-card">
                <div class="info-title">
                    <i class="fas fa-history"></i>
                    实际时间
                </div>
                <div class="info-content" id="detail-actual-time">14:26 - 进行中</div>
            </div>
        </div>
        
        <div class="description-section">
            <div class="description-title">
                <i class="fas fa-file-alt"></i>
                任务说明
            </div>
            <textarea class="description-content" id="detail-description">分) 请你选择国庆假期中记忆较深的一天写一篇日记，写出自己在这一天中的所言、所行、所见、所闻和所感，注意日记的格式。</textarea>
        </div>
    </div>

  <!-- 统计图表详情页模态框 -->
<div class="stats-detail-modal" id="stats-detail-modal">
    <div class="stats-header">
        <div class="stats-title">
            <i class="fas fa-chart-bar"></i>
            学习数据统计详情
        </div>
        <button class="back-btn" id="stats-back-btn">
            <i class="fas fa-arrow-left"></i>
            返回
        </button>
    </div>
    
    <!-- 日期筛选区域 -->
     <div class="date-filter-container">
        <div class="date-filter-label">统计时间范围：</div>
        <div class="date-input" id="start-date">
            <i class="fas fa-calendar"></i>
               <span id="start-date-display">2025/10/01</span>
        </div>
        <span>至</span>
        <div class="date-input" id="end-date">
            <i class="fas fa-calendar"></i>
             <span id="end-date-display">2025/10/15</span>
        </div>
        <button class="filter-btn" id="stats-filter-btn">
            筛选
        </button>
    </div>
    
    <!-- 图表容器 -->
    <div class="chart-container">
           <div id="completion-chart" style="width: 100%; height: 100%;"></div>
    </div>
    
    <div class="chart-container">
           <div id="time-comparison-chart" style="width: 100%; height: 100%;"></div>
    </div>
    
    <div class="chart-container">
          <div id="category-pie-chart" style="width: 100%; height: 100%;"></div>
    </div>
    
                  <!-- 新增的日期筛选区域 -->
            <div class="plan-actual-date-filter">
                <div class="plan-actual-date-label">选择日期：</div>
                <div class="plan-actual-date-input" id="plan-actual-date-input">
                    <i class="fas fa-calendar"></i>
                    <span id="plan-actual-date-display">选择日期</span>
            </div>
                <button class="plan-actual-filter-btn" id="plan-actual-filter-btn">
                    筛选
                </button>
            </div>
            
    <div class="chart-container">
            <div id="plan-vs-actual-chart" style="width: 100%; height: 100%;"></div>
        </div>
    </div>
    
    <!-- 新增的全年日历模态框 - 用于计划用时筛选 -->
    <div class="plan-actual-calendar-modal" id="plan-actual-calendar-modal">
        <div class="plan-actual-calendar-content year-calendar">
            <div class="modal-header">
                <div class="modal-title">选择日期</div>
                <button class="close-btn" id="close-plan-actual-calendar-modal">&times;</button>
            </div>
            <div class="calendar-header">
                <div class="calendar-nav">
                    <button class="calendar-nav-btn" id="plan-actual-prev-year-btn">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <div class="calendar-month-year" id="plan-actual-calendar-month-year">2025年10月</div>
                    <button class="calendar-nav-btn" id="plan-actual-next-year-btn">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
            <div class="calendar-grid-year" id="plan-actual-calendar-grid-year">
                <!-- 日历将通过JS动态生成 -->
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-cancel" id="cancel-plan-actual-calendar">取消</button>
                <button type="button" class="btn btn-save" id="confirm-plan-actual-calendar">确定</button>
            </div>
        </div>
    </div>

<!-- 统计图表日期筛选日历模态框 -->
    <div class="stats-date-calendar-modal" id="stats-date-calendar-modal">
        <div class="stats-date-calendar-content year-calendar">
            <div class="modal-header">
                <div class="modal-title">选择日期</div>
                <button class="close-btn" id="close-stats-date-calendar-modal">&times;</button>
            </div>
            <div class="calendar-header">
                <div class="calendar-nav">
                    <button class="calendar-nav-btn" id="stats-date-prev-year-btn">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <div class="calendar-month-year" id="stats-date-calendar-month-year">2025年10月</div>
                    <button class="calendar-nav-btn" id="stats-date-next-year-btn">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
            <div class="calendar-grid-year" id="stats-date-calendar-grid-year">
                <!-- 日历将通过JS动态生成 -->
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-cancel" id="cancel-stats-date-calendar">取消</button>
                <button type="button" class="btn btn-save" id="confirm-stats-date-calendar">确定</button>
            </div>
        </div>
    </div>

    <!-- 全年日历模态框 -->
    <div class="modal" id="full-calendar-modal">
        <div class="modal-content year-calendar">
            <div class="modal-header">
                <div class="modal-title">选择日期</div>
                <button class="close-btn" id="close-full-calendar-modal">&times;</button>
            </div>
            <div class="calendar-header">
                <div class="calendar-nav">
                    <button class="calendar-nav-btn" id="prev-year-btn">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <div class="calendar-month-year" id="calendar-month-year">2025年10月</div>
                    <button class="calendar-nav-btn" id="next-year-btn">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
            <div class="calendar-grid-year" id="calendar-grid-year">
                <!-- 日历将通过JS动态生成 -->
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-cancel" id="cancel-full-calendar">取消</button>
                <button type="button" class="btn btn-save" id="confirm-full-calendar">确定</button>
            </div>
        </div>
</div>

 <!-- 荣誉勋章墙模态框 -->
    <div class="honor-modal" id="honor-modal">
        <div class="honor-header">
            <div class="honor-title">
                <i class="fas fa-trophy"></i>
                荣誉勋章墙
           </div>
        <div class="honor-actions">
            <button class="back-btn" id="honor-back-btn">
                <i class="fas fa-arrow-left"></i>
                返回
            </button>
        </div>
    </div>

 <!-- 新增：勋章操作按钮区域 -->
    <div class="honor-main-actions">
        <button class="honor-main-btn" id="add-honor-btn">
            <i class="fas fa-plus"></i>
            添加勋章
        </button>
        <button class="honor-main-btn" id="clear-honor-btn">
            <i class="fas fa-trash"></i>
            清空勋章
        </button>
    </div>
        
        <!-- 连续打卡成就 -->
        <div class="honor-section">
            <div class="honor-section-title">连续打卡成就</div>
            <div class="honor-grid" id="streak-honor-grid">
                <!-- 通过JS动态生成 -->
            </div>
        </div>
        
        <!-- 累计打卡成就 -->
        <div class="honor-section">
            <div class="honor-section-title">累计打卡成就</div>
            <div class="honor-grid" id="total-honor-grid">
                <!-- 通过JS动态生成 -->
            </div>
        </div>
        
        <!-- 分类打卡成就 -->
        <div class="honor-section">
            <div class="honor-section-title">分类打卡成就</div>
            <div class="honor-grid" id="category-honor-grid">
                <!-- 通过JS动态生成 -->
            </div>
        </div>
        
        <!-- 时间管理成就 -->
        <div class="honor-section">
            <div class="honor-section-title">时间管理成就</div>
            <div class="honor-grid" id="time-management-honor-grid">
                <!-- 通过JS动态生成 -->
            </div>
        </div>
        
        <!-- 总学习时间成就 -->
        <div class="honor-section">
            <div class="honor-section-title">总学习时间成就</div>
            <div class="honor-grid" id="total-study-honor-grid">
                <!-- 通过JS动态生成 -->
            </div>
        </div>
        
        <!-- 提前完成成就 -->
        <div class="honor-section">
            <div class="honor-section-title">提前完成成就</div>
            <div class="honor-grid" id="early-completion-honor-grid">
                <!-- 通过JS动态生成 -->
            </div>
        </div>
        
        <!-- 许愿星兑换板块 -->
        <div class="wish-section">
            <div class="wish-header">
                <div class="wish-title">许愿星兑换</div>
                <div class="wish-stars">
                    <i class="fas fa-star"></i>
                    <span id="available-stars">0</span>
                </div>
            </div>
            
            <div class="wish-categories">
                <button class="wish-category-btn active" data-category="all">全部</button>
                <button class="wish-category-btn" data-category="entertainment">娱乐活动</button>
                <button class="wish-category-btn" data-category="food">美食饮品</button>
                <button class="wish-category-btn" data-category="shopping">购物奖励</button>
                <button class="wish-category-btn" data-category="experience">体验活动</button>
            </div>
            
            <div class="wish-actions">
                <button class="honor-action-btn" id="add-wish-btn">
                    <i class="fas fa-plus"></i>
                    添加兑换清单
                </button>
                <button class="honor-action-btn" id="clear-wish-btn">
                    <i class="fas fa-trash"></i>
                    清空兑换清单
                </button>
            </div>
            
            <div class="wish-grid" id="wish-grid">
                <!-- 通过JS动态生成 -->
            </div>
        </div>
    </div>
    
    <!-- 添加勋章模态框 -->
    <div class="add-honor-modal" id="add-honor-modal">
        <div class="add-honor-content">
            <div class="modal-header">
                <div class="modal-title">添加勋章</div>
                <button class="close-btn" id="close-add-honor-modal">&times;</button>
            </div>
            <form id="add-honor-form">
                <div class="form-group">
                    <label for="honor-name">勋章名称</label>
                    <input type="text" id="honor-name" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="honor-description">勋章描述</label>
                    <textarea id="honor-description" class="form-control" rows="3" required></textarea>
                </div>
                <div class="form-group">
                    <label for="honor-icon">选择图标</label>
                    <select id="honor-icon" class="form-control" required>
                        <option value="fas fa-medal">奖牌</option>
                        <option value="fas fa-trophy">奖杯</option>
                        <option value="fas fa-star">星星</option>
                        <option value="fas fa-crown">皇冠</option>
                        <option value="fas fa-award">荣誉</option>
                        <option value="fas fa-gem">宝石</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="honor-color">选择颜色</label>
                    <input type="color" id="honor-color" class="form-control" value="#fd9400" required>
                </div>
                <div class="form-group">
                    <label for="honor-condition">解锁条件</label>
                    <select id="honor-condition" class="form-control" required>
                        <option value="streak">连续打卡天数</option>
                        <option value="total_plans">累计完成计划数</option>
                        <option value="category_hours">分类完成时间(小时)</option>
                        <option value="time_accuracy">时间管理准确率</option>
                        <option value="total_study_hours">总学习时间(小时)</option>
                        <option value="early_completion">提前完成次数</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="honor-value">条件值</label>
                    <input type="number" id="honor-value" class="form-control" required>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-cancel" id="cancel-add-honor">取消</button>
                    <button type="submit" class="btn btn-save">保存勋章</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 添加兑换清单模态框 -->
    <div class="add-wish-modal" id="add-wish-modal">
        <div class="add-wish-content">
            <div class="modal-header">
                <div class="modal-title">添加兑换清单</div>
                <button class="close-btn" id="close-add-wish-modal">&times;</button>
            </div>
            <form id="add-wish-form">
                <div class="form-group">
                    <label for="wish-category">兑换类别</label>
                    <select id="wish-category" class="form-control" required>
                        <option value="entertainment">娱乐活动</option>
                        <option value="food">美食饮品</option>
                        <option value="shopping">购物奖励</option>
                        <option value="experience">体验活动</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="wish-content">兑换内容</label>
                    <input type="text" id="wish-content" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="wish-quantity">兑换数量</label>
                    <input type="number" id="wish-quantity" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="wish-cost">所需星星</label>
                    <input type="number" id="wish-cost" class="form-control" required>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-cancel" id="cancel-add-wish">取消</button>
                    <button type="submit" class="btn btn-save">保存兑换项</button>
                </div>
            </form>
        </div>
    </div>

  <!-- 编辑兑换清单模态框 -->
    <div class="edit-wish-modal" id="edit-wish-modal">
        <div class="edit-wish-content">
            <div class="modal-header">
                <div class="modal-title">编辑兑换项</div>
                <button class="close-btn" id="close-edit-wish-modal">&times;</button>
            </div>
            <form id="edit-wish-form">
                <input type="hidden" id="edit-wish-id">
                <div class="form-group">
                    <label for="edit-wish-category">兑换类别</label>
                    <select id="edit-wish-category" class="form-control" required>
                        <option value="entertainment">娱乐活动</option>
                        <option value="food">美食饮品</option>
                        <option value="shopping">购物奖励</option>
                        <option value="experience">体验活动</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="edit-wish-content">兑换内容</label>
                    <input type="text" id="edit-wish-content" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="edit-wish-quantity">兑换数量</label>
                    <input type="number" id="edit-wish-quantity" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="edit-wish-cost">所需星星</label>
                    <input type="number" id="edit-wish-cost" class="form-control" required>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-cancel" id="cancel-edit-wish">取消</button>
                    <button type="submit" class="btn btn-save">保存修改</button>
                </div>
            </form>
        </div>
    </div>

<!-- 勋章解锁弹窗 -->
<div class="honor-unlock-modal" id="honor-unlock-modal">
    <div class="honor-unlock-content">
        <div class="honor-unlock-icon" id="honor-unlock-icon">
            <i class="fas fa-trophy"></i>
        </div>
        <div class="honor-unlock-title" id="honor-unlock-title">恭喜解锁新勋章！</div>
        <div class="honor-unlock-description" id="honor-unlock-description">勋章描述</div>
        <div class="honor-unlock-stars">
            <i class="fas fa-star"></i>
            <span>获得 <span id="honor-unlock-star-count">0</span> 颗星星</span>
            <i class="fas fa-star"></i>
        </div>
        <button class="honor-unlock-btn" id="honor-unlock-close-btn">太棒了！</button>
    </div>
</div>

<!-- 在模态框部分修改重要任务提醒模态框 -->
<div class="modal" id="important-tasks-modal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title">重要任务提醒</div>
            <button class="close-btn" id="close-important-tasks-modal">&times;</button>
        </div>
        <div class="form-group">
            <label for="new-important-task">批量添加重要任务</label>
            <textarea id="new-important-task" class="form-control" rows="6" placeholder="每行输入一个重要任务，例如：
完成数学作业
准备英语考试
提交项目报告
..."></textarea>
            <button id="add-important-task" class="btn btn-save" style="margin-top: 10px;">
                <i class="fas fa-layer-group"></i> 批量添加任务
            </button>
        </div>
        <div class="important-tasks-list" id="important-tasks-list">
            <!-- 任务列表将通过JS动态生成 -->
        </div>
        <div class="form-actions" style="margin-top: 20px;">
            <button type="button" class="btn btn-cancel" id="clear-all-tasks-btn">
                <i class="fas fa-trash"></i> 清空所有任务
            </button>
        </div>
    </div>
</div>

<!-- 修改闹铃音效设置模态框结构 -->
<div class="modal" id="alarm-settings-modal">
    <div class="modal-content alarm-modal-content">
        <div class="modal-header">
            <div class="modal-title">闹铃音效设置</div>
            <button class="close-btn" id="close-alarm-modal">&times;</button>
        </div>
        
        <div class="alarm-modal-body">
            <div class="form-group">
                <label>选择闹铃音效</label>
                <div class="alarm-file-upload">
                    <!-- 内容将由 JavaScript 动态生成 -->
                </div>
                <div class="alarm-preview" id="alarm-preview" style="display: none;">
                    <p>当前音效:</p>
                    <audio id="alarm-audio-preview" controls></audio>
                </div>
                <div class="alarm-status inactive" id="alarm-status">
                    <i class="fas fa-volume-mute"></i>
                    <span>当前未设置闹铃音效，将使用浏览器通知</span>
                </div>
            </div>
        
            <div class="form-actions">
                <button type="button" class="btn btn-cancel" id="cancel-alarm-settings">取消</button>
                <button type="button" class="btn btn-save" id="save-alarm-settings">保存设置</button>
                <button type="button" class="btn btn-cancel" id="clear-alarm-btn">
                    <i class="fas fa-trash"></i> 清除音效
                </button>
            </div>
        </div>
    </div>

    <script>
// 统一的模态框管理对象
const ModalManager = {
    // 所有模态框的配置
    modals: {
        'add-plan-modal': { closeButtons: ['close-add-plan-modal', 'cancel-add-plan'] },
        'batch-add-modal': { closeButtons: ['close-batch-add-modal', 'cancel-batch-add'] },
        'backup-modal': { closeButtons: ['close-backup-modal', 'close-backup'] },
        'import-modal': { closeButtons: ['close-import-modal', 'cancel-import'] },
        'clear-confirm-modal': { closeButtons: ['close-clear-modal', 'cancel-clear'] },
        'edit-plan-modal': { closeButtons: ['close-edit-plan-modal', 'cancel-edit-plan'] },
        'full-calendar-modal': { closeButtons: ['close-full-calendar-modal', 'cancel-full-calendar'] },
        'plan-actual-calendar-modal': { closeButtons: ['close-plan-actual-calendar-modal', 'cancel-plan-actual-calendar'] },
        'stats-date-calendar-modal': { closeButtons: ['close-stats-date-calendar-modal', 'cancel-stats-date-calendar'] },
        'important-tasks-modal': { closeButtons: ['close-important-tasks-modal'] },
        'alarm-settings-modal': { closeButtons: ['close-alarm-modal', 'cancel-alarm-settings'] },
        'add-honor-modal': { closeButtons: ['close-add-honor-modal', 'cancel-add-honor'] },
        'add-wish-modal': { closeButtons: ['close-add-wish-modal', 'cancel-add-wish'] },
        'edit-wish-modal': { closeButtons: ['close-edit-wish-modal', 'cancel-edit-wish'] },
        'honor-unlock-modal': { closeButtons: ['honor-unlock-close-btn'] },
     },

    // 初始化所有模态框事件
    init() {
        this.setupModalEvents();
     },

    // 设置模态框事件
    setupModalEvents() {
        for (const [modalId, config] of Object.entries(this.modals)) {
            config.closeButtons.forEach(buttonId => {
                const button = document.getElementById(buttonId);
                if (button) {
                    button.addEventListener('click', () => this.close(modalId));
                }
            });
        }
    },

    // 打开模态框
    open(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.style.display = 'flex';
        }
    },

    // 关闭模态框
    close(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.style.display = 'none';
        }
    },

    // 切换模态框状态
    toggle(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.style.display = modal.style.display === 'flex' ? 'none' : 'flex';
        }
    }
};

        // 数据模型
        let plans = JSON.parse(localStorage.getItem('studyPlans')) || [];
        let checkins = JSON.parse(localStorage.getItem('studyCheckins')) || [];
        let currentWeekOffset = 0;
        let selectedDate = new Date();
        let timers = {};
        let currentDetailPlanId = null;
        let currentEditPlanId = null;
        let selectedCalendarDate = null;
        let currentSortOrder = 'default'; 

// 重要任务提醒数据
        let importantTasks = JSON.parse(localStorage.getItem('importantTasks')) || [];
        
        // 新增变量 - 用于计划用时筛选
        let selectedPlanActualDate = new Date(); // 默认选中今天
        let selectedPlanActualCalendarDate = null;

   // 新增变量 - 用于统计图表日期筛选
        let selectedStatsStartDate = new Date();
        selectedStatsStartDate.setDate(selectedStatsStartDate.getDate() - 14); // 默认开始日期为14天前
        let selectedStatsEndDate = new Date(); // 默认结束日期为今天
        let selectedStatsCalendarDate = null;
        let currentStatsDateSelection = null; // 'start' 或 'end'

        // 在现有变量后面添加新变量
        let currentEditingWishId = null;

        // 新增闹铃相关变量
        let alarmAudio = null;
        let alarmFile = null;
        let alarmTimeoutIds = {}; 

        // 获取DOM元素
        const planList = document.getElementById('plan-list');
        const calendarGrid = document.getElementById('calendar-grid');
        const todayBtn = document.getElementById('today-btn');
        const addPlanBtn = document.getElementById('add-plan-btn');
        const batchAddBtn = document.getElementById('batch-add-btn');
        const backupBtn = document.getElementById('backup-btn');
        const importBtn = document.getElementById('import-btn');
        const clearBtn = document.getElementById('clear-btn');
        const prevWeekBtn = document.getElementById('prev-week-btn');
        const nextWeekBtn = document.getElementById('next-week-btn');
        const weekTitle = document.getElementById('week-title');
        const fullCalendarBtn = document.getElementById('full-calendar-btn');
        const statsChartCard = document.getElementById('stats-chart-card');
        const statsDetailModal = document.getElementById('stats-detail-modal');
        const statsBackBtn = document.getElementById('stats-back-btn');

   // 闹铃相关DOM元素
        const alarmSettingsBtn = document.getElementById('alarm-settings-btn');
        const alarmSettingsModal = document.getElementById('alarm-settings-modal');
        const saveAlarmSettings = document.getElementById('save-alarm-settings');
        const alarmPreview = document.getElementById('alarm-preview');
        const alarmAudioPreview = document.getElementById('alarm-audio-preview');
        const alarmStatus = document.getElementById('alarm-status');
        const clearAlarmBtn = document.getElementById('clear-alarm-btn');

        // 获取弹窗元素
        const honorUnlockModal = document.getElementById('honor-unlock-modal');
        const honorUnlockIcon = document.getElementById('honor-unlock-icon');
        const honorUnlockTitle = document.getElementById('honor-unlock-title');
        const honorUnlockDescription = document.getElementById('honor-unlock-description');
        const honorUnlockStarCount = document.getElementById('honor-unlock-star-count');
        const honorUnlockCloseBtn = document.getElementById('honor-unlock-close-btn');

        // 图表容器
        const completionChart = document.getElementById('completion-chart');
        const timeComparisonChart = document.getElementById('time-comparison-chart');
        const categoryPieChart = document.getElementById('category-pie-chart');
        const planVsActualChart = document.getElementById('plan-vs-actual-chart');

        // 模态框元素
        const addPlanModal = document.getElementById('add-plan-modal');
        const batchAddModal = document.getElementById('batch-add-modal');
        const backupModal = document.getElementById('backup-modal');
        const importModal = document.getElementById('import-modal');
        const clearConfirmModal = document.getElementById('clear-confirm-modal');
        const editPlanModal = document.getElementById('edit-plan-modal');
        const detailModal = document.getElementById('detail-modal');
        const fullCalendarModal = document.getElementById('full-calendar-modal');
        
        // 新增模态框元素 - 用于计划用时筛选
        const planActualCalendarModal = document.getElementById('plan-actual-calendar-modal');
        const planActualDateInput = document.getElementById('plan-actual-date-input');
        const planActualDateDisplay = document.getElementById('plan-actual-date-display');
        const planActualFilterBtn = document.getElementById('plan-actual-filter-btn');
        const closePlanActualCalendarModal = document.getElementById('close-plan-actual-calendar-modal');
        const planActualCalendarMonthYear = document.getElementById('plan-actual-calendar-month-year');
        const planActualCalendarGridYear = document.getElementById('plan-actual-calendar-grid-year');
        const planActualPrevYearBtn = document.getElementById('plan-actual-prev-year-btn');
        const planActualNextYearBtn = document.getElementById('plan-actual-next-year-btn');
        const cancelPlanActualCalendar = document.getElementById('cancel-plan-actual-calendar');
        const confirmPlanActualCalendar = document.getElementById('confirm-plan-actual-calendar');

         // 新增模态框元素 - 用于统计图表日期筛选
        const statsDateCalendarModal = document.getElementById('stats-date-calendar-modal');
        const statsDateCalendarMonthYear = document.getElementById('stats-date-calendar-month-year');
        const statsDateCalendarGridYear = document.getElementById('stats-date-calendar-grid-year');
        const statsDatePrevYearBtn = document.getElementById('stats-date-prev-year-btn');
        const statsDateNextYearBtn = document.getElementById('stats-date-next-year-btn');
        const closeStatsDateCalendarModal = document.getElementById('close-stats-date-calendar-modal');
        const cancelStatsDateCalendar = document.getElementById('cancel-stats-date-calendar');
        const confirmStatsDateCalendar = document.getElementById('confirm-stats-date-calendar');
        const statsFilterBtn = document.getElementById('stats-filter-btn');
        
        // 详情页面元素
        const backBtn = document.getElementById('back-btn');
        const detailTimer = document.getElementById('detail-timer');
        const detailStartBtn = document.getElementById('detail-start-btn');
        const detailStopBtn = document.getElementById('detail-stop-btn');

        // 全年日历元素
        const calendarMonthYear = document.getElementById('calendar-month-year');
        const calendarGridYear = document.getElementById('calendar-grid-year');
        const prevYearBtn = document.getElementById('prev-year-btn');
        const nextYearBtn = document.getElementById('next-year-btn');
        const confirmFullCalendar = document.getElementById('confirm-full-calendar');

// 添加窗口大小变化监听
window.addEventListener('resize', function() {
    // 重新调整所有图表大小
    if (window.completionChart) window.completionChart.resize();
    if (window.timeComparisonChart) window.timeComparisonChart.resize();
    if (window.categoryPieChart) window.categoryPieChart.resize();
    if (window.planVsActualChart) window.planVsActualChart.resize();
});

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {

            // 修复时区问题：迁移现有数据
            migrateTimezoneData();

            // 恢复正在运行的计时器
            restoreRunningTimers();

            ModalManager.init();
            renderCalendar();
            renderPlans();
            setupEventListeners();
            updateStats();
            updateWeekTitle();

            // 初始化闹铃设置
            initAlarmSettings();

             // 初始化计划用时筛选日期显示
        planActualDateDisplay.textContent = formatDateForDisplay(selectedPlanActualDate);
        
        // 初始化统计图表日期显示
        document.getElementById('start-date-display').textContent = formatDateForDisplay(selectedStatsStartDate);
        document.getElementById('end-date-display').textContent = formatDateForDisplay(selectedStatsEndDate);
});

          // 恢复正在运行的计时器
    function restoreRunningTimers() {
        plans.forEach(plan => {
            if (plan.running && plan.startTime) {
                // 计算从开始到现在的时间差
                const elapsed = Date.now() - plan.startTime;
                
                // 如果计划有总持续时间，将其加上
                if (plan.totalDuration) {
                    plan.totalDuration += elapsed;
                } else {
                    plan.totalDuration = elapsed;
                }
                
                // 重置开始时间为当前时间，这样计时器会继续从正确的位置开始
                plan.startTime = Date.now();
                
                // 开始新的计时器
                startTimerInterval(plan.id);
            }
        });
    }

// 根据科目和任务内容获取图标和计划名称 - 更新版本
function getPlanIconAndName(subject, taskContent) {
    let planName = '练习';
    let icon = 'fas fa-book';
    
    // 定义运动项目列表
    const sportsItems = ['羽毛球', '游泳', '跑步', '跳绳', '篮球', '足球', '乒乓球', '网球', 
                        '排球', '健身', '瑜伽', '舞蹈', '武术', '滑板', '轮滑', '骑行'];
    
    // 定义技能项目列表
    const skillItems = ['书法', '竹笛', '钢琴', '吉他', '小提琴', '画画', '绘画', '编程', '手工'];
    
    // 定义日常活动关键词映射
    const dailyActivities = {
        '吃饭': {name: '吃饭', icon: 'fas fa-utensils'},
        '用餐': {name: '吃饭', icon: 'fas fa-utensils'},
        '早餐': {name: '吃饭', icon: 'fas fa-utensils'},
        '午餐': {name: '吃饭', icon: 'fas fa-utensils'},
        '晚餐': {name: '吃饭', icon: 'fas fa-utensils'},
        '上厕所': {name: '上厕所', icon: 'fas fa-toilet'},
        '洗手间': {name: '上厕所', icon: 'fas fa-toilet'},
        '卫生间': {name: '上厕所', icon: 'fas fa-toilet'},
        '冲牙': {name: '冲牙', icon: 'fas fa-shower'},
        '刷牙': {name: '冲牙', icon: 'fas fa-shower'},
        '洗漱': {name: '冲牙', icon: 'fas fa-shower'},
        '洗脸': {name: '冲牙', icon: 'fas fa-shower'},
        '洗澡': {name: '洗澡', icon: 'fas fa-shower'},
        '沐浴': {name: '洗澡', icon: 'fas fa-shower'},
        '睡觉': {name: '睡觉', icon: 'fas fa-bed'},
        '午休': {name: '睡觉', icon: 'fas fa-bed'},
        '休息': {name: '休息', icon: 'fas fa-couch'},
        '小憩': {name: '休息', icon: 'fas fa-couch'}
    };
    
    // 特殊处理：运动科目
    if (subject === 'sports') {
        let foundSport = false;
        for (const sport of sportsItems) {
            if (taskContent.includes(sport)) {
                planName = sport;
                icon = 'fas fa-running';
                foundSport = true;
                break;
            }
        }
        if (!foundSport) {
            planName = '运动';
            icon = 'fas fa-running';
        }
    }
    
    // 特殊处理：技能科目
    else if (subject === 'skill') {
        let foundSkill = false;
        for (const skill of skillItems) {
            if (taskContent.includes(skill)) {
                planName = skill;
                icon = 'fas fa-paint-brush';
                foundSkill = true;
                break;
            }
        }
        if (!foundSkill) {
            planName = '技能';
            icon = 'fas fa-paint-brush';
        }
    }
    
    // 特殊处理：放松科目
    else if (subject === 'relax') {
        planName = '放松';
        icon = 'fas fa-couch';
        
        if (taskContent.includes('游戏') || taskContent.includes('玩')) {
            planName = '玩';
            icon = 'fas fa-gamepad';
        } else if (taskContent.includes('电影') || taskContent.includes('电视')) {
            planName = '观影';
            icon = 'fas fa-film';
        } else if (taskContent.includes('音乐') || taskContent.includes('听歌')) {
            planName = '音乐';
            icon = 'fas fa-music';
        } else if (taskContent.includes('阅读') || taskContent.includes('看书')) {
            planName = '阅读';
            icon = 'fas fa-book-reader';
        }
    }
    
    // 特殊处理：日常科目
    else if (subject === 'daily') {
        let foundDailyActivity = false;
        for (const [keyword, activity] of Object.entries(dailyActivities)) {
            if (taskContent.includes(keyword)) {
                planName = activity.name;
                icon = activity.icon;
                foundDailyActivity = true;
                break;
            }
        }
        if (!foundDailyActivity) {
            planName = '日常';
            icon = 'fas fa-home';
        }
    }
    
    // 特殊处理：历史、道法科目（映射到other）
    else if (subject === 'other' && (taskContent.includes('历史') || taskContent.includes('道法'))) {
        planName = taskContent.includes('历史') ? '历史' : '道法';
        icon = 'fas fa-book';
    }
    
    // 优化改错类任务识别逻辑
    else if ((taskContent.includes('订') && taskContent.includes('卷')) || 
             (taskContent.includes('订') && taskContent.includes('练习')) ||
             taskContent.includes('错题')) {
        planName = '改错';
        icon = 'fas fa-calculator';
    }
    // 预复习类任务：包含"笔记"或"预习"
    else if (taskContent.includes('笔记') || taskContent.includes('预习')) {
        planName = '预复习';
        icon = 'fas fa-book';
    }
    // 练习类任务
    else if (taskContent.includes('练习') || taskContent.includes('习题') || 
             taskContent.includes('课时') || taskContent.includes('卷') || 
             taskContent.includes('题目')) {
        planName = '练习';
        icon = 'fas fa-book';
    }
    // 背默抄类任务
    else if (taskContent.includes('默') || taskContent.includes('背') || 
             taskContent.includes('复习') || taskContent.includes('摘抄') || 
             taskContent.includes('抄写') || taskContent.includes('抄')) {
        planName = '背默抄';
        icon = 'fas fa-pencil-alt';
    }
    // 写作类任务
    else if (taskContent.includes('作文') || taskContent.includes('周记') || 
             taskContent.includes('短文')) {
        planName = '写作';
        icon = 'fas fa-pencil-alt';
    }
    // 听读类任务
    else if (taskContent.includes('读')) {
        planName = '听读';
        icon = 'fas fa-headphones';
    }
    // 打卡类任务
    else if (taskContent.includes('打卡')) {
        planName = '打卡';
        icon = 'fas fa-pencil-alt';
    }
    
    // 科目特定的默认图标
    else {
        const subjectIcons = {
            'english': 'fas fa-language',
            'chinese': 'fas fa-book',
            'math': 'fas fa-calculator',
            'sports': 'fas fa-running',
            'relax': 'fas fa-couch',
            'skill': 'fas fa-paint-brush',
            'daily': 'fas fa-home',
            'other': 'fas fa-book'
        };
        icon = subjectIcons[subject] || 'fas fa-book';
        
        // 如果计划名称还是默认的"练习"，根据科目设置更合适的名称
        if (planName === '练习') {
            const subjectNames = {
                'english': '英语',
                'chinese': '语文',
                'math': '数学',
                'sports': '运动',
                'relax': '放松',
                'skill': '技能',
                'daily': '日常',
                'other': '其他'
            };
            planName = subjectNames[subject] || '练习';
        }
    }
    
    return { planName, icon };
}

        // 初始化闹铃设置
        function initAlarmSettings() {
            console.log('初始化闹铃设置...');
    
            // 从本地存储加载闹铃音效
            const savedAlarmData = localStorage.getItem('alarmSound');
            if (savedAlarmData) {
                try {
                    const alarmData = JSON.parse(savedAlarmData);
                    console.log('找到保存的音效数据:', alarmData.name);
            
                    // 创建音频对象
                    alarmAudio = new Audio();
                    alarmAudio.src = alarmData.url;
            
                    // 预加载音频
                    alarmAudio.load();
            
                    // 更新预览
                    if (alarmAudioPreview) {
                        alarmAudioPreview.src = alarmData.url;
                        alarmAudioPreview.load();
                        alarmPreview.style.display = 'block';
                    }
            
                    // 更新状态
                    updateAlarmStatusDisplay(true, alarmData.name);
            
                    console.log('音效初始化成功');
                } catch (e) {
                    console.error('加载闹铃音效失败:', e);
                    updateAlarmStatusDisplay(false);
                }
            } else {
                    console.log('未找到保存的音效数据');
                    updateAlarmStatusDisplay(false);
            }
       }

// 检测设备类型和浏览器兼容性
function checkDeviceCompatibility() {
    const ua = navigator.userAgent;
    const isiPad = /iPad/.test(ua) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
    const isChrome = /Chrome/.test(ua);
    const isSafari = /Safari/.test(ua) && !/Chrome/.test(ua);
    
    return {
        isiPad,
        isChrome,
        isSafari,
        supportsFileUpload: 'FileReader' in window,
        supportsAudio: 'Audio' in window
    };
}

// 显示兼容性警告
function showCompatibilityWarning() {
    const compatibility = checkDeviceCompatibility();
    
    if (compatibility.isiPad) {
        let message = '检测到您在iPad上使用：\n\n';
        
        if (compatibility.isSafari) {
            message += '✅ 推荐使用Safari浏览器，文件上传功能最稳定\n\n';
        } else if (compatibility.isChrome) {
            message += 'ℹ️ 在Chrome中上传文件可能需要以下操作：\n';
            message += '• 点击"选择文件"后，选择"浏览"\n';
            message += '• 从"文件"App中选择音频文件\n';
            message += '• 或使用iCloud Drive中的文件\n\n';
        }
        
        message += '📱 推荐操作：\n';
        message += '• 将音频文件保存到"文件"App中\n';
        message += '• 使用Safari浏览器获得最佳体验\n';
        message += '• 如仍无法上传，可使用在线音频URL';
        
        return message;
    }
    
    return null;
}

// 改进文件选择处理
function handleFileSelection(file) {
    try {
        // 检查文件大小 (5MB)
        if (file.size > 5 * 1024 * 1024) {
            throw new Error('文件大小超过5MB限制，请选择更小的文件');
        }
        
        // 检查文件类型
        const supportedTypes = ['audio/mp3', 'audio/wav', 'audio/ogg', 'audio/mpeg', 'audio/x-m4a', 'audio/aac'];
        if (!supportedTypes.includes(file.type)) {
            throw new Error(`不支持的文件格式: ${file.type}\n支持的格式: MP3, WAV, OGG, M4A, AAC`);
        }
        
        alarmFile = file;
        const url = URL.createObjectURL(file);
        updateAudioPreview(url);
        updateAlarmStatusDisplay(true, file.name);
        return true;
    } catch (error) {
        alert(error.message);
        alarmFile = null;
        updateAlarmStatusDisplay(false);
        return false;
    }
}

// 在线音频URL加载功能
function loadAudioFromURL() {
    const urlInput = document.getElementById('audio-url-input');
    const url = urlInput.value.trim();
    const loadBtn = document.getElementById('load-audio-url');
    
    if (!url) {
        showNotification('请输入音频文件的URL', 'error');
        return;
    }
    
    // 验证URL
    if (!isValidHttpURL(url)) {
        showNotification('请输入有效的HTTP/HTTPS URL', 'error');
        return;
    }
    
    // 显示加载状态
    const originalText = loadBtn.innerHTML;
    loadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 验证URL...';
    loadBtn.disabled = true;
    
    // 分步验证URL
    validateAudioURL(url)
        .then(audioInfo => {
            loadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 加载音频...';
            return loadAudioFile(url, audioInfo);
        })
        .then(audioData => {
            // 创建虚拟文件对象
            const virtualFile = {
                name: 'online_audio.mp3',
                type: 'audio/mp3',
                size: 0,
                url: url,
                blobUrl: audioData.blobUrl
            };
            
            alarmFile = virtualFile;
            updateAudioPreview(audioData.blobUrl);
            
            loadBtn.innerHTML = originalText;
            loadBtn.disabled = false;
            
            showNotification('✅ 在线音频加载成功！', 'success');
            
        })
        .catch(error => {
            loadBtn.innerHTML = originalText;
            loadBtn.disabled = false;
            
            let errorMessage = `加载失败: ${error.message}`;
            
            // 提供具体的解决建议
            if (error.message.includes('CORS') || error.message.includes('跨域')) {
                errorMessage += '\n\n💡 解决方案：\n';
                errorMessage += '• 使用支持CORS的云存储服务\n';
                errorMessage += '• 或联系网站管理员启用CORS\n';
                errorMessage += '• 尝试其他音频文件';
            } else if (error.message.includes('404') || error.message.includes('找不到')) {
                errorMessage += '\n\n💡 解决方案：\n';
                errorMessage += '• 检查URL是否正确\n';
                errorMessage += '• 确保文件未被删除\n';
                errorMessage += '• 重新获取文件分享链接';
            }
            
            alert(errorMessage);
        });
}

// 验证URL格式
function isValidHttpURL(string) {
    try {
        const url = new URL(string);
        return url.protocol === "http:" || url.protocol === "https:";
    } catch (_) {
        return false;
    }
}

// 分步验证音频URL
function validateAudioURL(url) {
    return new Promise((resolve, reject) => {
        // 首先检查URL是否可访问
        fetch(url, { method: 'HEAD', mode: 'no-cors' })
            .then(() => {
                // 然后检查是否是音频文件
                const audio = new Audio();
                let timeoutId;
                
                audio.oncanplaythrough = () => {
                    clearTimeout(timeoutId);
                    resolve({
                        duration: audio.duration,
                        supported: true
                    });
                };
                
                audio.onerror = () => {
                    clearTimeout(timeoutId);
                    reject(new Error('URL指向的文件不是有效的音频文件'));
                };
                
                timeoutId = setTimeout(() => {
                    audio.oncanplaythrough = null;
                    audio.onerror = null;
                    reject(new Error('音频文件加载超时'));
                }, 15000);
                
                audio.src = url;
            })
            .catch(() => {
                reject(new Error('无法访问该URL，请检查网络连接和URL是否正确'));
            });
    });
}

// 加载音频文件为Blob URL
function loadAudioFile(url, audioInfo) {
    return new Promise((resolve, reject) => {
        fetch(url)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP错误: ${response.status}`);
                }
                return response.blob();
            })
            .then(blob => {
                const blobUrl = URL.createObjectURL(blob);
                resolve({
                    blob: blob,
                    blobUrl: blobUrl,
                    size: blob.size,
                    type: blob.type
                });
            })
            .catch(error => {
                reject(new Error(`下载音频文件失败: ${error.message}`));
            });
    });
}

// 测试音频URL是否可用
function testAudioURL(url) {
    return new Promise((resolve, reject) => {
        const audio = new Audio();
        let timeoutId;
        
        audio.oncanplaythrough = () => {
            clearTimeout(timeoutId);
            resolve();
        };
        
        audio.onerror = () => {
            clearTimeout(timeoutId);
            reject(new Error('无法加载音频文件'));
        };
        
        timeoutId = setTimeout(() => {
            audio.oncanplaythrough = null;
            audio.onerror = null;
            reject(new Error('加载超时'));
        }, 10000);
        
        audio.src = url;
    });
}

// 更新音频预览
function updateAudioPreview(url) {
    alarmAudioPreview.src = url;
    alarmPreview.style.display = 'block';
    
    // 临时创建音频对象用于测试
    const tempAudio = new Audio();
    tempAudio.src = url;
    tempAudio.oncanplaythrough = function() {
        alarmStatus.className = 'alarm-status active';
        alarmStatus.innerHTML = '<i class="fas fa-volume-up"></i><span>音效可用，点击保存设置</span>';
    };
    tempAudio.onerror = function() {
        alarmStatus.className = 'alarm-status inactive';
        alarmStatus.innerHTML = '<i class="fas fa-volume-mute"></i><span>音效无法播放</span>';
    };
}

// 显示上传状态
function showUploadStatus(message, type = 'info') {
    const statusElement = document.getElementById('upload-status');
    const statusText = document.getElementById('upload-status-text');
    
    const colors = {
        info: '#4b6bbe',
        success: '#28a745',
        error: '#dc3545',
        warning: '#fd9400'
    };
    
    statusElement.style.display = 'block';
    statusElement.style.backgroundColor = colors[type] + '20'; // 添加透明度
    statusElement.style.border = `1px solid ${colors[type]}`;
    statusElement.style.color = colors[type];
    
    statusText.textContent = message;
    
    // 如果是成功或错误状态，自动隐藏
    if (type === 'success' || type === 'error') {
        setTimeout(() => {
            statusElement.style.display = 'none';
        }, 5000);
    }
}

// 隐藏上传状态
function hideUploadStatus() {
    const statusElement = document.getElementById('upload-status');
    statusElement.style.display = 'none';
}

// 添加文件访问诊断功能
function diagnoseFileAccess() {
    return new Promise((resolve) => {
        const compatibility = checkDeviceCompatibility();
        const diagnostics = {
            device: compatibility,
            fileSystemAccess: false,
            userMedia: false,
            indexedDB: false,
            issues: []
        };

        // 检查文件系统访问
        if ('showOpenFilePicker' in window) {
            diagnostics.fileSystemAccess = true;
        } else {
            diagnostics.issues.push('浏览器不支持现代文件系统API');
        }

        // 检查用户媒体访问
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            diagnostics.userMedia = true;
        } else {
            diagnostics.issues.push('无法访问媒体设备');
        }

        // 检查存储支持
        if ('indexedDB' in window) {
            diagnostics.indexedDB = true;
        }

        resolve(diagnostics);
    });
}

// 显示诊断结果
function showFileAccessDiagnostics() {
    diagnoseFileAccess().then(diagnostics => {
        let message = `📱 设备诊断报告：\n\n`;
        message += `• 设备: ${diagnostics.device.isiPad ? 'iPad' : '其他设备'}\n`;
        message += `• 浏览器: ${diagnostics.device.isSafari ? 'Safari' : diagnostics.device.isChrome ? 'Chrome' : '其他'}\n`;
        message += `• 文件系统API: ${diagnostics.fileSystemAccess ? '✅ 支持' : '❌ 不支持'}\n`;
        message += `• 媒体访问: ${diagnostics.userMedia ? '✅ 支持' : '❌ 不支持'}\n`;
        
        if (diagnostics.issues.length > 0) {
            message += `\n⚠️ 检测到的问题：\n`;
            diagnostics.issues.forEach(issue => {
                message += `• ${issue}\n`;
            });
        }

        message += `\n💡 解决方案：\n`;
        message += `1. 使用Safari浏览器\n`;
        message += `2. 检查"设置 > Safari > 隐私与安全性"中的权限\n`;
        message += `3. 尝试使用在线音频URL替代文件上传`;

        alert(message);
    });
}

// 设置闹铃事件监听器
function setupAlarmEventListeners() {
    // 打开闹铃设置模态框
    alarmSettingsBtn.addEventListener('click', function() {
        ModalManager.open('alarm-settings-modal');
        // 只使用兼容性版本
        createCompatibleFileSelector();
    });
    
    // 保存闹铃设置
    saveAlarmSettings.addEventListener('click', function() {
        if (!alarmFile && !alarmAudioPreview.src) {
            alert('请先选择音频文件');
            return;
        }
        
        try {
            // 处理文件保存
            if (alarmFile) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    // 保存后立即更新状态
                    updateAlarmStatusDisplay(true, alarmFile.name || '音频文件');
                    saveAlarmDataToStorage(alarmFile, e.target.result);
                };
                reader.readAsDataURL(alarmFile);
            } else if (alarmAudioPreview.src) {
                // 处理已存在的音频
                const alarmData = {
                    name: 'audio_file',
                    type: 'audio/file',
                    size: 0,
                    url: alarmAudioPreview.src
                };
                // 保存后立即更新状态
                updateAlarmStatusDisplay(true, '音频文件');
                saveAlarmDataToStorage(alarmData, alarmAudioPreview.src);
            }
        } catch (error) {
            alert('保存设置失败: ' + error.message);
        }
    });
    
    // 清除闹铃设置
    clearAlarmBtn.addEventListener('click', clearAlarmSettings);
}

// 更新闹铃状态显示
function updateAlarmStatusDisplay(isSet = false, fileName = '') {
    const alarmStatus = document.getElementById('alarm-status');
    
    if (isSet) {
        alarmStatus.className = 'alarm-status active';
        alarmStatus.innerHTML = `<i class="fas fa-volume-up"></i><span>已设置音效文件: ${fileName}</span>`;
    } else {
        alarmStatus.className = 'alarm-status inactive';
        alarmStatus.innerHTML = '<i class="fas fa-volume-mute"></i><span>当前未设置闹铃音效，将使用浏览器通知</span>';
    }
}

// 保存闹铃数据到本地存储
function saveAlarmDataToStorage(fileInfo, dataUrl) {
    const alarmData = {
        name: fileInfo.name || 'custom_alarm',
        type: fileInfo.type || 'audio/mp3',
        size: fileInfo.size || 0,
        url: dataUrl,
        timestamp: new Date().toISOString()
    };
    
    // 保存到本地存储
    localStorage.setItem('alarmSound', JSON.stringify(alarmData));
    
    // 创建音频对象
    alarmAudio = new Audio();
    alarmAudio.src = alarmData.url;
    
    alert('闹铃音效设置成功！');
    ModalManager.close('alarm-settings-modal');
}

// 新增：测试音频播放
function testAudioPlayback(audio) {
    return new Promise((resolve) => {
        audio.oncanplaythrough = () => {
            resolve(true);
        };
        audio.onerror = () => {
            resolve(false);
        };
        
        // 设置超时
        setTimeout(() => {
            resolve(false);
        }, 5000);
    });
}
        
// 为"玩"计划设置闹铃
function setAlarmForPlayPlan(planId, plannedDuration) {
    // 只对"玩"计划设置闹铃
    const plan = plans.find(p => p.id == planId);
    if (!plan || plan.name !== '玩' || plan.subject !== 'relax') {
        return;
    }
    
    // 清除之前的闹铃
    clearAlarm(planId);
    
    // 解析计划用时
    const durationMs = parseDurationToMinutes(plannedDuration) * 60 * 1000;
    
    // 设置闹铃
    alarmTimeoutIds[planId] = setTimeout(() => {
        triggerAlarm(planId);
    }, durationMs);
}

      // 触发闹铃
function triggerAlarm(planId) {
    // 只对"玩"计划触发闹铃
    const plan = plans.find(p => p.id == planId);
    if (!plan || plan.name !== '玩' || plan.subject !== 'relax') {
        return;
    }
    
    console.log('触发闹铃，音效状态:', alarmAudio ? '已设置' : '未设置');
    
    // 播放音效
    if (alarmAudio) {
        try {
            // 停止之前的播放
            alarmAudio.pause();
            alarmAudio.currentTime = 0;
            
            // 设置播放参数
            alarmAudio.loop = true;
            alarmAudio.volume = 0.7; // 设置音量
            
            // 尝试播放
            const playPromise = alarmAudio.play();
            
            if (playPromise !== undefined) {
                playPromise.then(() => {
                    console.log('音效播放成功');
                }).catch(error => {
                    console.error('播放闹铃音效失败:', error);
                    showBrowserNotification();
                });
            }
        } catch (e) {
            console.error('播放闹铃音效失败:', e);
            showBrowserNotification();
        }
    } else {
        console.log('未设置音效，使用浏览器通知');
        showBrowserNotification();
    }
    
    // 标记闹铃状态
    plan.alarmRinging = true;
}

// 检查音效状态
function checkAlarmStatus() {
    const savedAlarmData = localStorage.getItem('alarmSound');
    if (savedAlarmData) {
        try {
            const alarmData = JSON.parse(savedAlarmData);
            console.log('当前音效设置:', {
                name: alarmData.name,
                type: alarmData.type,
                size: alarmData.size,
                timestamp: alarmData.timestamp
            });
            return true;
        } catch (e) {
            console.error('音效数据损坏:', e);
            return false;
        }
    } else {
        console.log('未设置音效');
        return false;
    }
}

// 新增：清除音效设置
function clearAlarmSettings() {
    if (confirm('确定要清除当前的闹铃音效设置吗？')) {
        localStorage.removeItem('alarmSound');
        alarmAudio = null;
        alarmFile = null;
        if (alarmAudioPreview) {
            alarmAudioPreview.src = '';
            alarmPreview.style.display = 'none';
        }
        updateAlarmStatusDisplay(false);
        alert('音效设置已清除');
    }
}
        
        // 清除闹铃
function clearAlarm(planId) {
    // 清除超时
    if (alarmTimeoutIds[planId]) {
        clearTimeout(alarmTimeoutIds[planId]);
        delete alarmTimeoutIds[planId];
    }
    
    // 停止音效
    if (alarmAudio) {
        alarmAudio.pause();
        alarmAudio.currentTime = 0;
    }
    
    // 更新计划状态
    const plan = plans.find(p => p.id == planId);
    if (plan) {
        plan.alarmRinging = false;
    }
}
        
        // 显示浏览器通知
function showBrowserNotification() {
    // 检查浏览器通知权限
    if (!("Notification" in window)) {
        console.log("此浏览器不支持通知");
        return;
    }
    
    // 请求通知权限
    if (Notification.permission === "default") {
        Notification.requestPermission().then(permission => {
            if (permission === "granted") {
                createNotification();
            }
        });
    } else if (Notification.permission === "granted") {
        createNotification();
    }
}
        
        // 创建通知
     function createNotification() {
    const notification = new Notification("学习计划提醒", {
        body: "您的'玩'计划时间已用完，请及时结束计时",
        icon: "/favicon.ico",
        tag: "play-plan-alarm"
    });
    
    // 点击通知时关闭
    notification.onclick = function() {
        window.focus();
        notification.close();
    };
    
    // 自动关闭通知
    setTimeout(() => {
        notification.close();
    }, 5000);
}

// 通用日历渲染函数
function renderGenericCalendar(containerId, selectedDate, onDateClick, options = {}) {
    const container = document.getElementById(containerId);
    if (!container) return;

    container.innerHTML = '';

    const year = selectedDate.getFullYear();
    const month = selectedDate.getMonth();

    // 添加星期头部
    const weekdays = ['日', '一', '二', '三', '四', '五', '六'];
    for (let i = 0; i < 7; i++) {
        const weekdayElement = document.createElement('div');
        weekdayElement.className = 'calendar-weekday';
        weekdayElement.textContent = weekdays[i];
        container.appendChild(weekdayElement);
    }

    // 获取当月第一天是星期几
    const firstDay = new Date(year, month, 1);
    const firstDayWeekday = firstDay.getDay();

    // 获取当月天数
    const daysInMonth = new Date(year, month + 1, 0).getDate();

    // 填充空白
    for (let i = 0; i < firstDayWeekday; i++) {
        const emptyElement = document.createElement('div');
        emptyElement.className = 'calendar-day-year other-month';
        container.appendChild(emptyElement);
    }

    // 填充日期
    for (let day = 1; day <= daysInMonth; day++) {
        const dayElement = document.createElement('div');
        dayElement.className = 'calendar-day-year';
        dayElement.textContent = day;

        // 检查是否是今天
        const todayMidnight = new Date();
        todayMidnight.setHours(0, 0, 0, 0);
        const currentDate = new Date(year, month, day);
        currentDate.setHours(0, 0, 0, 0);

        if (currentDate.getTime() === todayMidnight.getTime()) {
            dayElement.classList.add('today');
        }

        // 检查是否是选中的日期
        if (options.selectedDate) {
            const selectedDateMidnight = new Date(options.selectedDate);
            selectedDateMidnight.setHours(0, 0, 0, 0);

            if (currentDate.getTime() === selectedDateMidnight.getTime()) {
                dayElement.classList.add('selected');
            }
        }

        // 添加点击事件
        dayElement.addEventListener('click', function() {
            const clickedDate = new Date(year, month, day);
            onDateClick(clickedDate);
        });

        container.appendChild(dayElement);
    }
}

        // 设置事件监听器
        function setupEventListeners() {

            // 打开添加计划模态框
            addPlanBtn.addEventListener('click', function() {
                ModalManager.open('add-plan-modal');
           });

            // 打开批量添加模态框
            batchAddBtn.addEventListener('click', function() {
                ModalManager.open('batch-add-modal');
           });

            // 数据管理按钮
            backupBtn.addEventListener('click', function() {
                backupData();
            });

            importBtn.addEventListener('click', function() {
                ModalManager.open('import-modal');
            });

            clearBtn.addEventListener('click', function() {
                ModalManager.open('clear-confirm-modal');
            });

            // 清空数据确认按钮
            document.getElementById('confirm-clear').addEventListener('click', function() {
                clearAllPlans();
                ModalManager.close('clear-confirm-modal');
            });

            // 打开重要任务提醒模态框
            document.getElementById('important-tasks-btn').addEventListener('click', function() {
                ModalManager.open('important-tasks-modal');
            });

            // 打开全年日历
            fullCalendarBtn.addEventListener('click', function() {
                selectedCalendarDate = new Date(selectedDate);
                renderFullCalendar(selectedCalendarDate);
                ModalManager.open('full-calendar-modal');
            });

            // 打开计划用时筛选日历
            planActualDateInput.addEventListener('click', function() {
                selectedPlanActualCalendarDate = new Date(selectedPlanActualDate);
                renderPlanActualCalendar(selectedPlanActualCalendarDate);
                ModalManager.open('plan-actual-calendar-modal');
            });

            // 打开统计图表日期筛选日历
            document.getElementById('start-date').addEventListener('click', function() {
                currentStatsDateSelection = 'start';
                selectedStatsCalendarDate = new Date(selectedStatsStartDate);
                renderStatsDateCalendar(selectedStatsCalendarDate);
                ModalManager.open('stats-date-calendar-modal');
            });

            document.getElementById('end-date').addEventListener('click', function() {
                currentStatsDateSelection = 'end';
                selectedStatsCalendarDate = new Date(selectedStatsEndDate);
                renderStatsDateCalendar(selectedStatsCalendarDate);
                ModalManager.open('stats-date-calendar-modal');
            });

            // 详情页面返回按钮
            backBtn.addEventListener('click', function() {
                detailModal.style.display = 'none';
                currentDetailPlanId = null;
            });

            // 统计详情页返回按钮
            statsBackBtn.addEventListener('click', function() {
                statsDetailModal.style.display = 'none';
            });

            // 添加勋章按钮
            addHonorBtn.addEventListener('click', function() {
                ModalManager.open('add-honor-modal');
            });

            // 添加兑换清单按钮
            addWishBtn.addEventListener('click', function() {
                ModalManager.open('add-wish-modal');
            });

            // 周导航 - 一周一周滚动
            prevWeekBtn.addEventListener('click', function() {
                currentWeekOffset--;
                renderCalendar();
                updateWeekTitle();
            });

            nextWeekBtn.addEventListener('click', function() {
                currentWeekOffset++;
                renderCalendar();
                updateWeekTitle();
            });

            // 今天按钮点击事件 - 跳转到今天
            todayBtn.addEventListener('click', function() {
                currentWeekOffset = 0;
                selectedDate = new Date();
                renderCalendar();
                updateWeekTitle();
                renderPlans();
                updateStats();
            });

            // 全年日历导航
            prevYearBtn.addEventListener('click', function() {
                selectedCalendarDate.setMonth(selectedCalendarDate.getMonth() - 1);
                renderFullCalendar(selectedCalendarDate);
            });

            nextYearBtn.addEventListener('click', function() {
                selectedCalendarDate.setMonth(selectedCalendarDate.getMonth() + 1);
                renderFullCalendar(selectedCalendarDate);
            });

            // 确认选择日期
            confirmFullCalendar.addEventListener('click', function() {
                if (selectedCalendarDate) {
                    selectedDate = new Date(selectedCalendarDate);
                    
                       // 计算选中日期所在的周偏移
                       const today = new Date();
                       const startOfThisWeek = getStartOfWeek(today);
                       const startOfSelectedWeek = getStartOfWeek(selectedDate);
                       const diffTime = startOfSelectedWeek - startOfThisWeek;
                       const diffWeeks = Math.floor(diffTime / (7 * 24 * 60 * 60 * 1000));
                    
                       currentWeekOffset = diffWeeks;
                       renderCalendar();
                       updateWeekTitle();
                       renderPlans();
                       updateStats();
                    
                       ModalManager.close('full-calendar-modal');
                }
            });

            // 详情页面计时器控制
            detailStartBtn.addEventListener('click', function() {
                   // 如果已经有计时器在运行，且不是当前详情页面显示的计划
                   if (currentRunningTimer && currentRunningTimer !== currentDetailPlanId) {
                       alert('请先完成当前正在进行的计划，再开始新的计划');
                       return;
                   }
            
                   if (currentDetailPlanId) {
                    const planIndex = plans.findIndex(p => p.id == currentDetailPlanId);
                    if (planIndex === -1) return;
        
                    const plan = plans[planIndex];
        
                       // 检查计划是否是在其他日期创建的，并且是第一次开始计时
                       const planDate = new Date(plan.createdAt);
                       const today = new Date();
                       planDate.setHours(0, 0, 0, 0);
                       today.setHours(0, 0, 0, 0);
        
                       // 如果计划不是今天创建的，且还没有实际开始时间（即第一次开始计时），且是单次计划
                       if (planDate.getTime() !== today.getTime() && !plan.actualStartTime && plan.repeat === 'once') {
                            // 自动将计划移动到今天
                            plan.createdAt = today.toISOString();
            
                            // 保存到本地存储
                            localStorage.setItem('studyPlans', JSON.stringify(plans));
            
                            // 重新渲染计划和更新统计
                            renderPlans();
                            updateStats();
            
                            // 关闭详情页面
                            detailModal.style.display = 'none';
                            currentDetailPlanId = null;
            
                            // 提示用户
                            showNotification(`计划 "${plan.name}" 已自动移动到今天`);
                            return;
                       }
        
                       toggleTimer(currentDetailPlanId);
                       }
            });

            // 详情页面编辑和删除按钮
            document.getElementById('edit-btn').addEventListener('click', function() {
                if (currentDetailPlanId) {
                    openEditModal(currentDetailPlanId);
                }
            });

            document.getElementById('delete-btn').addEventListener('click', function() {
                if (confirm('确定要删除这个计划吗？')) {
                    if (currentDetailPlanId) {
                        const planIndex = plans.findIndex(p => p.id == currentDetailPlanId);
                        if (planIndex !== -1) {
                            // 停止计时器
                            if (timers[currentDetailPlanId]) {
                                clearInterval(timers[currentDetailPlanId]);
                                delete timers[currentDetailPlanId];
                            }
                            
                            plans.splice(planIndex, 1);
                            localStorage.setItem('studyPlans', JSON.stringify(plans));
                            renderPlans();
                            updateStats();
                            detailModal.style.display = 'none';
                            currentDetailPlanId = null;
                        }
                    }
                }
            });

            // 表单提交
            document.getElementById('add-plan-form').addEventListener('submit', function(e) {
                e.preventDefault();
                savePlan();
            });

            document.getElementById('batch-add-form').addEventListener('submit', function(e) {
                e.preventDefault();
                batchAddPlans();
            });

            document.getElementById('import-form').addEventListener('submit', function(e) {
                e.preventDefault();

                if (document.getElementById('file-import-section').style.display !== 'none') {
                    importDataFromFile();
                } else {
                    importDataFromText();
                }
            });

            document.getElementById('edit-plan-form').addEventListener('submit', function(e) {
                e.preventDefault();
                saveEditedPlan();
            });

            // 下载备份
            document.getElementById('download-backup').addEventListener('click', function() {
                downloadBackup();
            });

            // 在这里添加统计图表相关的事件监听器
            statsChartCard.addEventListener('click', function() {
                openStatsDetailModal();
            });

           // 筛选按钮事件
            document.querySelector('.filter-btn').addEventListener('click', function() {
                    // 这里可以添加日期选择器功能，暂时使用默认日期范围
                     const endDate = new Date();
                     const startDate = new Date();
                     startDate.setDate(startDate.getDate() - 14);
        
                    renderStatsCharts(startDate, endDate);
           });
    
        // 计划用时筛选日历导航
        planActualPrevYearBtn.addEventListener('click', function() {
            selectedPlanActualCalendarDate.setMonth(selectedPlanActualCalendarDate.getMonth() - 1);
            renderPlanActualCalendar(selectedPlanActualCalendarDate);
        });
        
        planActualNextYearBtn.addEventListener('click', function() {
            selectedPlanActualCalendarDate.setMonth(selectedPlanActualCalendarDate.getMonth() + 1);
            renderPlanActualCalendar(selectedPlanActualCalendarDate);
        });

        // 计划用时筛选按钮
        planActualFilterBtn.addEventListener('click', function() {
            console.log('筛选按钮被点击，日期:', formatDateForDisplay(selectedPlanActualDate)); // 调试信息
    
        // 确保图表容器存在且正确初始化
        const chartElement = document.getElementById('plan-vs-actual-chart');
        if (chartElement) {
            // 销毁现有图表实例
            if (window.planVsActualChart) {
                window.planVsActualChart.dispose();
            }
        
            // 重新渲染图表
            setTimeout(() => {
                window.planVsActualChart = renderPlanVsActualChart();
            }, 100);
        }
    });
     
        // 确认选择日期 - 计划用时筛选
   confirmPlanActualCalendar.addEventListener('click', function() {
    if (selectedPlanActualCalendarDate) {
        selectedPlanActualDate = new Date(selectedPlanActualCalendarDate);
        planActualDateDisplay.textContent = formatDateForDisplay(selectedPlanActualDate);
        ModalManager.close('plan-actual-calendar-modal');
        
        console.log('日历确认，新日期:', formatDateForDisplay(selectedPlanActualDate)); // 调试信息
        
        // 确保图表容器存在且正确初始化
        const chartElement = document.getElementById('plan-vs-actual-chart');
        if (chartElement) {
            // 销毁现有图表实例
            if (window.planVsActualChart) {
                window.planVsActualChart.dispose();
            }
            
            // 重新渲染图表
            setTimeout(() => {
                window.planVsActualChart = renderPlanVsActualChart();
            }, 100);
        }
    }
});
                        
        // 统计图表日期筛选日历导航
        statsDatePrevYearBtn.addEventListener('click', function() {
            selectedStatsCalendarDate.setMonth(selectedStatsCalendarDate.getMonth() - 1);
            renderStatsDateCalendar(selectedStatsCalendarDate);
        });
        
        statsDateNextYearBtn.addEventListener('click', function() {
            selectedStatsCalendarDate.setMonth(selectedStatsCalendarDate.getMonth() + 1);
            renderStatsDateCalendar(selectedStatsCalendarDate);
        });
        
        // 确认选择日期 - 统计图表日期筛选
        confirmStatsDateCalendar.addEventListener('click', function() {
            if (selectedStatsCalendarDate) {
                if (currentStatsDateSelection === 'start') {
                    selectedStatsStartDate = new Date(selectedStatsCalendarDate);
                } else if (currentStatsDateSelection === 'end') {
                    selectedStatsEndDate = new Date(selectedStatsCalendarDate);
                }
                updateStatsDateDisplay();
                ModalManager.close('stats-date-calendar-modal');
                
                // 重新渲染统计图表
                renderStatsCharts(selectedStatsStartDate, selectedStatsEndDate);
            }
        });
              
            // 统计图表筛选按钮事件
            statsFilterBtn.addEventListener('click', function() {
                 renderStatsCharts(selectedStatsStartDate, selectedStatsEndDate);
            });

            // 添加重要任务
            document.getElementById('add-important-task').addEventListener('click', function() {
                 addImportantTask();
            });

            // 清空所有重要任务
            document.getElementById('clear-all-tasks-btn').addEventListener('click', function() {
                 if (confirm('确定要清空所有重要任务吗？此操作不可撤销！')) {
                 importantTasks = [];
                 localStorage.setItem('importantTasks', JSON.stringify(importantTasks));
                 renderImportantTasks();
                 showNotification('已清空所有重要任务');
                 }
            });

            // 导入数据方式切换
            document.getElementById('import-paste-btn').addEventListener('click', function() {
            document.getElementById('paste-import-section').style.display = 'block';
            document.getElementById('file-import-section').style.display = 'none';
            });

            document.getElementById('import-file-btn').addEventListener('click', function() {
            document.getElementById('paste-import-section').style.display = 'none';
            document.getElementById('file-import-section').style.display = 'block';
            });

            // 触发文件上传
            document.getElementById('trigger-file-upload').addEventListener('click', function() {
            document.getElementById('data-file-import').click();
            });

            // 文件选择后显示文件名
            document.getElementById('data-file-import').addEventListener('change', function(e) {
            const fileName = e.target.files[0] ? e.target.files[0].name : '未选择文件';
            document.getElementById('file-name').textContent = fileName;
            });

            // 排序按钮事件监听
            document.getElementById('sort-plans-btn').addEventListener('click', function() {
                 toggleSortOrder();
            });

            // 设置闹铃事件监听器
            setupAlarmEventListeners();
    }

// 创建兼容的文件选择器
function createCompatibleFileSelector() {
    const fileUploadArea = document.querySelector('.alarm-file-upload');
    
    // 清除现有内容
    fileUploadArea.innerHTML = '';
    
   const uploadOptionsHTML = `
        <div style="text-align: center;">
            <!-- 文件输入 -->
            <div style="margin-bottom: 20px; padding: 15px; border: 2px dashed #4b6bbe; border-radius: 8px;">
                <button type="button" class="btn btn-save" id="improved-select-file" 
                        style="padding: 12px 24px; font-size: 16px; margin: 10px auto; display: block;">
                    <i class="fas fa-upload"></i> 选择音频文件
                </button>
                <input type="file" id="alarm-file-input" 
                       accept=".mp3,.wav,.ogg,.m4a,.aac,audio/*" 
                       style="display: none;">
                <p style="color: #666; font-size: 12px; margin: 5px 0;">
                    支持格式: MP3, WAV, OGG, M4A, AAC，文件大小不超过5MB
                </p>
            </div>
        </div>
    `;
    
    fileUploadArea.innerHTML = uploadOptionsHTML;
    
    // 设置事件监听
    setupCompatibleFileEvents();
}

// 设置兼容的文件事件
function setupCompatibleFileEvents() {
    const fileInput = document.getElementById('alarm-file-input');
    const selectFileBtn = document.getElementById('improved-select-file');
    
    // 文件选择按钮点击事件
    selectFileBtn.addEventListener('click', function() {
        fileInput.click();
    });
    
    // 文件输入变化事件
    fileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            handleFileSelection(file);
        }
    });
}

// 时区数据迁移函数 - 修正版
function migrateTimezoneData() {
    let needsMigration = false;
    
    // 检查计划数据是否需要迁移
    plans.forEach(plan => {
        if (plan.createdAt && plan.createdAt.includes('T')) {
            // 如果日期包含时间部分（ISO格式），需要迁移
            const date = new Date(plan.createdAt);
            
            // 直接使用本地日期组件，避免时区转换
            plan.createdAt = formatDateForDisplay(date);
            needsMigration = true;
            
            console.log('迁移计划日期:', plan.createdAt, '从:', plan.name);
        }
    });
    
    // 检查打卡数据是否需要迁移
    checkins.forEach(checkin => {
        if (checkin.date && checkin.date.includes('T')) {
            const date = new Date(checkin.date);
            
            // 直接使用本地日期组件
            checkin.date = formatDateForDisplay(date);
            needsMigration = true;
            
            console.log('迁移打卡日期:', checkin.date);
        }
    });
    
    // 如果需要迁移，保存数据
    if (needsMigration) {
        localStorage.setItem('studyPlans', JSON.stringify(plans));
        localStorage.setItem('studyCheckins', JSON.stringify(checkins));
        console.log('时区数据迁移完成，迁移了', 
                   plans.filter(p => p.createdAt && !p.createdAt.includes('T')).length, 
                   '个计划');
    }
}

// 添加排序功能函数
function toggleSortOrder() {
    // 切换排序状态
    currentSortOrder = currentSortOrder === 'default' ? 'custom' : 'default';
    
    // 重新渲染计划列表
    renderPlans();
    
    // 更新按钮视觉状态
    const sortBtn = document.getElementById('sort-plans-btn');
    if (currentSortOrder === 'custom') {
        sortBtn.classList.add('active');
        sortBtn.title = '切换为默认排序';
    } else {
        sortBtn.classList.remove('active');
        sortBtn.title = '按实际开始时间排序';
    }
}

    // 渲染统计图表日期筛选日历
    function renderStatsDateCalendar(date) {
    // 更新标题
    statsDateCalendarMonthYear.textContent = `${date.getFullYear()}年${date.getMonth() + 1}月`;

    renderGenericCalendar(
        'stats-date-calendar-grid-year',
        date,
        function(clickedDate) {
            selectedStatsCalendarDate = clickedDate;
            renderStatsDateCalendar(date);
        },
        { selectedDate: selectedStatsCalendarDate }
    );
}

    // 更新统计图表日期显示
    function updateStatsDateDisplay() {
        document.getElementById('start-date-display').textContent = formatDateForDisplay(selectedStatsStartDate);
        document.getElementById('end-date-display').textContent = formatDateForDisplay(selectedStatsEndDate);
    }

    // 打开统计图表详情页
   function openStatsDetailModal() {
    // 设置默认日期范围（最近15天）
    selectedStatsEndDate = new Date();
    selectedStatsStartDate = new Date();
    selectedStatsStartDate.setDate(selectedStatsStartDate.getDate() - 14);
    
    // 设置计划用时筛选默认日期为今天
    selectedPlanActualDate = new Date();
    planActualDateDisplay.textContent = formatDateForDisplay(selectedPlanActualDate);
    
    // 更新日期显示
    updateStatsDateDisplay();
    
    // 显示详情页
    statsDetailModal.style.display = 'block';
    
    // 延迟渲染所有图表，确保DOM已完全加载
    setTimeout(() => {
        // 销毁现有图表实例
        if (window.planVsActualChart) {
            window.planVsActualChart.dispose();
        }
        
        // 渲染所有图表
        renderStatsCharts(selectedStatsStartDate, selectedStatsEndDate);
    }, 300);
}

    // 渲染统计图表
   function renderStatsCharts(startDate, endDate) {
    // 获取日期范围内的数据
    const statsData = getStatsData(startDate, endDate);

    // 渲染每日计划完成情况
    window.completionChart = renderCompletionChart(statsData);

    // 渲染时间对比图表
    window.timeComparisonChart = renderTimeComparisonChart(statsData);

    // 渲染分类用时占比
    window.categoryPieChart = renderCategoryPieChart(statsData);

    // 渲染计划用时与实际时间对比 - 确保正确初始化
    if (window.planVsActualChart) {
        window.planVsActualChart.dispose();
    }
    window.planVsActualChart = renderPlanVsActualChart();
}

    // 获取统计数据
    function getStatsData(startDate, endDate) {
     const result = {
        dates: [],
        completionData: [],
        timeData: {
            study: [],
            sports: [],
            relax: []
        },
        categoryData: {},
        planComparisonData: []
    };

    // 生成日期范围（使用本地时间）
    const currentDate = new Date(startDate);
    currentDate.setHours(0, 0, 0, 0);
    
    const endDateMidnight = new Date(endDate);
    endDateMidnight.setHours(0, 0, 0, 0);
    
    while (currentDate <= endDateMidnight) {
        const dateStr = formatDateForDisplay(currentDate);
        result.dates.push(formatDateForDisplay(currentDate));

        // 获取该日期的计划
        const datePlans = plans.filter(plan => {
            const planDateStr = plan.createdAt; // 现在 createdAT 已经是格式化的本地日期
            return planDateStr === dateStr;
        });

        // 计算完成率
        const completedPlans = datePlans.filter(plan => plan.completed);
        const completionRate = datePlans.length > 0 ? 
            Math.round((completedPlans.length / datePlans.length) * 100) : 0;

        result.completionData.push({
            total: datePlans.length,
            completed: completedPlans.length,
            rate: completionRate
        });

        // 计算各类时间
        let studyTime = 0;
        let sportsTime = 0;
        let relaxTime = 0;

        completedPlans.forEach(plan => {
            const durationHours = (plan.totalDuration || 0) / (1000 * 60 * 60); // 转换为小时

            if (plan.subject === 'sports') {
                sportsTime += durationHours;
            } else if (plan.subject === 'relax') {
                relaxTime += durationHours;
            } else {
                studyTime += durationHours;
            }

            // 统计分类数据
            const subjectName = getSubjectText(plan.subject);
            if (!result.categoryData[subjectName]) {
                result.categoryData[subjectName] = 0;
            }
            result.categoryData[subjectName] += durationHours;
        });

        result.timeData.study.push(studyTime);
        result.timeData.sports.push(sportsTime);
        result.timeData.relax.push(relaxTime);

        // 为最后一天生成计划对比数据 - 使用新的解析函数
        if (currentDate.getTime() === endDate.getTime()) {
            datePlans.forEach(plan => {
                const plannedDuration = parseDurationToMinutes(plan.plannedDuration || '30min');
                const actualDuration = plan.completed ? (plan.totalDuration || 0) / (1000 * 60) : 0; // 分钟

                result.planComparisonData.push({
                    name: plan.name,
                    planned: plannedDuration,
                    actual: actualDuration
                });
            });
        }

        currentDate.setDate(currentDate.getDate() + 1);
    }

    return result;
}

// 新增：将计划用时转换为小时的函数
function parseDurationToHours(durationStr) {
    if (!durationStr) return 0.5; // 默认30分钟 = 0.5小时
    
    // 处理 "60min" 格式
    const minMatch = durationStr.match(/(\d+)\s*min/);
    if (minMatch) {
        return parseInt(minMatch[1]) / 60;
    }
    
    // 处理 "1h" 或 "1小时" 格式
    const hourMatch = durationStr.match(/(\d+)\s*h/);
    if (hourMatch) {
        return parseInt(hourMatch[1]);
    }
    
    // 处理 "1h30min" 格式
    const combinedMatch = durationStr.match(/(\d+)\s*h\s*(\d+)\s*min/);
    if (combinedMatch) {
        return parseInt(combinedMatch[1]) + (parseInt(combinedMatch[2]) / 60);
    }
    
    // 处理纯数字，假设为分钟
    const numberMatch = durationStr.match(/(\d+)/);
    if (numberMatch) {
        return parseInt(numberMatch[1]) / 60;
    }
    
    return 0.5; // 默认30分钟 = 0.5小时
}

    // 新增一个专门的函数来解析持续时间到分钟
function parseDurationToMinutes(durationStr) {
    if (!durationStr) return 30; // 默认30分钟
    
    // 处理 "60min" 格式
    const minMatch = durationStr.match(/(\d+)\s*min/);
    if (minMatch) {
        return parseInt(minMatch[1]);
    }
    
    // 处理 "1h" 或 "1小时" 格式
    const hourMatch = durationStr.match(/(\d+)\s*h/);
    if (hourMatch) {
        return parseInt(hourMatch[1]) * 60;
    }
    
    // 处理 "1h30min" 格式
    const combinedMatch = durationStr.match(/(\d+)\s*h\s*(\d+)\s*min/);
    if (combinedMatch) {
        return parseInt(combinedMatch[1]) * 60 + parseInt(combinedMatch[2]);
    }
    
    // 处理纯数字，假设为分钟
    const numberMatch = durationStr.match(/(\d+)/);
    if (numberMatch) {
        return parseInt(numberMatch[1]);
    }
    
    return 30; // 默认30分钟
}

    // 渲染每日计划完成情况图表
    function renderCompletionChart(statsData) {
        const chart = echarts.init(document.getElementById('completion-chart'));
        
        const option = {
            title: {
                text: '每日计划完成情况',
                textStyle: {
                    color: '#4b6bbe',
                    fontSize: 18,
                    fontWeight: 'bold'
                },
               left: 'center',
               top: '0px'
            },
        grid: {
            top: '90px', // 图表区域顶部间距
            bottom: '60px', // 图表区域底部间距
            left: '30px', // 图表区域左侧间距
            right: '30px' // 图表区域右侧间距
        },
            tooltip: {
                trigger: 'axis',
                formatter: function(params) {
                    const data = statsData.completionData[params[0].dataIndex];
                    return `${params[0].name}<br/>
                            计划数量: ${data.total}<br/>
                            完成数量: ${data.completed}<br/>
                            完成率: ${data.rate}%`;
                }
            },
            legend: {
                data: ['计划数量', '完成数量'],
                top: '10%',
                textStyle: {
                    fontSize: 15,
                    fontWeight: 'bold'
                }
            },
            xAxis: {
                type: 'category',
                data: statsData.dates,
                axisLabel: {
                    rotate: 0,
                formatter: function(value) {
                    // 只显示月日格式，例如 "10/01"
                    const parts = value.split('/');
                    if (parts.length >= 2) {
                        return `${parts[1]}/${parts[2]}`; // 月/日
                    }
                    return value;
                }
                }
            },
            yAxis: {
                type: 'value',
                name: '数量'
            },
            series: [
                {
                    name: '计划数量',
                    type: 'bar',
                    data: statsData.completionData.map(d => d.total),
                    itemStyle: {
                        color: '#4b6bbe'
                    }
                },
                {
                    name: '完成数量',
                    type: 'bar',
                    data: statsData.completionData.map(d => d.completed),
                    itemStyle: {
                        color: '#28a745'
                    }
                }
            ]
        };
        
        chart.setOption(option);

setTimeout(() => {
        chart.resize();
    }, 0);
    
    return chart; 
    }

    // 渲染时间对比图表
    function renderTimeComparisonChart(statsData) {
        const chart = echarts.init(document.getElementById('time-comparison-chart'));
        
        const option = {
            title: {
                text: '每日学习时间 VS 运动时间 VS 娱乐时间',
                textStyle: {
                    color: '#4b6bbe',
                    fontSize: 18,
                    fontWeight: 'bold'
                },
                left: 'center'
            },
grid: {
            top: '90px', // 图表区域顶部间距
            bottom: '60px', // 图表区域底部间距
            left: '30px', // 图表区域左侧间距
            right: '30px' // 图表区域右侧间距
        },
            tooltip: {
                trigger: 'axis'
            },
            legend: {
                data: ['学习时间(小时)', '运动时间(小时)', '娱乐时间(小时)'],
                top: '10%',
                textStyle: {
                    fontSize: 15,
                    fontWeight: 'bold'
                }
            },
            xAxis: {
                type: 'category',
                data: statsData.dates,
                axisLabel: {
                    rotate: 0,
                formatter: function(value) {
                    // 只显示月日格式，例如 "10/01"
                    const parts = value.split('/');
                    if (parts.length >= 2) {
                        return `${parts[1]}/${parts[2]}`; // 月/日
                    }
                    return value;
                }
                }
            },
            yAxis: {
                type: 'value',
                name: '小时',
axisLabel: {
    formatter: function(value) {
        // 如果是整数，直接显示；如果是小数，保留一位小数
        if (Number.isInteger(value)) {
            return value.toString();
        } else {
            return value.toFixed(1);
        }
    }
}
            },
            series: [
                {
                    name: '学习时间(小时)',
                    type: 'bar',
                    data: statsData.timeData.study,
                    itemStyle: {
                        color: '#4b6bbe'
                    }
                },
                {
                    name: '运动时间(小时)',
                    type: 'bar',
                    data: statsData.timeData.sports,
                    itemStyle: {
                        color: '#28a745'
                    }
                },
                {
                    name: '娱乐时间(小时)',
                    type: 'bar',
                    data: statsData.timeData.relax,
                    itemStyle: {
                        color: '#e1443b'
                    }
                }
            ]
        };
        
        chart.setOption(option);

setTimeout(() => {
        chart.resize();
    }, 0);
    
    return chart; 
    }

    // 渲染分类饼图
    function renderCategoryPieChart(statsData) {
        const chart = echarts.init(document.getElementById('category-pie-chart'));
        
        const subjectColors = {
            '英语': '#c690ce',
            '语文': '#99ddae', 
            '数学': '#f79d82',
            '运动': '#6ac9e0',
            '放松': '#ff5252',
            '技能': '#debbb3',
             '日常': '#D5E3B7',
            '其他': '#5f7ebe'
        };
        
        const pieData = Object.entries(statsData.categoryData)
            .filter(([_, value]) => value > 0)
            .map(([name, value]) => ({
                name,
                value: parseFloat(value.toFixed(2)),
                itemStyle: {
                    color: subjectColors[name] || '#5f7ebe'
                }
            }));
        
        const option = {
            title: {
                text: '分类总用时占比',
                textStyle: {
                    color: '#4b6bbe',
                    fontSize: 18,
                    fontWeight: 'bold'
                },
                left: 'center'
            },
            tooltip: {
                trigger: 'item',
                formatter: '{a} <br/>{b}: {c}小时 ({d}%)'
            },
            legend: {
                type: 'scroll',
                orient: 'vertical',
                right: 50,
                top: 'middle',
                textStyle: {
                    fontSize: 15
                }
            },
            series: [
                {
                    name: '用时占比',
                    type: 'pie',
                    radius: ['40%', '70%'],
                    center: ['40%', '50%'],
                    data: pieData,
                   label: {
                    show: true,
                    position: 'inside', // 将标签显示在饼图内部
                    formatter: '{d}%', // 只显示百分比
                    fontSize: 13,
                    fontWeight: 'bold',
                    color: '#fff', // 白色文字，确保在深色背景上可见
                    textShadow: '0 1px 2px rgba(0,0,0,0.5)' // 添加文字阴影增强可读性
                },
                // 移除标签引导线，因为现在标签在内部
                labelLine: {
                    show: false
                },
                emphasis: {
                    label: {
                        show: true,
                        fontSize: 16,
                        fontWeight: 'bold'
                    },
                    itemStyle: {
                        shadowBlur: 10,
                        shadowOffsetX: 0,
                        shadowColor: 'rgba(0, 0, 0, 0.5)'
                    }
                }
            }
        ]
    };
        
        chart.setOption(option);

setTimeout(() => {
        chart.resize();
    }, 0);
    
    return chart; 
    }

    // 渲染计划用时与实际时间对比
  function renderPlanVsActualChart() {
        const chart = echarts.init(document.getElementById('plan-vs-actual-chart'));
    
    // 获取选中日期的已完成计划，使用本地日期格式
    const selectedDateStr = formatDateForDisplay(selectedPlanActualDate);
    
    console.log('筛选日期:', selectedDateStr);
    
    const datePlans = plans.filter(plan => {
        const planDateStr = plan.createdAt; // 直接使用存储的本地日期
        console.log('计划日期:', planDateStr, '计划名称:', plan.name, '完成状态:', plan.completed);
        return planDateStr === selectedDateStr && plan.completed;
    });
    
    console.log('筛选到的计划数量:', datePlans.length); // 调试信息

    // 如果当天没有已完成的计划，显示提示信息
    if (datePlans.length === 0) {
        const option = {
            title: {
                text: `计划用时与实际时间对比 - ${formatDateForDisplay(selectedPlanActualDate)}`,
                textStyle: {
                    color: '#4b6bbe',
                    fontSize: 18,
                    fontWeight: 'bold'
                },
                left: 'center'
            },
            graphic: {
                type: 'text',
                left: 'center',
                top: 'middle',
                style: {
                    text: '当天没有已完成的计划',
                    fontSize: 16,
                    fill: '#999'
                }
            }
        };
        
        chart.setOption(option);
        setTimeout(() => { chart.resize(); }, 0);
        return chart;
    }

    // 直接使用过滤后的计划数组，保持原有顺序
    const planComparisonData = datePlans.map(plan => {
        // 修复计划用时解析 - 确保正确解析分钟数
        const plannedDuration = parseDurationToMinutes(plan.plannedDuration || '30min');
        
        // 修复实际用时计算 - 将毫秒转换为分钟
        const actualDuration = plan.completed ? (plan.totalDuration || 0) / (1000 * 60) : 0; // 毫秒转分钟
        
        console.log('计划数据:', plan.name, '计划用时:', plannedDuration, '实际用时:', actualDuration); // 调试信息
        
        return {
            name: plan.name,
            planned: plannedDuration,
            actual: actualDuration
        };
    });

    const option = {
        title: {
            text: `计划用时与实际时间对比 - ${formatDateForDisplay(selectedPlanActualDate)}`,
            textStyle: {
                color: '#4b6bbe',
                fontSize: 18,
                fontWeight: 'bold'
            },
            left: 'center'
        },
        grid: {
            top: '90px',
            bottom: '60px',
            left: '30px', 
            right: '30px'
        },
        tooltip: {
            trigger: 'axis',
            formatter: function(params) {
                const plannedData = params[0];
                const actualData = params[1];
                return `
                    ${plannedData.name}<br/>
                    计划时间: ${plannedData.value}分钟<br/>
                    实际时间: ${actualData.value}分钟<br/>
                    差值: ${(actualData.value - plannedData.value).toFixed(1)}分钟
                `;
            }
        },
        legend: {
            data: ['计划时间', '实际时间'],
            top: '10%',
            textStyle: {
                fontSize: 15,
                fontWeight: 'bold'
            }
        },
        xAxis: {
            type: 'category',
            data: planComparisonData.map(d => d.name),
            axisLabel: {
                rotate: 0,
                interval: 0, // 显示所有标签
                formatter: function(value) {
                    // 如果名称太长，截断显示
                    return value.length > 8 ? value.substring(0, 8) + '...' : value;
                }
            }
        },
        yAxis: {
            type: 'value',
            name: '分钟'
        },
        series: [
            {
                name: '计划时间',
                type: 'bar',
                data: planComparisonData.map(d => d.planned),
                itemStyle: {
                    color: '#4b6bbe'
                }
            },
            {
                name: '实际时间',
                type: 'bar',
                data: planComparisonData.map(d => d.actual),
                itemStyle: {
                    color: '#28a745'
                }
            }
        ]
    };
    
    chart.setOption(option);

    setTimeout(() => {
        chart.resize();
    }, 0);
    
    return chart; 
}

    // 渲染计划用时筛选日历
    function renderPlanActualCalendar(date) {
    // 更新标题
    planActualCalendarMonthYear.textContent = `${date.getFullYear()}年${date.getMonth() + 1}月`;

    renderGenericCalendar(
        'plan-actual-calendar-grid-year',
        date,
        function(clickedDate) {
            selectedPlanActualCalendarDate = clickedDate;
            renderPlanActualCalendar(date);
        },
        { selectedDate: selectedPlanActualCalendarDate }
    );
}

// 添加一个显示通知的函数
function showNotification(message) {
    // 创建通知元素
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #4b6bbe;
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 10000;
        font-size: 14px;
        font-weight: bold;
        animation: slideIn 0.3s ease;
    `;
    
    // 添加动画样式
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    `;
    document.head.appendChild(style);
    
    notification.textContent = message;
    document.body.appendChild(notification);
    
    // 3秒后自动移除
    setTimeout(() => {
        notification.remove();
        style.remove();
    }, 3000);
}

        // 渲染学习计划列表
       function renderPlans() {
    planList.innerHTML = '';
    
        // 获取当前选中的日期（使用本地时间）
        const targetDate = new Date(selectedDate);
        targetDate.setHours(0, 0, 0, 0);
        // 使用本地日期字符串，避免时区问题
        const targetDateStr = formatDateForDisplay(targetDate);
    
        // 过滤出选中日期的计划
        let selectedDatePlans = plans.filter(plan => {
             const planDate = new Date(plan.createdAt);
             planDate.setHours(0, 0, 0, 0);
             const planDateStr = formatDateForDisplay(planDate);
             return planDateStr === targetDateStr;
        });
    
    // 根据当前排序状态对计划进行排序
    if (currentSortOrder === 'custom') {
        selectedDatePlans = sortPlansByActualStartTime(selectedDatePlans);
    } else {
        // 默认排序：按创建时间升序
        selectedDatePlans = selectedDatePlans.sort((a, b) => {
            return new Date(a.createdAt) - new Date(b.createdAt);
        });
    }
    
            if (selectedDatePlans.length === 0) {
                planList.innerHTML = `
                    <div style="text-align: center; padding: 30px; color: #999;">
                        <i class="fas fa-book-open" style="font-size: 40px; margin-bottom: 15px;"></i>
                        <h3>暂无学习计划</h3>
                        <p>点击"添加计划"开始规划你的学习</p>
                    </div>
                `;
                return;
            }
            
            selectedDatePlans.forEach(plan => {                            
                const planItem = document.createElement('div');
                planItem.className = `plan-item ${plan.completed ? 'completed' : ''} ${plan.running ? 'running' : ''}`;
                planItem.dataset.id = plan.id;

                if (currentRunningTimer && currentRunningTimer != plan.id) {
                    planItem.classList.add('disabled');
                }
                
                const iconHtml = plan.icon ? `<i class="${plan.icon}"></i>` : '';
                
                 // 计算当前持续时间
                const currentDuration = calculateCurrentDuration(plan);
                
                planItem.innerHTML = `
                    <div class="plan-subject ${plan.subject}">${getSubjectText(plan.subject)}</div>
                    <div class="plan-content">
                        <div class="plan-header-row">
                            <div class="plan-name">${iconHtml} ${plan.name}</div>
                            <div class="plan-repeat">${getRepeatText(plan.repeat)}</div>
                            ${plan.actualStartTime ? `<div class="plan-actual-time">实际时间: ${plan.actualStartTime}-${plan.actualEndTime || '进行中'}</div>` : ''}
                            <span class="duration-label">计划用时：</span>
                            <input type="text" class="planned-duration" value="${plan.plannedDuration || '30min'}" data-id="${plan.id}">
                        </div>
                        <textarea class="plan-desc">内容：${plan.description}</textarea>
                        <div class="detail-jump-area">
                            <i class="fas fa-external-link-alt"></i> 点击查看详情
                        </div>
                    </div>
                    <div class="plan-status">
                        <div class="timer-display ${plan.completed ? 'completed' : (plan.running ? 'timing' : (plan.canceled ? 'canceled' : ''))}">
                            ${formatDuration(currentDuration)}
                        </div>
                        <div class="timer-controls">
                            ${plan.completed ? 
                                `<div class="completed-indicator">
                                    <div class="completed-circle">✓</div>
                                    <span>已完成</span>
                                </div>` : 
                                plan.canceled ?
                                `<div class="canceled-indicator">
                                    <div class="canceled-circle">×</div>
                                    <span>未完成</span>
                                </div>` :
                                `<button class="timer-btn ${plan.running ? 'pause' : 'start'} ${(currentRunningTimer && currentRunningTimer != plan.id) ? 'disabled' : ''}" data-id="${plan.id}">
                                    ${plan.running ? '<i class="fas fa-pause"></i>' : '<i class="fas fa-play"></i>'}
                                </button>
                                <button class="timer-btn stop ${(currentRunningTimer && currentRunningTimer != plan.id) ? 'disabled' : ''}" data-id="${plan.id}"><i class="fas fa-stop"></i></button>
                                <button class="timer-btn cancel ${(currentRunningTimer && currentRunningTimer != plan.id) ? 'disabled' : ''}" data-id="${plan.id}"><i class="fas fa-times"></i></button>`
                            }
                        </div>
                    </div>
                `;
                planList.appendChild(planItem);
            });

           // 添加计时按钮事件监听
            document.querySelectorAll('.timer-btn.start, .timer-btn.pause').forEach(btn => {
                btn.addEventListener('click', function() {
                    // 如果按钮被禁用，则不执行操作
                    if (this.classList.contains('disabled')) {
                        alert('请先完成当前正在进行的计划，再开始新的计划');
                        return;
                    }
                    const planId = this.getAttribute('data-id');
                    toggleTimer(planId);
                });
            });

            // 添加停止按钮事件监听
            document.querySelectorAll('.timer-btn.stop').forEach(btn => {
                btn.addEventListener('click', function() {
                    // 如果按钮被禁用，则不执行操作
                    if (this.classList.contains('disabled')) {
                        alert('请先完成当前正在进行的计划，再开始新的计划');
                        return;
                    }
                    const planId = this.getAttribute('data-id');
                    stopTimer(planId);
                });
            });

// 在现有的计时按钮事件监听器后面添加取消按钮事件监听器
document.querySelectorAll('.timer-btn.cancel').forEach(btn => {
    btn.addEventListener('click', function() {
        // 如果按钮被禁用，则不执行操作
        if (this.classList.contains('disabled')) {
            alert('请先完成当前正在进行的计划，再开始新的计划');
            return;
        }
        const planId = this.getAttribute('data-id');
        cancelPlan(planId);
    });
});

             // 为详情跳转区域添加点击事件
            document.querySelectorAll('.detail-jump-area').forEach(area => {
                area.addEventListener('click', function() {
                    const planItem = this.closest('.plan-item');
                    const planId = planItem.dataset.id;
                    openDetailModal(planId);
                });
            });

             // 添加内容编辑事件监听
            document.querySelectorAll('.plan-desc').forEach(textarea => {
                textarea.addEventListener('change', function() {
                    const planItem = this.closest('.plan-item');
                    const planId = planItem.dataset.id;
                    const planIndex = plans.findIndex(p => p.id == planId);
                    
                    if (planIndex !== -1) {
                        let content = this.value;
                        if (content.startsWith('内容：')) {
                            content = content.substring(3);
                        }
                        plans[planIndex].description = content;
                        localStorage.setItem('studyPlans', JSON.stringify(plans));
                    }
                });
            });

           // 添加计划用时编辑事件监听
            document.querySelectorAll('.planned-duration').forEach(input => {
                input.addEventListener('change', function() {
                    const planId = this.getAttribute('data-id');
                    const planIndex = plans.findIndex(p => p.id == planId);
                    
                    if (planIndex !== -1) {
                        plans[planIndex].plannedDuration = this.value;
                        localStorage.setItem('studyPlans', JSON.stringify(plans));
                    }
                });
            });
        }

// 添加自定义排序函数
function sortPlansByActualStartTime(plans) {
    return plans.sort((a, b) => {
        // 首先按是否有实际开始时间分组：有的在前，没有的在后
        const aHasStartTime = a.actualStartTime !== undefined && a.actualStartTime !== null;
        const bHasStartTime = b.actualStartTime !== undefined && b.actualStartTime !== null;
        
        if (aHasStartTime && !bHasStartTime) {
            return -1;
        } else if (!aHasStartTime && bHasStartTime) {
            return 1;
        } else if (aHasStartTime && bHasStartTime) {
            // 都有实际开始时间，按实际开始时间排序
            const aTime = convertTimeToMinutes(a.actualStartTime);
            const bTime = convertTimeToMinutes(b.actualStartTime);
            return aTime - bTime;
        } else {
            // 都没有实际开始时间，按创建时间排序
            return new Date(a.createdAt) - new Date(b.createdAt);
        }
    });
}

// 辅助函数：将时间字符串转换为分钟数
function convertTimeToMinutes(timeStr) {
    if (!timeStr) return 0;
    const [hours, minutes] = timeStr.split(':').map(Number);
    return hours * 60 + minutes;
}

           // 计算计划的当前持续时间
    function calculateCurrentDuration(plan) {
        if (plan.running && plan.startTime) {
            // 如果计时器正在运行，计算从开始时间到当前时间的时间差 + 之前累计的时间
            return (Date.now() - plan.startTime) + (plan.totalDuration || 0);
        } else if (plan.completed && plan.totalDuration) {
            // 如果已完成，返回总持续时间
            return plan.totalDuration;
        } else {
            // 否则返回已累计的时间
            return plan.totalDuration || 0;
        }
    }

        // 开始计时器间隔
        function startTimerInterval(planId) {
            // 清除现有的计时器
            if (timers[planId]) {
                clearInterval(timers[planId]);
            }
            
            // 创建新的计时器
            timers[planId] = setInterval(() => {
                const planIndex = plans.findIndex(p => p.id == planId);
                if (planIndex === -1) return;
                
                const plan = plans[planIndex];
                const currentDuration = calculateCurrentDuration(plan);
                
                // 更新主页显示
                const planElement = document.querySelector(`.plan-item[data-id="${planId}"]`);
                if (planElement) {
                    const timerDisplay = planElement.querySelector('.timer-display');
                    if (timerDisplay) {
                        timerDisplay.textContent = formatDuration(currentDuration);
                        timerDisplay.className = 'timer-display timing';
                    }
                }
                
                // 更新详情页面显示
                if (currentDetailPlanId == planId) {
                    detailTimer.textContent = formatDuration(currentDuration);
                    detailTimer.className = 'detail-timer-display timing';
                }
            }, 1000);
        }

        // 打开详情页面
        function openDetailModal(planId) {
            const planIndex = plans.findIndex(p => p.id == planId);
            
            if (planIndex === -1) return;
            
            const plan = plans[planIndex];
            currentDetailPlanId = planId;
            
            // 计算当前持续时间
            const currentDuration = calculateCurrentDuration(plan);
            
            // 填充详情页面数据
            const iconHtml = plan.icon ? `<i class="${plan.icon}"></i>` : '';
            document.getElementById('detail-plan-name').innerHTML = `${iconHtml} ${plan.name}<div class="repeat-badge" id="detail-repeat">重复频率：${getRepeatText(plan.repeat)}</div>`;
            document.getElementById('detail-timer').textContent = formatDuration(currentDuration);
            document.getElementById('detail-subject').textContent = getSubjectText(plan.subject);
            document.getElementById('detail-planned-duration').textContent = plan.plannedDuration || '30min';
            document.getElementById('detail-date').textContent = formatDateForDisplay(new Date(plan.createdAt));
            document.getElementById('detail-actual-time').textContent = plan.actualStartTime ? 
                `${plan.actualStartTime} - ${plan.actualEndTime || '进行中'}` : '未开始';
            document.getElementById('detail-description').value = plan.description;
            
            // 设置计时器状态
            updateDetailTimerDisplay(plan);
            
            // 显示详情页面
            detailModal.style.display = 'block';
        }

        // 更新详情页面计时器显示
        function updateDetailTimerDisplay(plan) {
    if (plan.running) {
        // 运行时显示暂停图标
        detailStartBtn.innerHTML = '<i class="fas fa-pause"></i> 暂停';
        detailStartBtn.className = 'detail-timer-btn pause';
        detailTimer.className = 'detail-timer-display timing';
    } else if (plan.completed) {
        // 完成时显示播放图标
        detailStartBtn.innerHTML = '<i class="fas fa-play"></i> 开始';
        detailStartBtn.className = 'detail-timer-btn start';
        detailTimer.className = 'detail-timer-display completed';
    } else if (plan.canceled) {
        // 取消时显示播放图标
        detailStartBtn.innerHTML = '<i class="fas fa-play"></i> 开始';
        detailStartBtn.className = 'detail-timer-btn start';
        detailTimer.className = 'detail-timer-display canceled'; 
    } else {
        // 未开始时显示播放图标
        detailStartBtn.innerHTML = '<i class="fas fa-play"></i> 开始';
        detailStartBtn.className = 'detail-timer-btn start';
        detailTimer.className = 'detail-timer-display';
    }
    
    // 更新计时器显示
    const currentDuration = calculateCurrentDuration(plan);
    detailTimer.textContent = formatDuration(currentDuration);
}

        // 打开编辑模态框
        function openEditModal(planId) {
            const planIndex = plans.findIndex(p => p.id == planId);
            
            if (planIndex === -1) return;
            
            const plan = plans[planIndex];
            currentEditPlanId = planId;
            
            // 填充编辑模态框数据
            document.getElementById('edit-plan-subject').value = plan.subject;
            document.getElementById('edit-plan-name').value = plan.name;
            document.getElementById('edit-planned-duration').value = plan.plannedDuration || '30min';
            document.getElementById('edit-plan-repeat').value = plan.repeat;
            document.getElementById('edit-plan-description').value = plan.description;
            
            // 隐藏详情页面，显示编辑模态框
            ModalManager.open('edit-plan-modal');
        }

        // 保存计划
        function savePlan() {
    const planSubject = document.getElementById('plan-subject').value;
    const planName = document.getElementById('plan-name').value;
    const planDescription = document.getElementById('plan-description').value;
    const plannedDuration = document.getElementById('planned-duration').value;
    const planRepeat = document.getElementById('plan-repeat').value;
    
    const { planName: finalPlanName, icon } = getPlanIconAndName(planSubject, planDescription || planName);
    
    // 使用本地日期，避免时区问题
    const localSelectedDate = new Date(selectedDate);
    localSelectedDate.setHours(0, 0, 0, 0);
    
    const newPlan = {
        id: plans.length > 0 ? Math.max(...plans.map(p => p.id)) + 1 : 1,
        subject: planSubject,
        name: finalPlanName,
        description: planDescription,
        plannedDuration: plannedDuration,
        repeat: planRepeat,
        completed: false,
        running: false,
        startTime: null,
        totalDuration: 0,
        createdAt: formatDateForDisplay(localSelectedDate), // 使用格式化的本地日期
        icon: icon
    };
    
    plans.push(newPlan);
    localStorage.setItem('studyPlans', JSON.stringify(plans));
   
    // 重置表单并关闭模态框
    document.getElementById('add-plan-form').reset();
    ModalManager.close('add-plan-modal');
    
    // 重新渲染
    renderPlans();
    updateStats();
}

        // 修复后的批量添加计划函数
function batchAddPlans() {
    const batchInput = document.getElementById('batch-input').value;
    const plannedDuration = document.getElementById('batch-planned-duration').value;
    const batchRepeat = document.getElementById('batch-repeat').value;
    
    if (!batchInput.trim()) {
        alert('请输入计划内容！');
        return;
    }
    
    const lines = batchInput.split('\n').map(line => line.trim()).filter(line => line);
    let currentSubject = '';
    let newPlans = [];

    // 使用本地日期，避免时区问题
    const localSelectedDate = new Date(selectedDate);
    localSelectedDate.setHours(0, 0, 0, 0);
    const selectedDateStr = formatDateForDisplay(localSelectedDate);
    
    // 计算新的ID起始值
    const maxExistingId = plans.length > 0 ? Math.max(...plans.map(p => p.id)) : 0;
    let nextId = maxExistingId + 1;

    for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        
        // 恢复为旧代码的科目检测逻辑 - 精确匹配
        if (['语文', '数学', '英语', '运动', '放松', '技能', '美术', '地理', '体育', '音乐', '生物', '历史', '道法'].includes(line)) {
            currentSubject = line;
        } 
        // 恢复为旧代码的任务行检测逻辑 - 只检查以数字和点开头
        else if (line.match(/^\d+\./)) {
            if (!currentSubject) {
                alert('请先指定科目！');
                return;
            }
            
            // 科目映射
            const subjectMap = {
                '语文': 'chinese',
                '数学': 'math', 
                '英语': 'english',
                '运动': 'sports',
                '放松': 'relax',
                '技能': 'skill',
                '历史': 'other',
                '道法': 'other',
                '美术': 'other',
                '地理': 'other',
                '体育': 'other',
                '音乐': 'other',
                '生物': 'other'
            };
            
            const subject = subjectMap[currentSubject] || 'other';
            
            // 提取任务内容
            const taskContent = line.substring(line.indexOf('.') + 1).trim();
            
            // 使用统一的 getPlanIconAndName 函数
            const { planName, icon } = getPlanIconAndName(subject, taskContent);

            const newPlan = {
                id: nextId++,
                subject: subject,
                name: planName,
                description: taskContent,
                plannedDuration: plannedDuration,
                repeat: batchRepeat,
                completed: false,
                running: false,
                startTime: null,
                totalDuration: 0,
                createdAt: selectedDateStr,
                icon: icon
            };
            
            newPlans.push(newPlan);
        }
    }
    
    if (newPlans.length === 0) {
        alert('没有检测到有效的任务！请确保输入格式正确。\n格式示例：\n语文\n1.完成课文阅读\n2.背诵古诗\n数学\n1.完成练习题');
        return;
    }
    
    // 将新计划添加到现有计划中
    plans = plans.concat(newPlans);
    
    // 保存到本地存储
    localStorage.setItem('studyPlans', JSON.stringify(plans));
    
    // 重置表单并关闭模态框
    document.getElementById('batch-add-form').reset();
    ModalManager.close('batch-add-modal');
    
    // 重新渲染
    renderPlans();
    updateStats();
    
    alert(`成功批量添加 ${newPlans.length} 个计划！`);
}

        // 获取科目文本函数 - 添加技能科目
        function getSubjectText(subject) {
            const subjectMap = {
                'english': '英语',
                'chinese': '语文',
                'math': '数学',
                'sports': '运动',
                'relax': '放松',
                'skill': '技能',
                'daily': '日常',
                'other': '其他'
            };
            return subjectMap[subject] || '其他';
        }

        // 保存编辑后的计划
        function saveEditedPlan() {
            const planIndex = plans.findIndex(p => p.id == currentEditPlanId);
            
            if (planIndex === -1) return;
            
            const planSubject = document.getElementById('edit-plan-subject').value;
            const planName = document.getElementById('edit-plan-name').value;
            const planDescription = document.getElementById('edit-plan-description').value;
            const plannedDuration = document.getElementById('edit-planned-duration').value;
            const planRepeat = document.getElementById('edit-plan-repeat').value;
            
            plans[planIndex].subject = planSubject;
            plans[planIndex].name = planName;
            plans[planIndex].description = planDescription;
            plans[planIndex].plannedDuration = plannedDuration;
            plans[planIndex].repeat = planRepeat;
            
            // 保存到本地存储
            localStorage.setItem('studyPlans', JSON.stringify(plans));
            
            // 关闭编辑模态框
            ModalManager.close('edit-plan-modal');
            
            // 重新渲染
            renderPlans();
            
            // 如果详情页面正在显示，更新详情页面
            if (currentDetailPlanId === currentEditPlanId) {
                openDetailModal(currentDetailPlanId);
                detailModal.style.display = 'block';
            }
            
            currentEditPlanId = null;
        }

        // 全局变量，跟踪当前正在运行的计时器
        let currentRunningTimer = null;

        // 在 toggleTimer 函数中，修改日期检查逻辑
        function toggleTimer(planId) {
            const planIndex = plans.findIndex(p => p.id == planId);
            if (planIndex === -1) return;
    
            const plan = plans[planIndex];
    
            // 如果已经有计时器在运行，且不是当前计划
            if (currentRunningTimer && currentRunningTimer !== planId) {
                alert('请先完成当前正在进行的计划，再开始新的计划');
                return;
            }
    
            // 检查计划是否是在其他日期创建的，并且是单次计划
            const planDate = new Date(plan.createdAt);
            const today = new Date();
            planDate.setHours(0, 0, 0, 0);
            today.setHours(0, 0, 0, 0);
    
            // 修改条件：如果计划不是今天创建的，且是单次计划，就自动移动到今天
            // 不再检查 !plan.actualStartTime，这样即使之前开始过但没完成，也会移动到今天
            if (planDate.getTime() !== today.getTime() && plan.repeat === 'once') {
            // 自动将计划移动到今天
            plan.createdAt = today.toISOString();
        
            // 保存到本地存储
            localStorage.setItem('studyPlans', JSON.stringify(plans));
        
            // 重新渲染计划和更新统计
            renderPlans();
            updateStats();
        
            // 如果当前选中的不是今天，提示用户计划已移动
            const selectedDateMidnight = new Date(selectedDate);
            selectedDateMidnight.setHours(0, 0, 0, 0);
        
            if (selectedDateMidnight.getTime() !== today.getTime()) {
                // 显示提示信息
                showNotification(`计划 "${plan.name}" 已自动移动到今天`);
            }
        
            // 继续执行计时逻辑
       }
    
    if (plan.running) {
        // 如果正在运行，暂停计时
        plan.running = false;
        currentRunningTimer = null;
        
        // 清除闹铃
        clearAlarm(planId);
        
        // 更新总持续时间
        if (plan.startTime) {
            plan.totalDuration = Date.now() - plan.startTime + (plan.totalDuration || 0);
            plan.startTime = null;
        }
        
        // 暂停计时器
        if (timers[planId]) {
            clearInterval(timers[planId]);
            delete timers[planId];
        }
    } else {
        // 开始计时
        plan.running = true;
        currentRunningTimer = planId;
        
        // 设置开始时间
        plan.startTime = Date.now();
        
        // 记录实际开始时间（只在第一次开始时记录）
        if (!plan.actualStartTime) {
            plan.actualStartTime = formatTime(new Date());
        }
        
        // 为"玩"计划设置闹铃
        setAlarmForPlayPlan(planId, plan.plannedDuration);
        
        // 创建计时器
        startTimerInterval(planId);
    }
    
    // 保存到本地存储
    localStorage.setItem('studyPlans', JSON.stringify(plans));
    
    // 重新渲染
    renderPlans();
    updateStats();
    
    // 更新详情页面显示
    if (currentDetailPlanId == planId) {
        updateDetailTimerDisplay(plan);
    }
}

           // 停止计时
   function stopTimer(planId) {
            const planIndex = plans.findIndex(p => p.id == planId);
            if (planIndex === -1) return;
            
            const plan = plans[planIndex];
            
            // 清除闹铃
            clearAlarm(planId);
            
            // 停止计时器
            if (timers[planId]) {
                clearInterval(timers[planId]);
                delete timers[planId];
            }
            
            // 更新总持续时间
            if (plan.running && plan.startTime) {
                plan.totalDuration = Date.now() - plan.startTime + (plan.totalDuration || 0);
                plan.startTime = null;
            }
            
            // 标记为完成
            plan.running = false;
            plan.completed = true;
            currentRunningTimer = null;
            
            // 记录实际结束时间
            if (plan.actualStartTime && !plan.actualEndTime) {
                plan.actualEndTime = formatTime(new Date());
            }
            
            // 保存到本地存储
            localStorage.setItem('studyPlans', JSON.stringify(plans));
            
            // 重新渲染
            renderPlans();
            updateStats();
            
            // 更新详情页面显示
            if (currentDetailPlanId == planId) {
                updateDetailTimerDisplay(plan);
                document.getElementById('detail-actual-time').textContent = 
                    `${plan.actualStartTime} - ${plan.actualEndTime}`;
            }
            
            // 检查勋章解锁（新增）
            updateHonorsAndStars();
        }

           // 取消计时
     function cancelPlan(planId) {
            const planIndex = plans.findIndex(p => p.id == planId);
            if (planIndex === -1) return;
            
            const plan = plans[planIndex];
            
            // 清除闹铃
            clearAlarm(planId);
            
            // 停止计时器
            if (timers[planId]) {
                clearInterval(timers[planId]);
                delete timers[planId];
            }
            
            // 如果有正在运行的计时器，重置相关状态
            if (plan.running) {
                if (plan.startTime) {
                    plan.totalDuration = Date.now() - plan.startTime + (plan.totalDuration || 0);
                    plan.startTime = null;
                }
                plan.running = false;
                currentRunningTimer = null;
            }
            
            // 标记为已取消
            plan.canceled = true;
            plan.completed = false;
            
            // 保存到本地存储
            localStorage.setItem('studyPlans', JSON.stringify(plans));
            
            // 重新渲染
            renderPlans();
            updateStats();
            
            // 更新详情页面显示
            if (currentDetailPlanId == planId) {
                updateDetailTimerDisplay(plan);
            }
        }
        // 备份数据
        function backupData() {
            const backupTime = new Date();
            document.getElementById('backup-time').textContent = backupTime.toLocaleString();
            ModalManager.open('backup-modal');
        }

        // 下载备份
        function downloadBackup() {
            const backupData = {
                plans: plans,
                checkins: checkins,
                importantTasks: importantTasks,
                honors: honors, // 新增：勋章数据
                wishes: wishes, // 新增：兑换清单数据
                availableStars: availableStars, // 新增：可用星星数量
                backupTime: new Date().toLocaleString('zh-CN')
            };
            
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(backupData, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "学习计划备份_" + formatDateForDisplay(new Date()) + ".json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
            
            ModalManager.close('backup-modal');
        }

// 导入数据
        function importData() {
            const importDataText = document.getElementById('data-import').value;
            
            if (!importDataText.trim()) {
                alert('请输入备份数据！');
                return;
            }
            
            try {
                const importedData = JSON.parse(importDataText);
                
                if (importedData.plans && Array.isArray(importedData.plans)) {
                    plans = importedData.plans;
                    localStorage.setItem('studyPlans', JSON.stringify(plans));
                    
                    if (importedData.checkins && Array.isArray(importedData.checkins)) {
                        checkins = importedData.checkins;
                        localStorage.setItem('studyCheckins', JSON.stringify(checkins));
                    }

        // 新增：导入荣誉勋章墙数据
                    if (importedData.honors && Array.isArray(importedData.honors)) {
                        honors = importedData.honors;
                        localStorage.setItem('studyHonors', JSON.stringify(honors));
                    }
            
                    if (importedData.wishes && Array.isArray(importedData.wishes)) {
                        wishes = importedData.wishes;
                        localStorage.setItem('studyWishes', JSON.stringify(wishes));
                    }
            
                    if (importedData.availableStars !== undefined) {
                        availableStars = importedData.availableStars;
                        localStorage.setItem('availableStars', availableStars.toString());
                    }
                    
            // 重新渲染
            renderPlans();
            renderCalendar();
            updateStats();
            
            // 重新初始化荣誉勋章墙数据
            updateHonorsAndStars();
            
            importModal.style.display = 'none';
            alert('数据导入成功！');
        } else {
            alert('备份数据格式不正确！');
        }
    } catch (e) {
        alert('备份数据格式不正确！');
    }
}

        // 清空所有计划
        function clearAllPlans() {
            plans = [];
            checkins = [];
            localStorage.setItem('studyPlans', JSON.stringify(plans));
            localStorage.setItem('studyCheckins', JSON.stringify(checkins));
            
            // 清除所有计时器
            for (const timerId in timers) {
                clearInterval(timers[timerId]);
            }
            timers = {};
            
            // 重新渲染
            renderPlans();
            renderCalendar();
            updateStats();
        }

        // 渲染日历
        function renderCalendar() {
            calendarGrid.innerHTML = '';
            
            const today = new Date();
            const startOfWeek = getStartOfWeek(today);
            startOfWeek.setDate(startOfWeek.getDate() + (currentWeekOffset * 7));
            
            for (let i = 0; i < 7; i++) {
                const day = new Date(startOfWeek);
                day.setDate(startOfWeek.getDate() + i);
                
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                
                // 检查是否是今天 - 重置时间为午夜进行比较
                const todayMidnight = new Date();
                todayMidnight.setHours(0, 0, 0, 0);
                const dayMidnight = new Date(day);
                dayMidnight.setHours(0, 0, 0, 0);
                
                // 检查是否是选中的日期 - 重置时间为午夜进行比较
                const selectedDateMidnight = new Date(selectedDate);
                selectedDateMidnight.setHours(0, 0, 0, 0);
                
                // 修复日期高亮逻辑
                if (dayMidnight.getTime() === todayMidnight.getTime() && dayMidnight.getTime() === selectedDateMidnight.getTime()) {
                    // 如果今天被选中，显示为橙色
                    dayElement.classList.add('today');
                } else if (dayMidnight.getTime() === todayMidnight.getTime()) {
                    // 如果是今天但未被选中，显示为橙色
                    dayElement.classList.add('today');
                } else if (dayMidnight.getTime() === selectedDateMidnight.getTime()) {
                    // 如果是选中的日期但不是今天，显示为蓝色
                    dayElement.classList.add('selected');
                }
                
                const dateStr = formatDateForDisplay(day);
                const checkin = checkins.find(c => c.date === dateStr);
                if (checkin && checkin.plans.length > 0) {
                    dayElement.classList.add('checked');
                }
                
                const weekdays = ['日', '一', '二', '三', '四', '五', '六'];
                const month = day.getMonth() + 1;
                const date = day.getDate();
                const weekday = weekdays[day.getDay()];
                
                dayElement.innerHTML = `
                    <div class="weekday">周${weekday}</div>
                    <div class="date">${month}/${date}</div>
                `;
                
                // 添加点击事件
                dayElement.addEventListener('click', function() {
                    selectedDate = new Date(day);
                    renderCalendar();
                    renderPlans();
                    updateStats();
                });
                
                calendarGrid.appendChild(dayElement);
            }
        }

        // 渲染全年日历
        function renderFullCalendar(date) {
    // 更新标题
    calendarMonthYear.textContent = `${date.getFullYear()}年${date.getMonth() + 1}月`;

    renderGenericCalendar(
        'calendar-grid-year',
        date,
        function(clickedDate) {
            selectedCalendarDate = clickedDate;
            renderFullCalendar(date); // 重新渲染以更新选中状态
        },
        { selectedDate: selectedCalendarDate }
    );
}

        // 获取一周的开始日期（周一）
        function getStartOfWeek(date) {
            const day = date.getDay();
            const diff = date.getDate() - day + (day === 0 ? -6 : 1);
            const startOfWeek = new Date(date);
            startOfWeek.setDate(diff);
            startOfWeek.setHours(0, 0, 0, 0);
            return startOfWeek;
        }

        // 更新周标题
        function updateWeekTitle() {
            const today = new Date();
            const startOfWeek = getStartOfWeek(today);
            startOfWeek.setDate(startOfWeek.getDate() + (currentWeekOffset * 7));
            
            const year = startOfWeek.getFullYear();
            const month = startOfWeek.getMonth() + 1;
            
            const firstDayOfYear = new Date(year, 0, 1);
            const days = Math.floor((startOfWeek - firstDayOfYear) / (24 * 60 * 60 * 1000));
            const weekNumber = Math.ceil((days + firstDayOfYear.getDay() + 1) / 7);
            
            weekTitle.textContent = `${year}年${month}月第${weekNumber}周`;
        }

                // 更新统计信息
        function updateStats() {
                // 获取选中日期的字符串（使用本地时间）
    const selectedDateMidnight = new Date(selectedDate);
    selectedDateMidnight.setHours(0, 0, 0, 0);
    const selectedDateStr = formatDateForDisplay(selectedDateMidnight);
    
    // 获取今天的日期字符串（用于连续打卡天数计算）
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const todayStr = formatDateForDisplay(today);
            
            // 计算连续打卡天数（仍然基于今天）
            const sortedDates = checkins.map(c => c.date).sort();
            let currentStreak = 0;
            
            if (sortedDates.includes(todayStr)) {
                currentStreak = 1;
                let currentDate = new Date(today);
                
                for (let i = 1; i <= 30; i++) {
                    currentDate.setDate(currentDate.getDate() - 1);
                    const prevDate = formatDateForDisplay(currentDate);
                    
                    if (sortedDates.includes(prevDate)) {
                        currentStreak++;
                    } else {
                        break;
                    }
                }
            }
            
            document.getElementById('streak-days').textContent = currentStreak;
            
            // 计算累计完成计划数（所有时间）
            const completedPlans = plans.filter(p => p.completed).length;
            document.getElementById('total-plans').textContent = completedPlans;
            
            // 计算选中日期的学习时间和运动时间
            let selectedDateStudyTime = 0;
            let selectedDateSportsTime = 0;
            let selectedDateTotalPlannedTime = 0;
            
            plans.forEach(plan => {
                 // 检查计划是否是选中日期完成的
        const planDate = new Date(plan.createdAt);
        planDate.setHours(0, 0, 0, 0);
        const planDateStr = formatDateForDisplay(planDate);
        
       if (planDateStr === selectedDateStr) {
            // 计算总计划用时（不管是否完成）
            const plannedDurationHours = parseDurationToHours(plan.plannedDuration || '30min');
            selectedDateTotalPlannedTime += plannedDurationHours;
            
            if (plan.completed && plan.totalDuration) {
                const durationHours = plan.totalDuration / (1000 * 60 * 60); // 转换为小时
                
                if (plan.subject === 'sports') {
                    selectedDateSportsTime += durationHours;
                } else if (plan.subject === 'daily') {
                    // 日常科目不计入学习时间，也不计入运动时间
                    // 不进行任何操作
                } else {
                    selectedDateStudyTime += durationHours;
                }
            }
        }
    });
            
            document.getElementById('today-study-time').textContent = selectedDateStudyTime.toFixed(1) + 'h';
            document.getElementById('today-sports-time').textContent = selectedDateSportsTime.toFixed(1) + 'h';
            document.getElementById('today-total-planned-time').textContent = selectedDateTotalPlannedTime.toFixed(1) + 'h';
            
            // 计算选中日期的任务完成情况
            const selectedDatePlans = plans.filter(p => {
                const planDate = new Date(p.createdAt);
                planDate.setHours(0, 0, 0, 0);
                const planDateStr = formatDateForDisplay(planDate);
                return planDateStr === selectedDateStr;
            });
            
            const completedSelectedDatePlans = selectedDatePlans.filter(p => p.completed).length;
            document.getElementById('today-tasks').textContent = `${completedSelectedDatePlans}/${selectedDatePlans.length}`;
            document.getElementById('today-completion').textContent = selectedDatePlans.length > 0 ? 
                Math.round((completedSelectedDatePlans / selectedDatePlans.length) * 100) + '%' : '0%';
        }

        // 辅助函数
        function getRepeatText(repeat) {
            const repeatMap = {
                'once': '仅当天',
                'daily': '每天',
                'weekdays': '周一至周五',
                'weekly': '每周的这天'
            };
            return repeatMap[repeat] || '仅当天';
        }

        function formatTime(date) {
            return `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
        }

        function formatDuration(ms) {
            const seconds = Math.floor(ms / 1000);
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        // 统一的日期格式化函数 - 用于存储和显示都使用 YYYY/MM/DD
        function formatDateForDisplay(date) {
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${year}/${month}/${day}`;
        }

// 初始化音频上下文
function initAudioContext() {
    if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
    }
}

// 播放庆祝音效 - 使用 Web Audio API 生成音效
function playCelebrationSound() {
    try {
        initAudioContext();
        
        // 如果音频上下文是挂起状态（由于浏览器策略），需要恢复
        if (audioContext.state === 'suspended') {
            audioContext.resume();
        }
        
        // 创建主增益节点控制音量
        const masterGain = audioContext.createGain();
        masterGain.gain.value = 0.3; // 音量控制
        masterGain.connect(audioContext.destination);
        
        // 播放多个频率的音符，创造庆祝效果
        const frequencies = [523.25, 659.25, 783.99, 1046.50]; // C5, E5, G5, C6
        
        frequencies.forEach((freq, index) => {
            setTimeout(() => {
                playTone(freq, masterGain);
            }, index * 100);
        });
        
    } catch (error) {
        console.log('音效播放失败:', error);
        // 静默失败，不影响主要功能
    }
}

// 播放单个音符
function playTone(frequency, output) {
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    
    oscillator.connect(gainNode);
    gainNode.connect(output);
    
    oscillator.frequency.value = frequency;
    oscillator.type = 'sine';
    
    // 音量包络 - 淡入淡出
    const now = audioContext.currentTime;
    gainNode.gain.setValueAtTime(0, now);
    gainNode.gain.linearRampToValueAtTime(0.3, now + 0.1);
    gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
    
    oscillator.start(now);
    oscillator.stop(now + 0.5);
}

// 播放解锁勋章的特定音效
function playHonorUnlockSound() {
    try {
        initAudioContext();
        
        if (audioContext.state === 'suspended') {
            audioContext.resume();
        }
        
        const masterGain = audioContext.createGain();
        masterGain.gain.value = 0.4;
        masterGain.connect(audioContext.destination);
        
        // 播放上升音阶，创造成就解锁的感觉
        const scale = [523.25, 587.33, 659.25, 698.46, 783.99, 880.00, 987.77, 1046.50]; // C大调音阶
        
        scale.forEach((freq, index) => {
            setTimeout(() => {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(masterGain);
                
                oscillator.frequency.value = freq;
                oscillator.type = 'triangle';
                
                const now = audioContext.currentTime;
                gainNode.gain.setValueAtTime(0, now);
                gainNode.gain.linearRampToValueAtTime(0.2, now + 0.05);
                gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
                
                oscillator.start(now);
                oscillator.stop(now + 0.3);
            }, index * 80);
        });
        
    } catch (error) {
        console.log('音效播放失败:', error);
    }
}

   // 数据模型
        let honors = JSON.parse(localStorage.getItem('studyHonors')) || [];
        let wishes = JSON.parse(localStorage.getItem('studyWishes')) || [];
        let availableStars = parseInt(localStorage.getItem('availableStars')) || 0;
        
        // 初始化默认勋章
        const defaultHonors = [
            // 连续打卡成就
            { id: 1, name: "初级学习者", description: "连续打卡7天", icon: "fas fa-medal", color: "#fd9400", condition: "streak", value: 7, unlocked: false, progress: 0 },
            { id: 2, name: "中级学习者", description: "连续打卡30天", icon: "fas fa-trophy", color: "#4b6bbe", condition: "streak", value: 30, unlocked: false, progress: 0 },
            { id: 3, name: "高级学习者", description: "连续打卡100天", icon: "fas fa-crown", color: "#c690ce", condition: "streak", value: 100, unlocked: false, progress: 0 },
            { id: 4, name: "学习大师", description: "连续打卡365天", icon: "fas fa-award", color: "#28a745", condition: "streak", value: 365, unlocked: false, progress: 0 },
            
            // 累计打卡成就
            { id: 5, name: "入门新手", description: "累计完成10个计划", icon: "fas fa-star", color: "#fd9400", condition: "total_plans", value: 10, unlocked: false, progress: 0 },
            { id: 6, name: "计划达人", description: "累计完成50个计划", icon: "fas fa-trophy", color: "#4b6bbe", condition: "total_plans", value: 50, unlocked: false, progress: 0 },
            { id: 7, name: "计划大师", description: "累计完成100个计划", icon: "fas fa-crown", color: "#c690ce", condition: "total_plans", value: 100, unlocked: false, progress: 0 },
            { id: 8, name: "计划狂人", description: "累计完成500个计划", icon: "fas fa-award", color: "#28a745", condition: "total_plans", value: 500, unlocked: false, progress: 0 },
            
            // 分类打卡成就
            { id: 9, name: "运动新星", description: "总运动完成5个小时", icon: "fas fa-running", color: "#fd9400", condition: "category_hours", category: "sports", value: 5, unlocked: false, progress: 0 },
            { id: 10, name: "运动健将", description: "总运动完成20个小时", icon: "fas fa-trophy", color: "#4b6bbe", condition: "category_hours", category: "sports", value: 20, unlocked: false, progress: 0 },
            { id: 11, name: "运动巨人", description: "总运动完成50个小时", icon: "fas fa-crown", color: "#c690ce", condition: "category_hours", category: "sports", value: 50, unlocked: false, progress: 0 },
            { id: 12, name: "技能达人", description: "完成20个技能计划", icon: "fas fa-paint-brush", color: "#28a745", condition: "category_hours", category: "skill", value: 20, unlocked: false, progress: 0 },
            
            // 时间管理成就
            { id: 13, name: "时间规划者", description: "计划用时与实际用时差在30%以内", icon: "fas fa-clock", color: "#fd9400", condition: "time_accuracy", value: 30, unlocked: false, progress: 0 },
            { id: 14, name: "时间管理者", description: "计划用时与实际用时差在20%以内", icon: "fas fa-trophy", color: "#4b6bbe", condition: "time_accuracy", value: 20, unlocked: false, progress: 0 },
            { id: 15, name: "时间管理大师", description: "计划用时与实际用时差在10%以内", icon: "fas fa-crown", color: "#c690ce", condition: "time_accuracy", value: 10, unlocked: false, progress: 0 },
            
            // 总学习时间成就
            { id: 16, name: "学习新星", description: "总学习时间达到50小时", icon: "fas fa-book", color: "#fd9400", condition: "total_study_hours", value: 50, unlocked: false, progress: 0 },
            { id: 17, name: "学习达人", description: "总学习时间达到100小时", icon: "fas fa-trophy", color: "#4b6bbe", condition: "total_study_hours", value: 100, unlocked: false, progress: 0 },
            { id: 18, name: "学习巨匠", description: "总学习时间达到500小时", icon: "fas fa-crown", color: "#c690ce", condition: "total_study_hours", value: 500, unlocked: false, progress: 0 },
            
            // 提前完成成就
           { id: 19, name: "速度新星", description: "提前10分钟完成", icon: "fas fa-bolt", color: "#fd9400", condition: "early_completion", value: 1, unlocked: false, progress: 0 },
           { id: 20, name: "速度达人", description: "提前20分钟完成", icon: "fas fa-trophy", color: "#4b6bbe", condition: "early_completion", value: 1, unlocked: false, progress: 0 },
            { id: 21, name: "效率大圣", description: "一周内5次提前完成", icon: "fas fa-crown", color: "#c690ce", condition: "early_completion", value: 5, unlocked: false, progress: 0 }
        ];
        
        // 初始化默认兑换清单
       const defaultWishes = [
    { id: 1, category: "entertainment", content: "游戏(30min)", quantity: 1, cost: 10, redeemedCount: 0 },
    { id: 2, category: "entertainment", content: "电影", quantity: 1, cost: 15, redeemedCount: 0 },
    { id: 3, category: "entertainment", content: "电视(30min)", quantity: 1, cost: 15, redeemedCount: 0 },
    { id: 4, category: "food", content: "奶茶(1杯)", quantity: 1, cost: 15, redeemedCount: 0 },
    { id: 5, category: "food", content: "蛋糕(1块)", quantity: 1, cost: 20, redeemedCount: 0 },
    { id: 6, category: "food", content: "零食", quantity: 1, cost: 10, redeemedCount: 0 },
    { id: 7, category: "shopping", content: "书籍", quantity: 1, cost: 15, redeemedCount: 0 },
    { id: 8, category: "shopping", content: "文具", quantity: 1, cost: 15, redeemedCount: 0 },
    { id: 9, category: "experience", content: "短途旅行", quantity: 1, cost: 50, redeemedCount: 0 },
    { id: 10, category: "experience", content: "公园游玩", quantity: 1, cost: 15, redeemedCount: 0 }
];
        
        // 获取DOM元素
        const honorWallCard = document.getElementById('honor-wall-card');
        const honorModal = document.getElementById('honor-modal');
        const honorBackBtn = document.getElementById('honor-back-btn');
        const addHonorBtn = document.getElementById('add-honor-btn');
        const clearHonorBtn = document.getElementById('clear-honor-btn');
        const addHonorModal = document.getElementById('add-honor-modal');
        const closeAddHonorModal = document.getElementById('close-add-honor-modal');
        const cancelAddHonor = document.getElementById('cancel-add-honor');
        const addHonorForm = document.getElementById('add-honor-form');
        
        const addWishBtn = document.getElementById('add-wish-btn');
        const clearWishBtn = document.getElementById('clear-wish-btn');
        const addWishModal = document.getElementById('add-wish-modal');
        const closeAddWishModal = document.getElementById('close-add-wish-modal');
        const cancelAddWish = document.getElementById('cancel-add-wish');
        const addWishForm = document.getElementById('add-wish-form');
        
        const availableStarsElement = document.getElementById('available-stars');
        const wishCategoryBtns = document.querySelectorAll('.wish-category-btn');
        
        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化默认数据
            initializeDefaultData();
            
            // 更新荣誉和星星数据
            updateHonorsAndStars();
            
            // 设置事件监听器
            setupHonorEventListeners();

            // 确保重要任务数据已加载
            importantTasks = JSON.parse(localStorage.getItem('importantTasks')) || [];
            renderImportantTasks();
                });
        
        function initializeDefaultData() {
            // 初始化勋章数据
            if (honors.length === 0) {
                // 为默认勋章添加isDefault属性
                defaultHonors.forEach(honor => {
                    honor.isDefault = true;
                });
                honors = defaultHonors;
            } else {
                // 如果已有勋章数据，更新特定勋章的描述
                const honorUpdates = {
                    19: { name: "速度新星", description: "提前10分钟完成" },
                    20: { name: "速度达人", description: "提前20分钟完成" },
                    21: { name: "效率大圣", description: "一周内5次提前完成" }
                };
                
                honors.forEach(honor => {
                    if (honorUpdates[honor.id]) {
                        honor.name = honorUpdates[honor.id].name;
                        honor.description = honorUpdates[honor.id].description;
                    }
                    
                    // 确保默认勋章有isDefault属性
                    if (honor.id <= 21 && honor.isDefault === undefined) {
                        honor.isDefault = true;
                    }
                });

    // 修复现有的兑换清单数据，确保都有 redeemedCount 字段
    wishes.forEach(wish => {
        if (wish.redeemedCount === undefined) {
            wish.redeemedCount = 0;
        }
    });
    localStorage.setItem('studyWishes', JSON.stringify(wishes));
            }
            
            // 保存更新后的勋章数据
            localStorage.setItem('studyHonors', JSON.stringify(honors));
            
            // 初始化兑换清单数据
            if (wishes.length === 0) {
                wishes = defaultWishes;
                localStorage.setItem('studyWishes', JSON.stringify(wishes));
            }
        }
        
        // 设置事件监听器
        function setupHonorEventListeners() {
            // 打开荣誉勋章墙
            honorWallCard.addEventListener('click', function() {
                openHonorModal();
            });
            
            // 返回按钮
            honorBackBtn.addEventListener('click', function() {
                honorModal.style.display = 'none';
            });
                    
            // 清空勋章按钮
            clearHonorBtn.addEventListener('click', function() {
                if (confirm('确定要清空所有勋章吗？此操作不可撤销！')) {
                    clearAllHonors();
                }
            });
                       
            // 添加勋章表单提交
            addHonorForm.addEventListener('submit', function(e) {
                e.preventDefault();
                saveHonor();
            });
                      
            // 清空兑换清单按钮
            clearWishBtn.addEventListener('click', function() {
                if (confirm('确定要清空所有兑换清单吗？此操作不可撤销！')) {
                    clearAllWishes();
                }
            });
            
            // 添加兑换清单表单提交
            addWishForm.addEventListener('submit', function(e) {
                e.preventDefault();
                saveWish();
            });
            
            // 兑换类别筛选
            wishCategoryBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const category = this.getAttribute('data-category');
                    filterWishes(category);
                    
                    // 更新激活状态
                    wishCategoryBtns.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                });
            });
          
            // 编辑兑换清单表单提交
            document.getElementById('edit-wish-form').addEventListener('submit', function(e) {
                e.preventDefault();
                saveEditedWish();
            }); 
        }
        
        // 打开荣誉勋章墙模态框
        function openHonorModal() {
            // 更新荣誉和星星数据
            updateHonorsAndStars();
            
            // 渲染所有勋章
            renderAllHonors();
            
            // 渲染兑换清单
            renderWishes('all');
            
            // 显示模态框
            honorModal.style.display = 'block';
        }

        // 显示勋章解锁弹窗
        function showHonorUnlockModal(honor, starReward) {
            // 设置弹窗内容
            honorUnlockIcon.innerHTML = `<i class="${honor.icon}" style="color: ${honor.color}"></i>`;
            honorUnlockTitle.textContent = honor.name;
            honorUnlockDescription.textContent = honor.description;
            honorUnlockStarCount.textContent = starReward;

            // 播放庆祝音效
            playCelebrationSound();

            // 显示弹窗
            ModalManager.open('honor-unlock-modal');
        }
    
        // 更新荣誉和星星数据
        function updateHonorsAndStars() {
            // 计算连续打卡天数
            const streakDays = calculateStreakDays();
            
            // 计算累计完成计划数
            const totalCompletedPlans = plans.filter(p => p.completed).length;
            
            // 计算分类完成时间
            const categoryHours = calculateCategoryHours();
            
            // 计算时间管理准确率
            const timeAccuracy = calculateTimeAccuracy();
            
            // 计算总学习时间
            const totalStudyHours = calculateTotalStudyHours();
            
            // 计算提前完成次数
            const earlyCompletionCount = calculateEarlyCompletionCount();
            
            // 更新勋章状态
            let newlyUnlockedHonors = [];
            
            honors.forEach(honor => {
                let progress = 0;
                let unlocked = false;
                
                switch (honor.condition) {
                    case 'streak':
                        progress = streakDays;
                        unlocked = streakDays >= honor.value;
                        break;
                    case 'total_plans':
                        progress = totalCompletedPlans;
                        unlocked = totalCompletedPlans >= honor.value;
                        break;
                    case 'category_hours':
                        if (honor.category === 'sports') {
                            progress = categoryHours.sports;
                            unlocked = categoryHours.sports >= honor.value;
                        } else if (honor.category === 'skill') {
                            progress = categoryHours.skill;
                            unlocked = categoryHours.skill >= honor.value;
                        }
                        break;
                    case 'time_accuracy':
                            const timeAchievements = calculateTimeManagementAchievements();
                           if (honor.id === 13) { // 时间规划者
                               progress = timeAchievements.planner.count;
                               unlocked = timeAchievements.planner.count >= honor.value;
                           } else if (honor.id === 14) { // 时间管理者
                               progress = timeAchievements.manager.count;
                               unlocked = timeAchievements.manager.count >= honor.value;
                           } else if (honor.id === 15) { // 时间管理大师
                               progress = timeAchievements.master.count;
                               unlocked = timeAchievements.master.count >= honor.value;
                           }
                           break;
                    case 'total_study_hours':
                        progress = totalStudyHours;
                        unlocked = totalStudyHours >= honor.value;
                        break;
                    case 'early_completion':
                        progress = earlyCompletionCount;
                        unlocked = earlyCompletionCount >= honor.value;
                        break;
                }
                
                // 检查是否是新解锁的勋章
                if (!honor.unlocked && unlocked) {
                    newlyUnlockedHonors.push(honor);
                }
                
                honor.progress = progress;
                honor.unlocked = unlocked;
            });
            
            // 保存更新后的勋章数据
            localStorage.setItem('studyHonors', JSON.stringify(honors));
            
            // 计算星星数量
            calculateStars(newlyUnlockedHonors);
            
            // 更新可用星星显示
            availableStarsElement.textContent = availableStars;
        }
    
        // 计算连续打卡天数
        function calculateStreakDays() {
             const sortedDates = checkins.map(c => c.date).sort();
             let currentStreak = 0;
    
             const today = new Date();
             today.setHours(0, 0, 0, 0);
             const todayStr = formatDateForDisplay(today);
            
            if (sortedDates.includes(todayStr)) {
                currentStreak = 1;
                let currentDate = new Date(today);
                
                for (let i = 1; i <= 365; i++) {
                    currentDate.setDate(currentDate.getDate() - 1);
                    const prevDate = formatDateForDisplay(currentDate);
                    
                    if (sortedDates.includes(prevDate)) {
                        currentStreak++;
                    } else {
                        break;
                    }
                }
            }
            
            return currentStreak;
        }
        
        // 计算分类完成时间
        function calculateCategoryHours() {
            const categoryHours = {
                sports: 0,
                skill: 0
            };
            
            plans.forEach(plan => {
                if (plan.completed && plan.totalDuration) {
                    const durationHours = plan.totalDuration / (1000 * 60 * 60);
                    
                    if (plan.subject === 'sports') {
                        categoryHours.sports += durationHours;
                    } else if (plan.subject === 'skill') {
                        categoryHours.skill += durationHours;
                    }
                }
            });
            
            return categoryHours;
        }
        
        // 计算时间管理准确率
        function calculateTimeAccuracy() {
            let totalPlans = 0;
            let totalAccuracy = 0;
            
            plans.forEach(plan => {
                if (plan.completed && plan.totalDuration && plan.plannedDuration) {
                    const plannedMinutes = parseDurationToMinutes(plan.plannedDuration); 
                    const actualMinutes = plan.totalDuration / (1000 * 60);
                    
                    if (plannedMinutes > 0) {
                        const accuracy = Math.abs(actualMinutes - plannedMinutes) / plannedMinutes * 100;
                        totalAccuracy += accuracy;
                        totalPlans++;
                    }
                }
            });
            
            return totalPlans > 0 ? Math.round(totalAccuracy / totalPlans) : 100;
        }
        // 计算时间管理成就（基于当日计划数量）
function calculateTimeManagementAchievements() {
    const achievements = {
        planner: { count: 0, required: 2 }, // 时间规划者：≥2个计划误差在30%以内
        manager: { count: 0, required: 3 }, // 时间管理者：≥3个计划误差在20%以内
        master: { count: 0, required: 5 }   // 时间管理大师：≥5个计划误差在10%以内
    };

    // 获取所有已完成且有计划和实际用时的计划
    const validPlans = plans.filter(plan => 
        plan.completed && plan.totalDuration && plan.plannedDuration
    );

    validPlans.forEach(plan => {
        const plannedMinutes = parseDurationToMinutes(plan.plannedDuration);
        const actualMinutes = plan.totalDuration / (1000 * 60);
        
        if (plannedMinutes > 0) {
            const accuracy = Math.abs(actualMinutes - plannedMinutes) / plannedMinutes * 100;
            
            // 统计不同精度范围内的计划数量
            if (accuracy <= 30) {
                achievements.planner.count++;
            }
            if (accuracy <= 20) {
                achievements.manager.count++;
            }
            if (accuracy <= 10) {
                achievements.master.count++;
            }
        }
    });

    return achievements;
}

        // 计算总学习时间
        function calculateTotalStudyHours() {
            let totalHours = 0;
            
            plans.forEach(plan => {
                if (plan.completed && plan.totalDuration) {
                    totalHours += plan.totalDuration / (1000 * 60 * 60);
                }
            });
            
            return Math.round(totalHours);
        }
        
        // 计算提前完成次数
        function calculateEarlyCompletionCount() {
            let earlyCompletionCount = 0;
            
            plans.forEach(plan => {
                if (plan.completed && plan.totalDuration && plan.plannedDuration) {
                    const plannedMinutes = parseDurationToMinutes(plan.plannedDuration);
                    const actualMinutes = plan.totalDuration / (1000 * 60);
                    
                    if (actualMinutes < plannedMinutes) {
                        earlyCompletionCount++;
                    }
                }
            });
            
            return earlyCompletionCount;
        }
        
        // 计算星星数量
       function calculateStars(newlyUnlockedHonors) {
    const completedPlans = plans.filter(p => p.completed).length;
    let starsFromPlans = completedPlans * 2;
    let starsFromHonors = 0;

    newlyUnlockedHonors.forEach(honor => {
        let starReward = 0;
        
        // 根据勋章难度给予不同数量的星星
        if (honor.value <= 10) {
            starReward = 30; // 初级勋章
        } else if (honor.value <= 50) {
            starReward = 50; // 中级勋章
        } else if (honor.value <= 100) {
            starReward = 80; // 高级勋章
        } else {
            starReward = 100; // 高级以上勋章
        }
        
        starsFromHonors += starReward;
        
        // 显示解锁弹窗（只显示第一个解锁的勋章）
        if (newlyUnlockedHonors.indexOf(honor) === 0) {
            setTimeout(() => {
                showHonorUnlockModal(honor, starReward);
            }, 500);
        }
    });

    availableStars = starsFromPlans + starsFromHonors;
    localStorage.setItem('availableStars', availableStars.toString());
}
        
        // 渲染所有勋章
        function renderAllHonors() {
            renderHonorSection('streak-honor-grid', honors.filter(h => h.condition === 'streak'));
            renderHonorSection('total-honor-grid', honors.filter(h => h.condition === 'total_plans'));
            renderHonorSection('category-honor-grid', honors.filter(h => h.condition === 'category_hours'));
            renderHonorSection('time-management-honor-grid', honors.filter(h => h.condition === 'time_accuracy'));
            renderHonorSection('total-study-honor-grid', honors.filter(h => h.condition === 'total_study_hours'));
            renderHonorSection('early-completion-honor-grid', honors.filter(h => h.condition === 'early_completion'));
        }
        
        // 渲染勋章部分
       function renderHonorSection(sectionId, sectionHonors) {
            const sectionGrid = document.getElementById(sectionId);
            sectionGrid.innerHTML = '';
            
            sectionHonors.forEach(honor => {
                const honorCard = document.createElement('div');
                honorCard.className = `honor-card ${honor.unlocked ? '' : 'locked'}`;
                
                // 只有非默认勋章才显示删除按钮
                const deleteButton = !honor.isDefault ? `
                    <div class="honor-actions">
                        <button class="honor-action-btn honor-delete-btn" data-id="${honor.id}">
                            <i class="fas fa-trash"></i> 删除
                        </button>
                    </div>
                ` : '';
                
                honorCard.innerHTML = `
                    <div class="honor-icon" style="color: ${honor.color}">
                        <i class="${honor.icon}"></i>
                    </div>
                    <div class="honor-name">${honor.name}</div>
                    <div class="honor-description">${honor.description}</div>
                    <div class="honor-progress">进度: ${honor.progress}/${honor.value}</div>
                    ${honor.unlocked ? '<div class="honor-badge"><i class="fas fa-check"></i></div>' : ''}
                    ${deleteButton}
                `;
                
                sectionGrid.appendChild(honorCard);
                
                // 为删除按钮添加事件监听器
                if (!honor.isDefault) {
                    const deleteBtn = honorCard.querySelector('.honor-delete-btn');
                    deleteBtn.addEventListener('click', function() {
                        const honorId = this.getAttribute('data-id');
                        deleteHonor(honorId);
                    });
                }
            });
        }
        
        // 渲染兑换清单
        function renderWishes(category) {
    const wishGrid = document.getElementById('wish-grid');
    wishGrid.innerHTML = '';
    
    let filteredWishes = wishes;
    
    if (category !== 'all') {
        filteredWishes = wishes.filter(wish => wish.category === category);
    }
    
    filteredWishes.forEach(wish => {
        const wishItem = document.createElement('div');
        wishItem.className = `wish-item ${wish.redeemed ? 'disabled' : ''}`;
        wishItem.setAttribute('data-category', wish.category);

        const categoryNames = {
            'entertainment': '娱乐活动',
            'food': '美食饮品',
            'shopping': '购物奖励',
            'experience': '体验活动'
        };
        
        // 确保 redeemedCount 有值，如果没有则设为 0
        const redeemedCount = wish.redeemedCount || 0;
        
        wishItem.innerHTML = `
    <div class="wish-item-header">
        <div class="wish-item-header-left">
            <div class="wish-item-category">${categoryNames[wish.category]}</div>
            ${redeemedCount > 0 ? `<div class="wish-item-status">已兑换</div>` : ''}
        </div>
        <button class="wish-edit-btn" data-id="${wish.id}">
            <i class="fas fa-edit"></i> 编辑
        </button>
    </div>
    <div class="wish-item-name">${wish.content}</div>
    <div class="wish-item-description">数量: ${wish.quantity}</div>
    <div class="wish-item-description">已兑换次数: ${redeemedCount}</div>
    <div class="wish-item-footer">
        <div class="wish-item-cost">
            <i class="fas fa-star"></i>
            <span>${wish.cost}</span>
        </div>
        <button class="wish-item-btn" ${availableStars < wish.cost ? 'disabled' : ''}>
            兑换
        </button>
    </div>
`; 
      
        // 添加兑换事件监听器
        const redeemBtn = wishItem.querySelector('.wish-item-btn');
        if (availableStars >= wish.cost) {
            redeemBtn.addEventListener('click', function() {
                redeemWish(wish.id);
            });
        }
        
        // 添加编辑事件监听器
        const editBtn = wishItem.querySelector('.wish-edit-btn');
        editBtn.addEventListener('click', function() {
            const wishId = this.getAttribute('data-id');
            editWish(wishId);
        });
        
        wishGrid.appendChild(wishItem);
    });
}
        
        // 筛选兑换清单
        function filterWishes(category) {
            renderWishes(category);
        }
        
        // 兑换奖励
       function redeemWish(wishId) {
    const wish = wishes.find(w => w.id === wishId);
    
    if (wish && availableStars >= wish.cost) {
        if (confirm(`确定要兑换 ${wish.content} 吗？这将花费 ${wish.cost} 颗星星。`)) {
            // 增加兑换次数
            wish.redeemedCount = (wish.redeemedCount || 0) + 1;
            
            // 扣除星星
            availableStars -= wish.cost;
            
            // 更新本地存储
            localStorage.setItem('studyWishes', JSON.stringify(wishes));
            localStorage.setItem('availableStars', availableStars.toString());
            
            // 更新UI
            availableStarsElement.textContent = availableStars;
            renderWishes(document.querySelector('.wish-category-btn.active').getAttribute('data-category'));
            
            alert(`成功兑换 ${wish.content}！当前已兑换 ${wish.redeemedCount} 次`);
        }
    } else {
        alert('星星不足，无法兑换！');
    }
}
        
        // 保存勋章
        function saveHonor() {
            const name = document.getElementById('honor-name').value;
            const description = document.getElementById('honor-description').value;
            const icon = document.getElementById('honor-icon').value;
            const color = document.getElementById('honor-color').value;
            const condition = document.getElementById('honor-condition').value;
            const value = parseInt(document.getElementById('honor-value').value);
            
            const newHonor = {
                id: Date.now(),
                name,
                description,
                icon,
                color,
                condition,
                value,
                unlocked: false,
                progress: 0
            };
            
            honors.push(newHonor);
            localStorage.setItem('studyHonors', JSON.stringify(honors));
            
            // 关闭模态框并重置表单
            ModalManager.close('add-honor-modal');
            addHonorForm.reset();
            
            // 重新渲染勋章
            renderAllHonors();
            
            alert('勋章添加成功！');
        }
        
        // 保存兑换项
       function saveWish() {
    const category = document.getElementById('wish-category').value;
    const content = document.getElementById('wish-content').value;
    const quantity = parseInt(document.getElementById('wish-quantity').value);
    const cost = parseInt(document.getElementById('wish-cost').value);
    
    const newWish = {
        id: Date.now(),
        category,
        content,
        quantity,
        cost,
        redeemedCount: 0  // 新增字段，初始为0
    };
    
    wishes.push(newWish);
    localStorage.setItem('studyWishes', JSON.stringify(wishes));
    
    // 关闭模态框并重置表单
    ModalManager.close('add-wish-modal');
    addWishForm.reset();
    
    // 重新渲染兑换清单
    renderWishes(document.querySelector('.wish-category-btn.active').getAttribute('data-category'));
    
    alert('兑换项添加成功！');
}
        
        // 清空所有勋章
        function clearAllHonors() {
            honors = [];
            localStorage.setItem('studyHonors', JSON.stringify(honors));
            
            // 重新渲染勋章
            renderAllHonors();
            
            alert('所有勋章已清空！');
        }
        
        // 清空所有兑换清单
        function clearAllWishes() {
            wishes = [];
            localStorage.setItem('studyWishes', JSON.stringify(wishes));
            
            // 重新渲染兑换清单
            renderWishes(document.querySelector('.wish-category-btn.active').getAttribute('data-category'));
            
            alert('所有兑换清单已清空！');
        }

  // 删除勋章函数
        function deleteHonor(honorId) {
            if (confirm('确定要删除这个勋章吗？此操作不可撤销！')) {
                const honorIndex = honors.findIndex(h => h.id == honorId);
                if (honorIndex !== -1) {
                    honors.splice(honorIndex, 1);
                    localStorage.setItem('studyHonors', JSON.stringify(honors));
                    
                    // 重新渲染所有勋章
                    renderAllHonors();
                    
                    alert('勋章删除成功！');
                }
            }
        }

        // 编辑兑换项函数
       function editWish(wishId) {
    const wish = wishes.find(w => w.id == wishId);
    if (wish) {
        currentEditingWishId = wishId;
        
        // 填充表单数据
        document.getElementById('edit-wish-id').value = wish.id;
        document.getElementById('edit-wish-category').value = wish.category;
        document.getElementById('edit-wish-content').value = wish.content;
        document.getElementById('edit-wish-quantity').value = wish.quantity;
        document.getElementById('edit-wish-cost').value = wish.cost;
        
        // 显示编辑模态框
        ModalManager.open('edit-wish-modal');
    }
}

// 保存编辑后的兑换项
function saveEditedWish() {
    const wishId = document.getElementById('edit-wish-id').value;
    const category = document.getElementById('edit-wish-category').value;
    const content = document.getElementById('edit-wish-content').value;
    const quantity = parseInt(document.getElementById('edit-wish-quantity').value);
    const cost = parseInt(document.getElementById('edit-wish-cost').value);
    
    const wishIndex = wishes.findIndex(w => w.id == wishId);
    if (wishIndex !== -1) {
        wishes[wishIndex].category = category;
        wishes[wishIndex].content = content;
        wishes[wishIndex].quantity = quantity;
        wishes[wishIndex].cost = cost;
        // 注意：保留原有的 redeemedCount 值
        
        localStorage.setItem('studyWishes', JSON.stringify(wishes));
        
        // 关闭编辑模态框
        ModalManager.close('edit-wish-modal');
        
        // 重新渲染兑换清单
        renderWishes(document.querySelector('.wish-category-btn.active').getAttribute('data-category'));
        
        alert('兑换项修改成功！');
    }
}

// 重要任务提醒功能
function openImportantTasksModal() {
    renderImportantTasks();
    ModalManager.open('important-tasks-modal');
}

// 渲染重要任务列表
function renderImportantTasks() {
    const container = document.getElementById('important-tasks-list');
    container.innerHTML = '';

    if (importantTasks.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 20px; color: #999;">
                <i class="fas fa-tasks" style="font-size: 24px; margin-bottom: 10px;"></i>
                <p>暂无重要任务</p>
            </div>
        `;
        return;
    }

    importantTasks.forEach((task, index) => {
        const taskElement = document.createElement('div');
        taskElement.className = 'important-task-item';
        
        taskElement.innerHTML = `
            <div class="important-task-content ${task.completed ? 'important-task-completed' : 'editable'}" 
                 contenteditable="true" 
                 data-index="${index}">${task.content}</div>
            <div class="important-task-actions">
                <button class="important-task-btn complete-btn ${task.completed ? 'completed' : ''}" 
                        data-index="${index}">
                    <i class="fas ${task.completed ? 'fa-check' : 'fa-times'}"></i>
                </button>
                <button class="important-task-btn delete-btn" data-index="${index}">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `;
        
        container.appendChild(taskElement);
    });

    // 添加任务内容编辑事件
    container.querySelectorAll('.important-task-content').forEach(content => {
        content.addEventListener('blur', function() {
            const index = parseInt(this.getAttribute('data-index'));
            const newContent = this.textContent.trim();
            
            if (newContent && newContent !== importantTasks[index].content) {
                importantTasks[index].content = newContent;
                localStorage.setItem('importantTasks', JSON.stringify(importantTasks));
                showNotification('任务内容已更新');
            }
        });
        
        // 按回车保存
        content.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                this.blur();
            }
        });
    });

    // 添加完成/取消完成事件
    container.querySelectorAll('.complete-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const index = parseInt(this.getAttribute('data-index'));
            toggleTaskCompletion(index);
        });
    });

    // 添加删除事件
    container.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const index = parseInt(this.getAttribute('data-index'));
            deleteImportantTask(index);
        });
    });
}

// 批量添加重要任务
function addImportantTask() {
    const input = document.getElementById('new-important-task');
    const content = input.value.trim();
    
    if (!content) {
        alert('请输入重要任务内容！');
        return;
    }
    
    // 按行分割任务
    const tasks = content.split('\n')
        .map(line => line.trim())
        .filter(line => line.length > 0);
    
    if (tasks.length === 0) {
        alert('请输入有效的任务内容！');
        return;
    }
    
    tasks.forEach(taskContent => {
        importantTasks.push({
            id: Date.now() + Math.random(),
            content: taskContent,
            completed: false,
            createdAt: new Date().toISOString()
        });
    });
    
    localStorage.setItem('importantTasks', JSON.stringify(importantTasks));
    input.value = '';
    renderImportantTasks();
    showNotification(`成功添加 ${tasks.length} 个重要任务`);
}

// 切换任务完成状态
function toggleTaskCompletion(index) {
    if (index >= 0 && index < importantTasks.length) {
        importantTasks[index].completed = !importantTasks[index].completed;
        localStorage.setItem('importantTasks', JSON.stringify(importantTasks));
        renderImportantTasks();
        
        const task = importantTasks[index];
        const action = task.completed ? '完成' : '取消完成';
        showNotification(`任务已${action}`);
    }
}

// 删除重要任务
function deleteImportantTask(index) {
    if (index >= 0 && index < importantTasks.length) {
        const taskContent = importantTasks[index].content;
        importantTasks.splice(index, 1);
        localStorage.setItem('importantTasks', JSON.stringify(importantTasks));
        renderImportantTasks();
        showNotification(`任务"${taskContent}"已删除`);
    }
}

// 改进的导入数据功能
function importDataFromText() {
    const importDataText = document.getElementById('data-import').value;
    
    if (!importDataText.trim()) {
        alert('请输入备份数据！');
        return;
    }
    
    try {
        const importedData = JSON.parse(importDataText);
        
        // 添加确认提示 - 说明是按日期覆盖
        const importedPlanCount = importedData.plans ? importedData.plans.length : 0;
        const importedDates = importedData.plans ? 
            new Set(importedData.plans.map(p => formatDateForDisplay(new Date(p.createdAt)))) : 
            new Set();
        
        // 计算会覆盖的日期
        const existingDates = new Set(plans.map(p => formatDateForDisplay(new Date(p.createdAt))));
        const overwrittenDates = [...importedDates].filter(date => existingDates.has(date));
        
        if (!confirm(`即将导入数据：\n- ${importedPlanCount} 个学习计划\n- ${importedDates.size} 天的数据\n- 将覆盖 ${overwrittenDates.length} 天的现有数据\n- 其他日期的数据保持不变\n\n确定要继续吗？`)) {
            return;
        }
        
        processImportedData(importedData);
    } catch (e) {
        alert('备份数据格式不正确！');
    }
}

function importDataFromFile() {
    const fileInput = document.getElementById('data-file-import');
    const file = fileInput.files[0];

    if (!file) {
        alert('请选择备份文件！');
        return;
    }

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const importedData = JSON.parse(e.target.result);
            
            // 添加确认提示 - 说明是按日期覆盖
            const importedPlanCount = importedData.plans ? importedData.plans.length : 0;
            const importedDates = importedData.plans ? 
                new Set(importedData.plans.map(p => formatDateForDisplay(new Date(p.createdAt)))) : 
                new Set();
            
            // 计算会覆盖的日期
            const existingDates = new Set(plans.map(p => formatDateForDisplay(new Date(p.createdAt))));
            const overwrittenDates = [...importedDates].filter(date => existingDates.has(date));
            
            if (!confirm(`即将导入数据：\n- ${importedPlanCount} 个学习计划\n- ${importedDates.size} 天的数据\n- 将覆盖 ${overwrittenDates.length} 天的现有数据\n- 其他日期的数据保持不变\n\n确定要继续吗？`)) {
                return;
            }
            
            processImportedData(importedData);
        } catch (e) {
            alert('备份文件格式不正确！');
        }
    };
    reader.readAsText(file);
}

// 处理导入数据 - 按日期覆盖模式
function processImportedData(importedData) {
    if (importedData.plans && Array.isArray(importedData.plans)) {
        // 按日期覆盖计划数据
        const existingPlans = plans;
        const importedPlans = importedData.plans;
        
        // 获取导入数据中所有的日期
        const importedDates = new Set();
        importedPlans.forEach(plan => {
            const planDate = formatDateForDisplay(new Date(plan.createdAt));
            importedDates.add(planDate);
        });
        
        // 过滤出现有数据中不在导入日期范围内的计划（保留这些计划）
        const filteredExistingPlans = existingPlans.filter(plan => {
            const planDate = formatDateForDisplay(new Date(plan.createdAt));
            return !importedDates.has(planDate);
        });
        
        // 处理导入的计划，重新分配ID以避免冲突
        let maxId = existingPlans.length > 0 ? Math.max(...existingPlans.map(p => p.id)) : 0;
        const existingIds = new Set(existingPlans.map(p => p.id));
        
        importedPlans.forEach(plan => {
            // 重新分配ID以避免冲突
            if (existingIds.has(plan.id)) {
                maxId++;
                plan.id = maxId;
                existingIds.add(plan.id);
            }
        });
        
        // 合并数据：保留不在导入日期范围内的现有计划 + 所有导入的计划
        plans = [...filteredExistingPlans, ...importedPlans];
        localStorage.setItem('studyPlans', JSON.stringify(plans));
        
        // 按日期覆盖打卡数据
        if (importedData.checkins && Array.isArray(importedData.checkins)) {
            const existingCheckins = checkins;
            const importedCheckins = importedData.checkins;
            
            // 获取导入的打卡日期
            const importedCheckinDates = new Set(importedCheckins.map(c => c.date));
            
            // 过滤出现有打卡数据中不在导入日期范围内的记录
            const filteredExistingCheckins = existingCheckins.filter(checkin => {
                return !importedCheckinDates.has(checkin.date);
            });
            
            // 合并打卡数据
            checkins = [...filteredExistingCheckins, ...importedCheckins];
            localStorage.setItem('studyCheckins', JSON.stringify(checkins));
        }
        
        // 重要任务数据 - 按ID覆盖（保留最新数据）
        if (importedData.importantTasks && Array.isArray(importedData.importantTasks)) {
            const existingTasks = importantTasks;
            const importedTasks = importedData.importantTasks;
            
            const taskMap = new Map();
            
            // 先添加现有任务
            existingTasks.forEach(task => {
                taskMap.set(task.id, task);
            });
            
            // 用导入的任务覆盖相同ID的任务
            importedTasks.forEach(task => {
                taskMap.set(task.id, task);
            });
            
            importantTasks = Array.from(taskMap.values());
            localStorage.setItem('importantTasks', JSON.stringify(importantTasks));
        }
        
        // 勋章数据 - 按ID覆盖（保留最新数据）
        if (importedData.honors && Array.isArray(importedData.honors)) {
            const existingHonors = honors;
            const importedHonors = importedData.honors;
            
            const honorMap = new Map();
            
            existingHonors.forEach(honor => {
                honorMap.set(honor.id, honor);
            });
            
            importedHonors.forEach(honor => {
                honorMap.set(honor.id, honor);
            });
            
            honors = Array.from(honorMap.values());
            localStorage.setItem('studyHonors', JSON.stringify(honors));
        }
        
        // 兑换清单数据 - 按ID覆盖（保留最新数据）
        if (importedData.wishes && Array.isArray(importedData.wishes)) {
            const existingWishes = wishes;
            const importedWishes = importedData.wishes;
            
            const wishMap = new Map();
            
            existingWishes.forEach(wish => {
                wishMap.set(wish.id, wish);
            });
            
            importedWishes.forEach(wish => {
                wishMap.set(wish.id, wish);
            });
            
            wishes = Array.from(wishMap.values());
            localStorage.setItem('studyWishes', JSON.stringify(wishes));
        }
        
        // 星星数量 - 使用导入的数据覆盖
        if (importedData.availableStars !== undefined) {
            availableStars = importedData.availableStars;
            localStorage.setItem('availableStars', availableStars.toString());
        }
        
        // 重新渲染所有组件
        renderPlans();
        renderCalendar();
        updateStats();
        updateHonorsAndStars();
        
        importModal.style.display = 'none';
        
        // 显示导入统计信息
        const importedPlanCount = importedData.plans ? importedData.plans.length : 0;
        const importedCheckinCount = importedData.checkins ? importedData.checkins.length : 0;
        const importedTaskCount = importedData.importantTasks ? importedData.importantTasks.length : 0;
        const importedDatesCount = importedDates.size;
        
        // 计算被覆盖的日期数量
        const existingDates = new Set(existingPlans.map(p => formatDateForDisplay(new Date(p.createdAt))));
        const overwrittenDates = [...importedDates].filter(date => existingDates.has(date));
        
        showNotification(
            `数据导入成功！\n` +
            `导入计划: ${importedPlanCount} 个\n` +
            `覆盖日期: ${overwrittenDates.length} 天\n` +
            `新增日期: ${importedDatesCount - overwrittenDates.length} 天\n` +
            `导入打卡: ${importedCheckinCount} 条\n` +
            `导入任务: ${importedTaskCount} 个\n` +
            `星星数量: ${importedData.availableStars || 0} 颗`
        );
    } else {
        alert('备份数据格式不正确！');
    }
}
    </script>
</body>
</html>